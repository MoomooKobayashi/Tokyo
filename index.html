<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Êù±‰∫¨‰∏ÉÊó•Ë°å 2026</title>
    
    <!-- PWA / Home Screen Settings -->
    <meta name="theme-color" content="#fcfaf7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tokyo Trip">
    
    <!-- Icon Settings (Added version params to force cache refresh) -->
    <link rel="apple-touch-icon" href="skytree.jpg?v=2">
    <link rel="icon" type="image/jpeg" href="skytree.jpg?v=2">
    <!-- Link to external manifest.json for reliable Android support -->
    <link rel="manifest" href="manifest.json?v=2">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rice: '#fcfaf7',
                        charcoal: '#3e3a39',
                        matcha: '#6a7f60',
                        'matcha-light': '#8da583',
                        subtle: '#eceae6'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'Noto Sans JP', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            'from': { transform: 'translateY(100%)' },
                            'to': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #fcfaf7;
            color: #3e3a39;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            user-select: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
    
    <!-- Import Map for Firebase (ES Modules) -->
    <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "sweetalert2": "https://aistudiocdn.com/sweetalert2@^11.26.3"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- 1. Firebase Logic (Module) -->
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, onValue, set } from "firebase/database";

        // --- FIREBASE CONFIG (Ë´ãÂ°´ÂÖ•ÊÇ®ÁöÑË®≠ÂÆö) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCMuSoz3MhH4Pxtg9hcWV2aIoXk3Rw2Pbs",
            authDomain: "tokyotrip2026-d2ddc.firebaseapp.com",
            databaseURL: "https://tokyotrip2026-d2ddc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tokyotrip2026-d2ddc",
            storageBucket: "tokyotrip2026-d2ddc.firebasestorage.app",
            messagingSenderId: "144324842672",
            appId: "1:144324842672:web:b82a365e306d1593c51775"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Expose to window for React
        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
    </script>

    <!-- 2. React Application (Babel) -->
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const DATA_VERSION = 2; 

        const MEMBERS = [
            { id: 'm1', name: 'Á∂≠Â∞º', icon: 'üêª' },
            { id: 'm2', name: 'ËÄÅÈº†', icon: 'üê≠' },
            { id: 'm3', name: 'ÈáéË±¨', icon: 'üêó' },
            { id: 'm4', name: 'ÂìÜÂï¶', icon: 'üê±' },
        ];

        const LOCATIONS = {
            tokyo: { lat: 35.6895, lon: 139.6917, name: 'Êù±‰∫¨' },
            yokohama: { lat: 35.4437, lon: 139.6380, name: 'Ê©´Êø±' },
            kamakura: { lat: 35.3192, lon: 139.5467, name: 'ÈéåÂÄâ' },
            kawagoe: { lat: 35.9251, lon: 139.4858, name: 'Â∑ùË∂ä' },
            nikko: { lat: 36.7199, lon: 139.6982, name: 'Êó•ÂÖâ' }
        };

        const PHRASES = [
            { jp: "„Åô„Åø„Åæ„Åõ„Çì", ro: "Sumimasen", zh: "‰∏çÂ•ΩÊÑèÊÄù/ÂÄüÈÅé" },
            { jp: "„ÅÇ„Çä„Åå„Å®„ÅÜ", ro: "Arigatou", zh: "Ë¨ùË¨ù" },
            { jp: "„Åì„Çå„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", ro: "Kore wo onegaishimasu", zh: "ÊàëË¶ÅÈÄôÂÄã" },
            { jp: "„Åä‰ºöË®à„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", ro: "Okaikei wo onegaishimasu", zh: "È∫ªÁÖ©ÁµêÂ∏≥" },
            { jp: "„Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„Åã", ro: "Toire wa doko desu ka", zh: "ÂªÅÊâÄÂú®Âì™Ë£°" },
            { jp: "ÂÜôÁúü„ÇíÊíÆ„Å£„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„Åã", ro: "Shashin wo totte mo ii desu ka", zh: "ÂèØ‰ª•ÊãçÁÖßÂóé" },
        ];

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const INITIAL_PACKING_LIST = [
            { id: generateId(), category: 'Ë≠â‰ª∂/Èå¢ÂåÖ', text: 'Ë≠∑ÁÖß (ÊïàÊúü6ÂÄãÊúà‰ª•‰∏ä)', checked: false },
            { id: generateId(), category: 'Ë≠â‰ª∂/Èå¢ÂåÖ', text: 'Êó•Âπ£ÁèæÈáë', checked: false },
            { id: generateId(), category: 'Ë≠â‰ª∂/Èå¢ÂåÖ', text: '‰ø°Áî®Âç° (Êµ∑Â§ñÂõûÈ•ãÈ´ò)', checked: false },
            { id: generateId(), category: 'Ë≠â‰ª∂/Èå¢ÂåÖ', text: 'Visit Japan Web QR Code Êà™Âúñ', checked: false },
            { id: generateId(), category: 'ÈõªÂ≠êÁî¢ÂìÅ', text: 'ÊâãÊ©ü & ÂÖÖÈõªÁ∑ö', checked: false },
            { id: generateId(), category: 'ÈõªÂ≠êÁî¢ÂìÅ', text: 'Ë°åÂãïÈõªÊ∫ê', checked: false },
            { id: generateId(), category: 'ÈõªÂ≠êÁî¢ÂìÅ', text: 'Á∂≤Âç°/Êº´ÈÅäÈñãÈÄö', checked: false },
            { id: generateId(), category: 'Ë°£Áâ©', text: '‰øùÊöñÂ§ñÂ•ó (1-2ÊúàÂùáÊ∫´5Â∫¶)', checked: false },
            { id: generateId(), category: 'Ë°£Áâ©', text: 'Â•ΩËµ∞ÁöÑÈûã', checked: false },
            { id: generateId(), category: 'ÁîüÊ¥ªÁî®ÂìÅ', text: 'Â∏∏ÂÇôËó•ÂìÅ (ÊÑüÂÜí/ËÉÉËó•/OKÁπÉ)', checked: false },
            { id: generateId(), category: 'ÁîüÊ¥ªÁî®ÂìÅ', text: 'ÊäòÁñäÂÇò', checked: false },
        ];

        const DEFAULT_DATA = {
            version: DATA_VERSION,
            currencyRate: 0.215,
            members: ["Êàë", "ÊóÖ‰º¥A", "ÊóÖ‰º¥B"],
            expenses: [],
            packingList: INITIAL_PACKING_LIST,
            reservations: [
                { id: generateId(), type: 'flight', name: 'ÂéªÁ®ã BR198', status: 'booked', dateTime: '1/28 08:50', refNumber: '6F3X9A', notes: 'Ê°ÉÂúí T2 -> ÊàêÁî∞ T1', url: '' },
                { id: generateId(), type: 'flight', name: 'ÂõûÁ®ã BR197', status: 'booked', dateTime: '2/3 13:00', refNumber: '6F3X9A', notes: 'ÊàêÁî∞ T1 -> Ê°ÉÂúí T2', url: '' },
                { id: generateId(), type: 'hotel', name: 'Dormy Inn Kawasaki', status: 'booked', dateTime: '1/28 - 1/30', notes: 'Á•ûÂ•àÂ∑ùÁúåÂ∑ùÂ¥éÂ∏ÇÂ∑ùÂ¥éÂå∫Êù±Áî∞Áî∫9-3 (+81-44-230-5489)', url: 'https://www.google.com/maps/search/?api=1&query=Dormy+Inn+Kawasaki' },
                { id: generateId(), type: 'hotel', name: 'Êù±Ê©´INN Ê∑∫ËçâËóèÂâç2ËôüÂ∫ó', status: 'booked', dateTime: '1/30 - 2/3', notes: 'Êù±‰∫¨ÈÉΩÂè∞Êù±Âå∫ËîµÂâç3-15-5 (+81-3-5821-1045)', url: 'https://www.google.com/maps/search/?api=1&query=Toyoko+Inn+Asakusa+Kuramae' },
            ],
            days: [
                {
                    date: "1/28", weekday: "ÈÄ±‰∏â",
                    title: "ÊäµÈÅîËàáÊ©´Êø±Ê∏ØÂ§úÊôØ",
                    weather: "Êô¥ÊôÇÂ§öÈõ≤ 4-11¬∞C",
                    locationKey: "yokohama",
                    imageUrl: "yokohama.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "Ê©üÂ†¥Ë≤¥Ë≥ìÂÆ§/‰æøÂà©ÂïÜÂ∫ó", dish: "È£ØÁ≥∞/‰∏âÊòéÊ≤ª", priceLevel: "¬•500", url: "", locationUrl: "", note: "Âø´ÈÄüËß£Ê±∫" }],
                        lunch: [{ id: generateId(), name: "Skyliner ‰æøÁï∂", dish: "ÁÇ∏Ë±¨Êéí‰∏âÊòéÊ≤ª", priceLevel: "¬•1000", url: "", locationUrl: "", note: "Ëªä‰∏ä‰∫´Áî®" }],
                        dinner: [
                            { id: generateId(), name: "Lazona Â∑ùÂ¥éÂª£Â†¥", dish: "ÈáëÂ≠êÂçä‰πãÂä©/Âà©‰πÖÁâõËàå", priceLevel: "¬•1500~", url: "https://www.google.com/search?q=Lazona+Kawasaki+Restaurants", locationUrl: "https://maps.google.com/?q=Lazona+Kawasaki", note: "Â∑ùÂ¥éÁ´ôÁõ¥ÁµêÔºåÈÅ∏ÊìáÊ•µÂ§ö" },
                            { id: generateId(), name: "Bills Á¥ÖÁ£öÂÄâÂ∫´", dish: "RicottaÈ¨ÜÈ§Ö", priceLevel: "¬•2500", url: "https://billsjapan.com/jp/Ê®™ÊµúËµ§„É¨„É≥„Ç¨ÂÄâÂ∫´", locationUrl: "https://maps.google.com/?q=Bills+Yokohama+Red+Brick", note: "Ê∞£Ê∞õ‰Ω≥ÔºåÈúÄÈ†êÁ¥Ñ" },
                            { id: generateId(), name: "Afuri ÊãâÈ∫µ", dish: "ÊüöÂ≠êÈπΩÊãâÈ∫µ", priceLevel: "¬•1200", url: "https://afuri.com/", locationUrl: "https://maps.google.com/?q=Afuri+Yokohama+Landmark", note: "Ê©´Êø±Âú∞Ê®ôÂ°îÂ∫óÔºåÊ∏ÖÁàΩÁ≥ª" }
                        ]
                    },
                    events: [
                        { id: generateId(), time: "08:50", type: "transport", title: "Ëµ∑È£õ BR198", loc: "Ê°ÉÂúíÊ©üÂ†¥ T1", image: "airport.jpg", note: "06:30 ÈõÜÂêà", subItems: [{id: generateId(), type: 'do', text: 'È†òÂèñWifiÊ©ü', checked: false}, {id: generateId(), type: 'buy', text: 'ÂÖçÁ®ÖÂåñÂ¶ùÂìÅ', checked: false}], transitToNext: { mode: 'other', duration: '3h 30m', note: 'È£õË°åÊôÇÈñì' } },
                        { id: generateId(), time: "12:55", type: "transport", title: "ÊäµÈÅî", loc: "ÊàêÁî∞Ê©üÂ†¥ T1", image: "narita.jpg", note: "È†òÂèñ Skyliner, Suica", subItems: [{id: generateId(), type: 'buy', text: 'SuicaÂç° (ÂÑ≤ÂÄº¬•3000)', checked: false}], transitToNext: { mode: 'train', duration: '50m', note: 'Skyliner (ÊàêÁî∞->‰∫¨Êàê‰∏äÈáé)' } },
                        { id: generateId(), time: "14:00", type: "transport", title: "ÁßªÂãïÔºöÊàêÁî∞‚ÜíÂ∑ùÂ¥é", loc: "Skyliner", image: "skyliner.jpg", note: "ËΩâ JR ‰∏äÈáéÊù±‰∫¨Á∑ö", transitToNext: { mode: 'train', duration: '40m', note: 'JR ‰∏äÈáéÊù±‰∫¨Á∑ö (‰∏äÈáé->Â∑ùÂ¥é)' } },
                        { id: generateId(), time: "16:00", type: "hotel", title: "Check-in", loc: "Dormy Inn", image: "kawasaki_inn.jpg", note: "‰∫´ÂèóËøéË≥ìÂíñÂï°", subItems: [{id: generateId(), type: 'do', text: 'Á¢∫Ë™çÊ∫´Ê≥âÈñãÊîæÊôÇÈñì', checked: false}], transitToNext: { mode: 'train', duration: '20m', note: 'JR‰∫¨Êø±Êù±ÂåóÁ∑ö (Â∑ùÂ¥é->Ê´ªÊú®Áî∫)' } },
                        { id: generateId(), time: "17:30", type: "sight", title: "Á¥ÖÁ£öÂÄâÂ∫´ÂÖ¨Âúí", loc: "Ê©´Êø±", image: "yo.jpg", tags: ["ÂøÖÊãç:Â§úÊôØ"], desc: "ÂÖÖÊªøÁï∞ÂúãÊÉÖË™øÁöÑÊ≠∑Âè≤ÂÄâÂ∫´Áæ§ÔºåÈÅ©ÂêàÊï£Ê≠•ÊãçÁÖß„ÄÇ", subItems: [{id: generateId(), type: 'buy', text: 'Ê©´Êø±ÁÑ¶Á≥ñÁâõÂ•∂Á≥ñ', checked: false}, {id: generateId(), type: 'eat', text: 'Â¥éÈôΩËªíÁáíË≥£', checked: false}], transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°åËá≥ÈÅãÊ≤≥ÂÖ¨ÂúíÁ´ô' } },
                        { id: generateId(), time: "20:30", type: "sight", title: "Ê©´Êø±Á©∫‰∏≠Á∫úËªä", loc: "Ê´ªÊú®Áî∫Á´ô", image: "air_cabin.jpg", note: "ÂñÆÁ®ã 1000ÂÜÜÔºåÊ¨£Ë≥ûÊ∏ØÊú™‰æÜÂÖ®ÊôØ„ÄÇ", subItems: [{id: generateId(), type: 'do', text: 'ÈåÑ‰∏ãÂ§úÊôØÁ∏ÆÊôÇ', checked: false}], transitToNext: { mode: 'train', duration: '15m', note: 'JR‰∫¨Êø±Êù±ÂåóÁ∑öÂõûÂ∑ùÂ¥é' } },
                        { id: generateId(), time: "22:00", type: "food", title: "Â§úÈ≥¥ÊãâÈ∫µ & Ê∫´Ê≥â", loc: "Dormy Inn", image: "dormy_ramen.jpg", tags: ["Ê∫´Ê≥â","ÂÖçË≤ªÊãâÈ∫µ","ÂÖçË≤ªÂÜ∞Ê£í","‰π≥ÈÖ∏È£≤Êñô"], desc: "È£ØÂ∫óÊãõÁâåÊúçÂãôÔºåÊ≥°ÊπØÂæå‰∫´Áî®ÂÖçË≤ªÈÜ¨Ê≤πÊãâÈ∫µ„ÄÇ" }
                    ]
                },
                {
                    date: "1/29", weekday: "ÈÄ±Âõõ",
                    title: "ÊπòÂçóÊµ∑Â≤∏ËàáÊ±ü‰πãÂ≥∂",
                    weather: "Êô¥Â§© 5-12¬∞C",
                    locationKey: "kamakura",
                    imageUrl: "bridge_enoshima.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "È£ØÂ∫óÊó©È§ê", dish: "Ëá™Âä©È§ê", priceLevel: "Â∑≤Âê´", url: "", locationUrl: "", note: "ÂêÉÈ£ΩÂÜçÂá∫Áôº" }],
                        lunch: [{ id: generateId(), name: "Tobiccho Êú¨Â∫ó", dish: "È≠©‰ªîÈ≠ö‰∏º", priceLevel: "¬•1800", url: "https://tobiccho.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê±ü‰πãÂ≥∂ÊéíÈöäÂêçÂ∫óÔºåÂèØÊäΩÊï¥ÁêÜÂà∏" }, { id: generateId(), name: "È≠öË¶ã‰∫≠", dish: "Êµ∑ÈÆÆ‰∏º", priceLevel: "¬•2000", url: "https://enoshima-uomitei.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êá∏Â¥ñÈÇäÊà∂Â§ñÂ∫ß‰ΩçÔºåÊôØËâ≤ÁÑ°Êïµ" }],
                        dinner: [{ id: generateId(), name: "AFURI Ê©´Êø±", dish: "ÊüöÂ≠êÊãâÈ∫µ", priceLevel: "¬•1200", url: "https://afuri.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÂõûÁ®ãÁ∂ìÈÅéÊ©´Êø±ÂêÉ" }, { id: generateId(), name: "Á£Ø‰∏∏Ê∞¥Áî¢", dish: "ËüπÂë≥ÂôåÁî≤ÁæÖÁáí", priceLevel: "¬•2000", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "Â∑ùÂ¥éÁ´ôÂâçÊúâÂàÜÂ∫óÔºå24Â∞èÊôÇÁáüÊ•≠" }]
                    },
                    events: [
                        { id: generateId(), time: "09:00", type: "sight", title: "Êñ∞Ê±ü‰πãÂ≥∂Ê∞¥ÊóèÈ§®", loc: "Ê±ü‰πãÂ≥∂", image: "aqu.jpg", tags: ["Êé®Ëñ¶:Ê∞¥ÊØçÂª≥"], desc: "Áõ∏Ê®°ÁÅ£Â§ßÊ∞¥ÊßΩËàáÂ§¢ÂπªÊ∞¥ÊØçÂª≥„ÄÇ", subItems: [{id: generateId(), type: 'do', text: 'ÁúãÊµ∑Ë±öË°®Êºî', checked: false}, {id: generateId(), type: 'buy', text: 'Ê∞¥ÊØçÁé©ÂÅ∂', checked: false}], transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°åÈÅéÊ©ã' } },
                        { id: generateId(), time: "11:30", type: "food", title: "‰ª≤Ë¶ã‰∏ñÈÄöÂêÉÈÄèÈÄè", loc: "Ê±ü‰πãÂ≥∂ËÄÅË°ó", image: "street_enoshima.jpg", tags: ["Á´†È≠ö‰ªôË≤ù", "È≠©‰ªîÈ≠ö"], desc: "ÂèÉÊãúÊ±üÂ≥∂Á•ûÁ§æÔºåË≥ºË≤∑ÊâãÊâ∂Ê¢ØÂ•óÁ•®ÔºåÈÇäËµ∞ÈÇäÂêÉ„ÄÇ", subItems: [{id: generateId(), type: 'eat', text: 'ÊúùÊó•Â†Ç Êï¥ÈöªÈæçËù¶‰ªôË≤ù', checked: false}, {id: generateId(), type: 'eat', text: 'Á¥Ä‰πãÂúãÂ±ãÂ•≥Â§´È•ÖÈ†≠', checked: false}], transitToNext: { mode: 'walk', duration: '20m', note: 'Êê≠‰πòÊâãÊâ∂Ê¢ØËá≥È†ÇÁ´Ø' } },
                        { id: generateId(), time: "13:00", type: "sight", title: "Êµ∑Ë†üÁá≠Â±ïÊúõÁáàÂ°î", loc: "Ê±ü‰πãÂ≥∂È†Ç", image: "candle.jpg", desc: "Â§©Ê∞£Â•ΩÂèØÁú∫ÊúõÂØåÂ£´Â±±„ÄÇ", transitToNext: { mode: 'walk', duration: '15m', note: 'ÂæÄ‰∏ãËµ∞Ëá≥Â•ßÊ¥•ÂÆÆÊñπÂêë' } },
                        { id: generateId(), time: "14:00", type: "food", title: "ÂçàÈ§êÔºöÈ≠öË¶ã‰∫≠", loc: "Ê±ü‰πãÂ≥∂Êá∏Â¥ñ", image: "restaurant_enoshima.jpg", tags: ["ÁµïÊôØÊà∂Â§ñÂ∫ß"], desc: "ÂùêÂú®Êá∏Â¥ñÈÇäÁúãÊµ∑ÂêÉÊµ∑ÈÆÆ‰∏ºÔºåË¶ñÈáéÊ•µ‰Ω≥„ÄÇ", transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°åËá≥Â≤©Â±ã' } },
                        { id: generateId(), time: "15:30", type: "sight", title: "Â≤©Â±ã", loc: "Ê±ü‰πãÂ≥∂ÂæåÂ±±", image: "cave.jpg", desc: "Êµ∑ËùïÂπ≥Âè∞ËàáÊ¥ûÁ™üÔºåÁµïÁæéÂ§ïÈôΩÂêçÊâÄ„ÄÇ", subItems: [{id: generateId(), type: 'do', text: 'ÊãçÂØåÂ£´Â±±Â§ïÈôΩ', checked: false}], transitToNext: { mode: 'walk', duration: '20m', note: 'Êê≠‰πòÂºÅÂ§©‰∏∏ÈÅäË¶ΩËàπÂõûÊ©ãÈ†≠(Ë¶ñÈ¢®Êµ™)' } },
                        { id: generateId(), time: "17:00", type: "transport", title: "ÊπòÂçóÂñÆËªåÈõªËªä", loc: "ÊπòÂçóÊ±ü‰πãÂ≥∂", image: "monorail.jpg", note: "ÂÄíÊéõÂºèÈõªËªäÔºåÂÉèÈõ≤ÈúÑÈ£õËªäËà¨Âà∫ÊøÄ„ÄÇ", transitToNext: { mode: 'train', duration: '30m', note: 'Â§ßËàπËΩâËªäÂõûÂ∑ùÂ¥é' } }
                    ]
                },
                {
                    date: "1/30", weekday: "ÈÄ±‰∫î",
                    title: "ÈéåÂÄâÂè§ÈÉΩËàáÊô¥Á©∫Â°î",
                    weather: "Â§öÈõ≤ 4-10¬∞C",
                    locationKey: "kamakura",
                    imageUrl: "kamakura.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "Bills ‰∏ÉÈáåÊø±", dish: "RicottaÈ¨ÜÈ§Ö", priceLevel: "¬•2200", url: "https://billsjapan.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÈúÄÊèêÂâçÂÖ©ÈÄ±È†êÁ¥ÑÁ™óÈÇä‰Ωç" }],
                        lunch: [{ id: generateId(), name: "Caraway", dish: "ÁâõËÇâÂíñÂì©", priceLevel: "¬•900", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÈéåÂÄâÊéíÈöäÂêçÂ∫óÔºåCPÂÄºÈ´ò" }, { id: generateId(), name: "Oxymoron", dish: "ÂíåÈ¢®ËÇâÊú´ÂíñÂì©", priceLevel: "¬•1500", url: "https://www.oxymoron.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Â∞èÁî∫ÈÄöÂ∑∑ÂÖßÊñáÈùíÂ∫ó" }],
                        dinner: [{ id: generateId(), name: "Âà©‰πÖÁâõËàå", dish: "ÁâõËàåÂÆöÈ£ü", priceLevel: "¬•2500", url: "https://www.rikyu-gyutan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êô¥Á©∫Â°î6FÔºåÂéöÂàáÁâõËàåÂøÖÂêÉ" }, { id: generateId(), name: "ÂÖ≠ÂéòËàç", dish: "ÁâπË£ΩÊ≤æÈ∫µ", priceLevel: "¬•1100", url: "https://www.rokurinsha.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êô¥Á©∫Â°î6FÔºåÈ∫µÊ¢ùQÂΩà" }, { id: generateId(), name: "Toriton Ëø¥ËΩâÂ£ΩÂè∏", dish: "ÂåóÊµ∑ÈÅìÊôÇ‰ª§Â£ΩÂè∏", priceLevel: "¬•3000", url: "http://toriton-kita1.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êô¥Á©∫Â°î6FÔºå‰æÜËá™ÂåóÊµ∑ÈÅìÁöÑË∂Ö‰∫∫Ê∞£Â∫ó" }]
                    },
                    events: [
                        { id: generateId(), time: "10:00", type: "food", title: "bills Êó©ÂçàÈ§ê", loc: "‰∏ÉÈáå„É∂Êµú", image: "bills.jpg", tags: ["ÂøÖÂêÉ:È¨ÜÈ§Ö", "È†êÁ¥Ñ"], desc: "ËôüÁ®±‰∏ñÁïåÁ¨¨‰∏ÄÊó©È§êÔºåÊµ∑ÊôØÁ¨¨‰∏ÄÊéí„ÄÇ", transitToNext: { mode: 'train', duration: '15m', note: 'Ê±ü‰πãÈõª (‰∏ÉÈáåÊø±->Èï∑Ë∞∑)' } },
                        { id: generateId(), time: "12:00", type: "sight", title: "ÈéåÂÄâÂ§ß‰Ωõ", loc: "È´òÂæ∑Èô¢", image: "buddha.jpg", desc: "ÂúãÂØ∂ÈäÖÈÄ†ÈòøÂΩåÈôÄÂ¶Ç‰æÜÂùêÂÉè„ÄÇ", subItems: [{id: generateId(), type: 'do', text: 'ÈÄ≤ÂÖ•Â§ß‰ΩõËÉéÂÖßÂèÉËßÄ(¬•50)', checked: false}], transitToNext: { mode: 'train', duration: '10m', note: 'Ê±ü‰πãÈõª (Èï∑Ë∞∑->ÈéåÂÄâ)' } },
                        { id: generateId(), time: "13:30", type: "sight", title: "È∂¥Â≤°ÂÖ´Âπ°ÂÆÆ", loc: "ÈéåÂÄâ", image: "kamakura.jpg", tags: ["Â∞èÁî∫ÈÄö"], desc: "ÈéåÂÄâÂú∞Ê®ôÔºåÂèÉÈÅìÈùûÂ∏∏ÁÜ±È¨ßÔºåÊúâË®±Â§öÂ∞èÂêÉ„ÄÇ", subItems: [{id: generateId(), type: 'buy', text: 'Ë±êÂ≥∂Â±ã È¥øÂ≠êÈ§Ö‰πæ', checked: false}, {id: generateId(), type: 'eat', text: 'Kamakura Chacha ÊäπËå∂ÈúúÊ∑áÊ∑ã', checked: false}, {id: generateId(), type: 'eat', text: 'Â§¢Ë¶ãÂ±ã Á≥∞Â≠ê', checked: false}], transitToNext: { mode: 'train', duration: '60m', note: 'JRÊ©´È†àË≥ÄÁ∑ö -> Ê∑∫ËçâÁ∑ö (Áõ¥ÈÄö)' } },
                        { id: generateId(), time: "16:00", type: "transport", title: "Check-in Ê∑∫Ëçâ", loc: "Êù±Ê©´INN", image: "inn.jpg", tags: ["Â∞èÁî∫ÈÄö"], note: "ÂØÑÊîæË°åÊùé„ÄÅÁ®ç‰Ωú‰ºëÊÅØ", transitToNext: { mode: 'train', duration: '5m', note: 'Ê∑∫ËçâÁ∑ö (Ê∑∫Ëçâ->Êäº‰∏ä)' } },
                        { id: generateId(), time: "19:00", type: "food", title: "Êô¥Á©∫Â°î", loc: "Êäº‰∏ä", image: "skytree.jpg", tags: ["ÂøÖÈÄõ", "ÊôöÈ§ê"], desc: "Ë≥ºÁâ©ÂïÜÂüéÔºåÂÖ≠ÂéòËàçÊ≤æÈ∫µ„ÄÅÂà©‰πÖÁâõËàåÈÉΩÂú®ÈÄô„ÄÇ", subItems: [{id: generateId(), type: 'buy', text: 'Tokyo Banana (Êô¥Á©∫Â°îÈôêÂÆöË±πÁ¥ã)', checked: false}, {id: generateId(), type: 'buy', text: 'Press Butter Sand', checked: false}, {id: generateId(), type: 'do', text: 'ÂØ∂ÂèØÂ§¢‰∏≠ÂøÉ', checked: false}] }
                    ]
                },
                {
                    date: "1/31", weekday: "ÈÄ±ÂÖ≠",
                    title: "Â∞èÊ±üÊà∂Â∑ùË∂ä",
                    weather: "Êô¥Â§© 3-11¬∞C",
                    locationKey: "kawagoe",
                    imageUrl: "oldstreet.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "‰æøÂà©ÂïÜÂ∫ó", dish: "ÂíñÂï°/È∫µÂåÖ", priceLevel: "¬•400", url: "", locationUrl: "", note: "" }],
                        lunch: [{ id: generateId(), name: "Â∞èÂ∑ùËèä", dish: "È∞ªÈ≠öÈ£Ø", priceLevel: "¬•4000", url: "https://www.ogakiku.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÁôæÂπ¥ËÄÅÂ∫óÔºåÂãôÂøÖÈñãÈñÄÂâçÊéíÈöä" }, { id: generateId(), name: "Â∑ùË∂äÈáúÈ£Ø Torisei", dish: "ÈáúÈ£ØÂÆöÈ£ü", priceLevel: "¬•1500", url: "http://www.torisei.net/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÊéíÈöäÂêçÂ∫óÔºåÈõûËÇâÈáúÈ£ØÂæàÈ¶ô" }, { id: generateId(), name: "Hayashiya", dish: "È∞ªÈ≠öÈ£Ø", priceLevel: "¬•3500", url: "", locationUrl: "", note: "ËÄÅË°ó‰∏äÁöÑÂè¶‰∏ÄÈÅ∏Êìá" }],
                        dinner: [{ id: generateId(), name: "ÁÑ°ÊïµÂÆ∂", dish: "Ë±öÈ™®ÊãâÈ∫µ", priceLevel: "¬•1200", url: "https://mutekiya.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê±†Ë¢ãÂêçÂ∫óÔºåÂõûÁ®ãÈ†ÜË∑ØÂêÉ" }, { id: generateId(), name: "Ê¥ªÁæéÁôªÂà©Â£ΩÂè∏", dish: "Ëø¥ËΩâÂ£ΩÂè∏", priceLevel: "¬•2500", url: "https://katumidori.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê±†Ë¢ãË•øÊ≠¶ÁôæË≤®8FÔºåCPÂÄºÈ´ò" }]
                    },
                    events: [
                        { id: generateId(), time: "09:00", type: "transport", title: "ÂâçÂæÄÂ∑ùË∂ä", loc: "Ê±†Ë¢ãÁ´ô", image: "kawagoePass.png", note: "Ë≥ºË≤∑Êù±Ê≠¶Â∑ùË∂äÂë®ÈÅäÂà∏", transitToNext: { mode: 'train', duration: '30m', note: 'Êù±Ê≠¶Êù±‰∏äÁ∑öÊÄ•Ë°å' } },
                        { id: generateId(), time: "10:30", type: "sight", title: "ÂÜ∞Â∑ùÁ•ûÁ§æ", loc: "Â∑ùË∂ä", image: "hikawa.jpg", tags: ["È´îÈ©ó:Èá£ÈØõÈ≠ö"], desc: "Ê±ÇÂßªÁ∑£ÂêçÊâÄÔºåÁπ™È¶¨ÈößÈÅìÂøÖÊãç„ÄÇ", subItems: [{id: generateId(), type: 'do', text: 'Èá£Á¥ÖËâ≤ÈØõÈ≠ö(Ê±ÇÂπ≥ÂÆâ)', checked: false}, {id: generateId(), type: 'do', text: 'Èá£Á≤âËâ≤ÈØõÈ≠ö(Ê±ÇËâØÁ∑£)', checked: false}, {id: generateId(), type: 'do', text: 'Êîæ‰∫∫ÂΩ¢ÊµÅ(Èô§Á©¢)', checked: false}], transitToNext: { mode: 'bus', duration: '10m', note: 'Êù±Ê≠¶Â∑¥Â£´' } },
                        { id: generateId(), time: "12:00", type: "food", title: "Â∑ùË∂äÈáúÈ£Ø Torisei", loc: "Â∑ùË∂ä", image: "torisei.jpg", desc: "ÊãõÁâåËèúÊòØ„ÄåÂ∑ùË∂äÈáúÈ£ØÂÆöÈ£ü„ÄçÔºàÈ∞ªÈ≠öÂ°äÈÖçÂ∑ùË∂äÂêçÁâ©Áï™ËñØÔºâÂèä„ÄåÈ≥•„ÇÇ„ÇÇÁÇ≠ÁÅ´ÁÑºÂÆöÈ£ü„Äç„ÄÇ", transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°å' } },
                        { id: generateId(), time: "13:00", type: "food", title: "Â∞èÂ∑ùËèä È∞ªÈ≠öÈ£Ø", loc: "Â∑ùË∂ä", image: "mini_unagi.jpg", tags: ["ÂøÖÂêÉ:È∞ªÈ≠ö"], desc: "ÁôæÂπ¥ËÄÅÂ∫óÔºåÁÇ≠ÁÉ§È¶ôÊ∞£ÂçÅË∂≥„ÄÇËã•Â§™‰πÖÂèØÊîπÂêÉ'ÂÇ≥Á±≥'ÔºåÂÇ≥Á±≥ÊúâÊèê‰æõËø∑‰Ω†È∞ªÈ≠öÈ£Ø„ÄÇ", transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°åËá≥‰∏ÄÁï™Ë°ó' } },
                        { id: generateId(), time: "14:00", type: "sight", title: "ËóèÈÄ†ËÄÅË°ó", loc: "‰∏ÄÁï™Ë°ó", image: "oldstreet.jpg", tags: ["ÈæúÂ±ãÈäÖÈëºÁáí","Â∑ùË∂äÂ∏É‰∏Å","Â∞èÊ±üÊà∂Â§ßËä±-ÁéâÂ≠êÁáí"], desc: "Âú®Â∑ùË∂äÁöÑ‰∏ªË¶ÅË°óÈÅì„ÄåÂ∞èÊ±üÊà∂Â∑ùË∂ä‰∏ÄÁï™Ë°óÂïÜÂ∫óË°ó„ÄçË£°...", subItems: [{id: generateId(), type: 'eat', text: 'Â∑ùË∂äÂ∏É‰∏Å (Â∑ùË∂ä„Éó„É™„É≥)', checked: false}, {id: generateId(), type: 'eat', text: 'Â∞èÊ±üÊà∂Â§ßËä± Ê£çÁãÄÁéâÂ≠êÁáí', checked: false}, {id: generateId(), type: 'eat', text: 'Á¥´ËñØÂÜ∞Ê∑áÊ∑ã', checked: false}], transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°å' } },
                        { id: generateId(), time: "15:00", type: "sight", title: "ÊôÇ‰πãÈêò", loc: "‰∏ÄÁï™Ë°ó", image: "toki.jpg", tags: ["ÈæúÂ±ãÈäÖÈëºÁáí"], desc: "ÊôÇ‰πãÈêòÊòØ‰∏ÄÂÄãÈ´òÁ¥Ñ16ÂÖ¨Â∞∫ÁöÑÊú®Ë£ΩÈêòÊ®ìÔºåÁèæÂú®ÊòØÂ∑ùË∂äÁöÑÂú∞Ê®ôÊÄßÂª∫ÁØâ„ÄÇ", subItems: [{id: generateId(), type: 'buy', text: 'ÈæúÂ±ã ÈäÖÈëºÁáí', checked: false}], transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°å' } },
                        { id: generateId(), time: "15:30", type: "sight", title: "Â§ßÊ≠£Êµ™Êº´Â§¢ÈÄö", loc: "Â∑ùË∂ä", image: "taisei.jpg", desc: "‰ΩçÂú®Â∑ùË∂äÁöÑ„ÄåÂ§ßÊ≠£Êµ™Êº´Â§¢ÈÄö„Çä„ÄçÊòØ‰∏ÄÊ¢ùÂÖÖÊªøÊá∑ËàäÊ∞õÂúçÁöÑÊ≠∑Âè≤ÂïÜÂ∫óË°ó„ÄÇ", transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°å' } },
                        { id: generateId(), time: "16:00", type: "sight", title: "ÁÜäÈáéÁ•ûÁ§æ", loc: "Â∑ùË∂ä", image: "kumano.jpg", tags:["Èå¢Ê¥óÂºÅË≤°Â§©","Ê∞¥Êô∂ÁêÉ","Â•óÂúàÂúà"], desc: "Â∑ùË∂äÁÜäÈáéÁ•ûÁ§æÊòØ‰∏ÄÂ∫ßÊ≠∑Âè≤ÊÇ†‰πÖÁöÑÈñãÈÅã„ÄÅÁµêÁ∑£Á•ûÁ§æ„ÄÇ", subItems: [{id: generateId(), type: 'do', text: 'Ê¥óÈå¢ÂºÅË≤°Â§©', checked: false}, {id: generateId(), type: 'do', text: 'ÂÅ•Â∫∑Ê≠•ÈÅì', checked: false}], transitToNext: { mode: 'train', duration: '45m', note: 'ÂõûÊ±†Ë¢ã/Ê∑∫Ëçâ' } }
                    ]
                },
                {
                    date: "2/1", weekday: "ÈÄ±Êó•",
                    title: "Êó•ÂÖâ‰∏ñÁïåÈÅ∫Áî¢",
                    weather: "Èõ™/Èõ® 0-5¬∞C",
                    locationKey: "nikko",
                    imageUrl: "Toshogu.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "Spacia X ËªäÂÖßË≤©ÂîÆ", dish: "Á≤æÈáÄÂï§ÈÖí/ÂíñÂï°", priceLevel: "¬•600", url: "", locationUrl: "", note: "Ëªä‰∏äCafe" }],
                        lunch: [{ id: generateId(), name: "Ê≤πÊ∫ê", dish: "ÊπØÊ≥¢(Ë±ÜÁöÆ)ÊñôÁêÜ", priceLevel: "¬•2000", url: "https://www.aburagen.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êó•ÂÖâÂêçÁâ©ÔºåÂÅ•Â∫∑ÁæéÂë≥" }, { id: generateId(), name: "Meiji-no-Yakata", dish: "ËõãÂåÖÈ£Ø/Ëµ∑Âè∏ËõãÁ≥ï", priceLevel: "¬•2500", url: "http://www.meiji-yakata.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÊòéÊ≤ª‰πãÈ§®ÔºåÊ¥ãÈ£üÂêçÂ∫ó" }, { id: generateId(), name: "Komekichi Kozushi", dish: "Êó•ÂÖâÊπØÊ≥¢Â£ΩÂè∏", priceLevel: "¬•1800", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÂâµÊÑèÂ£ΩÂè∏" }],
                        dinner: [{ id: generateId(), name: "Ê∑∫Ëçâ ÁâõÁÇ∏(Gyukatsu)", dish: "ÁÇ∏ÁâõÊéí", priceLevel: "¬•1800", url: "https://www.asakusa-gyukatsu.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Èõ∑ÈñÄÂ∞çÈù¢Ôºå‰∫∫Ê∞£ÊéíÈöäÂ∫ó" }, { id: generateId(), name: "Yoroiya Ê∑∫ËçâÊãâÈ∫µ", dish: "ÈÜ¨Ê≤πÊãâÈ∫µ", priceLevel: "¬•900", url: "https://yoroiya.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê∏ÖÊ∑°Á≥ªÈÜ¨Ê≤πÊãâÈ∫µÔºåÂä†ÂÖ•ÊüöÂ≠êÊèêÂë≥" }, { id: generateId(), name: "Â§ßÈªëÂÆ∂", dish: "Êµ∑ËÄÅÂ§©‰∏º", priceLevel: "¬•2000", url: "http://www.tempura.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÈªëÈ∫ªÊ≤πÁÇ∏Â§©Â©¶ÁæÖÔºåÂè£Âë≥ËºÉÈáç" }]
                    },
                    events: [
                        { id: generateId(), time: "06:00", type: "transport", title: "SPACIA X (ÂéªÁ®ã)", loc: "Ê∑∫ËçâÁ´ô", image: "spaciaX.jpeg", tags: ["È†êÁ¥Ñ:ÂøÖÈ†à"], desc: "ÊúÄÊñ∞Â•¢ËèØËßÄÂÖâÂàóËªä„ÄÇ", subItems: [{id: generateId(), type: 'eat', text: 'ËªäÂÖßÈôêÂÆö Craft Beer', checked: false}, {id: generateId(), type: 'eat', text: 'Êó•ÂÖâÊÑèÂºèÂÜ∞Ê∑áÊ∑ã', checked: false}], transitToNext: { mode: 'train', duration: '1h 50m', note: 'Êù±Ê≠¶Êó•ÂÖâÁ∑ö' } },
                        { id: generateId(), time: "09:30", type: "food", title: "ÁÇ∏ÊπØÊ≥¢È•ÖÈ†≠", loc: "Êó•ÂÖâSakaeya", image: "sakaeya.jpg", tags: ["ÂøÖÂêÉ"], desc: "Êíí‰∏äÈπΩÂ∑¥ÁöÑÁÇ∏Ë±ÜÁöÆÈ•ÖÈ†≠ÔºåÁîúÈππÁµïÈÖç„ÄÇ", subItems: [{id: generateId(), type: 'eat', text: 'ÁÇ∏ÊπØÊ≥¢È•ÖÈ†≠', checked: false}], transitToNext: { mode: 'bus', duration: '10m', note: '‰∏ñÁïåÈÅ∫Áî¢Â∑°ÈÅäÂ∑¥Â£´' } },
                        { id: generateId(), time: "11:00", type: "sight", title: "Êó•ÂÖâ‰∏ñÁïåÈÅ∫Áî¢‰∫åÁ§æ‰∏ÄÂØ∫", loc: "Êó•ÂÖâ", image: "Toshogu.jpg", tags: ["‰∫åËçíÂ±±Á•ûÁ§æ","Êù±ÁÖßÂÆÆ","Â±±Ëº™ÁéãÂØ∫"], desc: "** Êó•ÂÖâÊù±ÁÖßÂÆÆ **\nÊó•ÂÖâÊù±ÁÖßÂÆÆÊòØ‰æõÂ•âÊ±üÊà∂ÂπïÂ∫úÁ¨¨‰∏Ä‰ª£Â∞áËªçÂæ∑Â∑ùÂÆ∂Â∫∑ÁöÑÁ•ûÁ§æ...", subItems: [{id: generateId(), type: 'do', text: 'Êâæ„ÄåÁú†Ë≤ì„Äç', checked: false}, {id: generateId(), type: 'do', text: 'Êâæ„Äå‰∏âÁåø„Äç(ÈùûÁ¶ÆÂãøË¶ñ...)', checked: false}, {id: generateId(), type: 'do', text: 'ËÅΩ„ÄåÈ≥¥Èæç„ÄçÂõûÈü≥', checked: false}], transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°å' } },
                        { id: generateId(), time: "13:30", type: "food", title: "ÊπØÊ≥¢ÊñôÁêÜÂçàÈ§ê", loc: "Ê≤πÊ∫ê", image: "yuba.jpg", tags: ["ÊπØÊ≥¢Âæ°ËÜ≥"], desc: "Êó•ÂÖâÂêçÁî¢Ë±ÜÁöÆÊñôÁêÜ„ÄÇ", transitToNext: { mode: 'walk', duration: '15m', note: 'Ê≠•Ë°å' } },
                        { id: generateId(), time: "15:30", type: "sight", title: "Á•ûÊ©ã", loc: "Êó•ÂÖâ", image: "hashi.jpg", desc: "Êú±Á¥ÖËâ≤Êã±Ê©ãËàáÈõ™ÊôØ/Ê∫™ÊµÅÁöÑÂ∞çÊØî„ÄÇ‰∏äÊ©ãË¶ÅËä±Èå¢ÔºåÂª∫Ë≠∞ÈÅ†ÁúãÂ∞±Â•Ω„ÄÇ", transitToNext: { mode: 'bus', duration: '10m', note: 'Â∑¥Â£´ÂõûËªäÁ´ô' } },
                        { id: generateId(), time: "16:30", type: "transport", title: "SPACIA X (ÂõûÁ®ã)", loc: "Êù±Ê≠¶Êó•ÂÖâÁ´ô", image: "spaciax.jpeg", note: "Âú®Ëªä‰∏ä‰∫´Áî®Êó•ÂÖâÂ∏É‰∏ÅÊàñÂï§ÈÖí„ÄÇ", transitToNext: { mode: 'train', duration: '2h', note: 'ÂõûÊ∑∫Ëçâ' } }
                    ]
                },
                {
                    date: "2/2", weekday: "ÈÄ±‰∏Ä",
                    title: "Êù±‰∫¨Á∂ìÂÖ∏Á≤æÈÅ∏",
                    weather: "Â§öÈõ≤ 5-12¬∞C",
                    locationKey: "tokyo",
                    imageUrl: "tokyo_tower.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "Pelican Cafe", dish: "ÁÇ≠ÁÉ§ÂêêÂè∏", priceLevel: "¬•800", url: "https://www.bakerpelican.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê∑∫ËçâÈ∫µÂåÖËÄÅËàñÔºåÈúÄÊéíÈöä" }, { id: generateId(), name: "February Cafe", dish: "ÁÑ¶Á≥ñÂ∏É‰∏Å", priceLevel: "¬•700", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "‰ΩøÁî®PelicanÂêêÂè∏ÁöÑÊñáÈùíÂíñÂï°Â∫ó" }],
                        lunch: [{ id: generateId(), name: "Ê∑∫Ëçâ‰ªäÂçä", dish: "Â£ΩÂñúÁáíÂçàËÜ≥", priceLevel: "¬•4000", url: "https://www.asakusaimahan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÁôæÂπ¥ËÄÅÂ∫óÔºåÂçàÈ§êCPÂÄºËºÉÈ´ò" }, { id: generateId(), name: "Namiki Yabusoba", dish: "È¥®ÂçóË†ªËïéÈ∫•È∫µ", priceLevel: "¬•1800", url: "https://yabusoba.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ëó™ËïéÈ∫•Âæ°‰∏âÂÆ∂‰πã‰∏Ä" }],
                        dinner: [{ id: generateId(), name: "Ê†πÂÆ§Ëä±‰∏∏", dish: "Ëø¥ËΩâÂ£ΩÂè∏", priceLevel: "¬•3000", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "KITTE‰∏∏‰πãÂÖßÂ∫óÔºåÊéíÈöäÂêçÂ∫ó" }, { id: generateId(), name: "Tsurutontan", dish: "Â§ßÁ¢óÁÉèÈæçÈ∫µ", priceLevel: "¬•1500", url: "http://www.tsurutontan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÈäÄÂ∫ßTokyu PlazaÔºåÁ¢óÊØîËáâÂ§ß" }, { id: generateId(), name: "ÈäÄÂ∫ß ÁØù (Kagari)", dish: "ÈõûÁôΩÊπØSoba", priceLevel: "¬•1200", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "Á±≥ÂÖ∂ÊûóÊé®Ëñ¶ÔºåÊøÉÈÉÅÈõûÁôΩÊπØ" }]
                    },
                    events: [
                        { id: generateId(), time: "9:00", type: "food", title: "Pelican CAFE", loc: "Áî∞ÂéüÁî∫", image: "pelican.jpg", tags: ["ÁÇ≠ÁÉ§ÂêêÂè∏"], desc: "Ê∑∫ËçâÈ∫µÂåÖËÄÅËàñ„ÄåÈµúÈ∂òÈ∫µÂåÖ„Äç‰∫∫Ê∞£Êó©È§êÔºåÂøÖÈªûÁÇ∏ÁÅ´ËÖø‰∏âÊòéÊ≤ª„ÄÇ", transitToNext: { mode: 'walk', duration: '15m', note: 'Ê≠•Ë°åËá≥Èõ∑ÈñÄ' } },
                        { id: generateId(), time: "10:30", type: "sight", title: "Ê∑∫ËçâÂØ∫ & Èõ∑ÈñÄ", loc: "Ê∑∫Ëçâ", image: "asakusa.jpg", tags: ["ÂàùË®™ÂøÖÂéª"], desc: "Êù±‰∫¨ÊúÄÂè§ËÄÅÂØ∫ÂªüÔºåÊó©‰∏äÂéª‰∫∫ËºÉÂ∞ë„ÄÇ", subItems: [{id: generateId(), type: 'do', text: 'Ê±ÇÁ±§ (Âá∂Ë¶ÅÁ∂ÅÂú®Êû∂‰∏ä)', checked: false}, {id: generateId(), type: 'buy', text: '‰∫∫ÂΩ¢Ááí', checked: false}, {id: generateId(), type: 'eat', text: 'Ëä±ÊúàÂ†Ç Ëè†ËòøÈ∫µÂåÖ', checked: false}], transitToNext: { mode: 'train', duration: '20m', note: 'ÈäÄÂ∫ßÁ∑ö (Ê∑∫Ëçâ->‰∫¨Ê©ã/Êó•Êú¨Ê©ã)' } },
                        { id: generateId(), time: "13:00", type: "sight", title: "Êù±‰∫¨ËªäÁ´ô", loc: "‰∏∏‰πãÂÖß", image: "station.jpg", tags: ["‰º¥ÊâãÁ¶Æ"], desc: "Ê¨£Ë≥ûÁ¥ÖÁ£öËªäÁ´ôÂª∫ÁØâ„ÄÇ", subItems: [{id: generateId(), type: 'buy', text: 'NY Perfect Cheese', checked: false}, {id: generateId(), type: 'buy', text: 'NewYork City Sand', checked: false}], transitToNext: { mode: 'train', duration: '15m', note: '‰∏∏‰πãÂÖßÁ∑ö/JR (Êù±‰∫¨->Ëµ§ÁæΩÊ©ã)' } },
                        { id: generateId(), time: "15:00", type: "sight", title: "Êù±‰∫¨ÈêµÂ°î", loc: "ËäùÂÖ¨Âúí", image: "tokyo_tower.jpg", tags: ["ÂøÖÊãç:ÂÖ®ÊôØ"], desc: "ÂùêÂú®ËçâÂú∞‰∏äËàáÊù±‰∫¨ÈêµÂ°îÂêàÁÖß„ÄÇ", subItems: [{id: generateId(), type: 'do', text: 'Êãç„ÄåÂú∞‰∏ãÂÅúËªäÂ†¥Ê®ìÊ¢Ø„ÄçÁ∂≤ÁæéÁÖß', checked: false}] }
                    ]
                },
                {
                    date: "2/3", weekday: "ÈÄ±‰∫å",
                    title: "Ê≠∏ÈÄî",
                    weather: "Êô¥ÊôÇÂ§öÈõ≤",
                    locationKey: "tokyo",
                    imageUrl: "skytree.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "È£ØÂ∫óÊó©È§ê", dish: "È£ØÁ≥∞", priceLevel: "", url: "", locationUrl: "", note: "" }],
                        lunch: [{ id: generateId(), name: "Â£ΩÂè∏‰∫¨Ëæ∞", dish: "Â£ΩÂè∏", priceLevel: "¬•3000", url: "", locationUrl: "", note: "ÊàêÁî∞Ê©üÂ†¥ÁÆ°Âà∂ÂçÄÂÖßÔºåÊúÄÂæå‰∏ÄÈ†ìÁæéÈ£ü" }, { id: generateId(), name: "È∫•Áï∂Âãû", dish: "ÂüπÊ†πÈ¶¨Èà¥ËñØÊ¥æ", priceLevel: "¬•500", url: "", locationUrl: "", note: "Êó•Êú¨ÈôêÂÆöÂè£Âë≥" }],
                        dinner: []
                    },
                    events: [
                        { id: generateId(), time: "08:00", type: "hotel", title: "Check-out", loc: "Êù±Ê©´INN", image: "inn.jpg", note: "Ê™¢Êü•Ë≠∑ÁÖß„ÄÅÈå¢ÂåÖ„ÄÇ", transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°åËá≥ËªäÁ´ô' } },
                        { id: generateId(), time: "08:30", type: "transport", title: "ÂâçÂæÄÊ©üÂ†¥", loc: "AccessÁâπÂø´", image: "access.jpg", note: "Áõ¥ÈÅîÊàêÁî∞ (Á¥Ñ60ÂàÜ)„ÄÇ", transitToNext: { mode: 'train', duration: '60m', note: 'Áõ¥ÈÅîÁâπÂø´' } },
                        { id: generateId(), time: "10:12", type: "sight", title: "Ê©üÂ†¥ÊúÄÂæåË°ùÂà∫", loc: "ÊàêÁî∞ T2", image: "naritaT.jpg", tags: ["ÂÖçÁ®ÖÂ∫ó"], desc: "Ë≥ºË≤∑ÁôΩËâ≤ÊàÄ‰∫∫„ÄÅRoyce„ÄÇ", subItems: [{id: generateId(), type: 'buy', text: 'Royce ÁîüÂ∑ßÂÖãÂäõ', checked: false}, {id: generateId(), type: 'buy', text: 'LeTAO Ëµ∑Âè∏ËõãÁ≥ï', checked: false}, {id: generateId(), type: 'buy', text: 'ËñØÊ¢ù‰∏âÂÖÑÂºü', checked: false}], transitToNext: { mode: 'walk', duration: '30m', note: 'ÁôªÊ©üÂè£' } },
                        { id: generateId(), time: "13:00", type: "transport", title: "Ëµ∑È£õ BR197", loc: "ÊàêÁî∞Ê©üÂ†¥", image: "plane.jpg", note: "ÂÜçË¶ãÊù±‰∫¨ÔºÅ" }
                    ]
                }
            ]
        };

        // --- 3. HELPER COMPONENTS ---

        const typeColors = {
            transport: 'text-blue-400',
            food: 'text-orange-400',
            hotel: 'text-indigo-400',
            sight: 'text-matcha'
        };

        const EventCard = ({ event, onClick }) => (
            <div onClick={onClick} className="relative group cursor-pointer bg-white/50 rounded-2xl p-3 border border-transparent hover:border-matcha/30 hover:bg-white/80 transition-all duration-300">
                <div className="absolute -left-[45px] top-6 w-5 h-5 rounded-full border-4 border-rice bg-slate-300 group-hover:bg-matcha transition-colors shadow-sm z-10"></div>
                <div className="flex justify-between items-start gap-3">
                    <div className="flex-1">
                        <div className="flex items-baseline gap-2 mb-1">
                            <span className="font-mono text-sm font-bold text-slate-500">{event.time}</span>
                            <span className={`text-[10px] font-bold uppercase tracking-wider ${typeColors[event.type] || 'text-slate-400'} opacity-80`}>{event.type}</span>
                        </div>
                        <h3 className="text-lg font-bold text-charcoal leading-tight mb-1">{event.title}</h3>
                        <p className="text-sm text-slate-500 font-medium truncate tracking-wide flex items-center"><i className="fa-solid fa-location-dot text-xs mr-1 opacity-70"></i>{event.loc}</p>
                        {event.subItems && event.subItems.length > 0 && (
                            <div className="mt-3 flex flex-wrap gap-2">
                                {event.subItems.slice(0, 3).map(item => (
                                    <span key={item.id} className={`text-[10px] px-2 py-0.5 rounded-md border ${item.checked ? 'bg-matcha text-white border-matcha' : 'bg-white text-slate-500 border-slate-200'}`}>
                                        {item.type === 'buy' ? 'üõçÔ∏è' : item.type === 'eat' ? 'üç¥' : '‚ú®'} {item.text}
                                    </span>
                                ))}
                                {event.subItems.length > 3 && <span className="text-[10px] text-slate-400">+...</span>}
                            </div>
                        )}
                    </div>
                    {event.image && <img src={event.image} className="w-20 h-20 rounded-xl object-cover shadow-sm opacity-90 group-hover:opacity-100 transition-opacity bg-slate-200 flex-shrink-0" loading="lazy" onError={(e) => e.target.style.display = 'none'} />}
                </div>
            </div>
        );

        const getTransportIcon = (mode) => {
            switch(mode) {
                case 'train': return 'fa-train-subway';
                case 'walk': return 'fa-person-walking';
                case 'taxi': return 'fa-taxi';
                case 'bus': return 'fa-bus';
                default: return 'fa-arrow-right';
            }
        };

        const TransportConnector = ({ data, onClick }) => {
            if (!data) return (
                <div className="relative h-12 ml-[10px] border-l-2 border-dotted border-slate-300 my-1 group cursor-pointer" onClick={(e) => { e.stopPropagation(); onClick(); }}>
                    <div className="absolute top-1/2 -left-[10px] -translate-y-1/2 w-6 h-6 rounded-full bg-white border border-slate-300 flex items-center justify-center text-slate-300 shadow-sm opacity-0 group-hover:opacity-100 transition-all hover:border-matcha hover:text-matcha active:scale-95"><i className="fa-solid fa-plus text-[10px]"></i></div>
                </div>
            );
            return (
                <div className="relative h-16 ml-[10px] border-l-2 border-dashed border-slate-300 my-1 group">
                    <button onClick={(e) => { e.stopPropagation(); onClick(); }} className="absolute top-1/2 -left-[14px] -translate-y-1/2 flex items-center gap-2 bg-white border border-slate-200 shadow-sm px-3 py-1.5 rounded-full hover:border-matcha hover:text-matcha transition-all z-20 active:scale-95 max-w-[180px]">
                        <i className={`fa-solid ${getTransportIcon(data.mode)} text-xs text-slate-400 group-hover:text-matcha flex-shrink-0`}></i>
                        <div className="flex flex-col items-start text-left overflow-hidden">
                            <span className="text-[10px] font-bold text-slate-500 whitespace-nowrap group-hover:text-matcha leading-tight">{data.duration}</span>
                            {data.note && <span className="text-[9px] text-slate-400 truncate w-full group-hover:text-matcha/70 leading-tight">{data.note}</span>}
                        </div>
                    </button>
                </div>
            );
        };

        const MealOptions = ({ mealData, onAdd, onEdit }) => {
            const [isOpen, setIsOpen] = useState(false);
            if (!mealData) return null;
            // Safer check
            const hasData = (mealData.breakfast?.length > 0) || (mealData.lunch?.length > 0) || (mealData.dinner?.length > 0);
            return (
                <div className="mb-8 px-1">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between bg-white border border-orange-100 p-3 rounded-xl shadow-sm mb-4 active:bg-orange-50 transition-colors">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><i className="fa-solid fa-utensils text-sm"></i></div>
                            <div className="text-left"><div className="text-sm font-bold text-charcoal">ÁæéÈ£üÂÇôÊ°à & Êé®Ëñ¶</div><div className="text-[10px] text-slate-400">{isOpen ? 'ÈªûÊìäÊî∂Âêà' : (hasData ? 'ÈªûÊìäÂ±ïÈñãÊü•ÁúãÂë®ÈÇäÈ§êÂª≥' : 'ÈªûÊìäÊñ∞Â¢ûÈ§êÂª≥Âè£Ë¢ãÂêçÂñÆ')}</div></div>
                        </div>
                        <i className={`fa-solid fa-chevron-down text-slate-300 transition-transform ${isOpen ? 'rotate-180' : ''}`}></i>
                    </button>
                    {isOpen && (
                        <div className="space-y-6 animate-fade-in pl-2">
                            {['breakfast', 'lunch', 'dinner'].map(type => (
                                <div key={type}>
                                    <div className="flex items-center justify-between mb-2 pr-2"><h5 className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">{type === 'breakfast' ? 'Êó©È§ê' : type === 'lunch' ? 'ÂçàÈ§ê' : 'ÊôöÈ§ê'}</h5></div>
                                    <div className="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x min-h-[100px]">
                                        {/* SAFE ACCESS with ?.map */}
                                        {mealData[type]?.map(m => (
                                            <div key={m.id} onClick={() => onEdit(type, m)} className="min-w-[220px] bg-white rounded-xl p-3 border border-subtle shadow-sm flex flex-col snap-start active:scale-95 transition-transform cursor-pointer relative group">
                                                <div className="absolute top-2 right-2 text-slate-300 group-hover:text-matcha transition-colors"><i className="fa-solid fa-pen-to-square text-xs"></i></div>
                                                <div className="flex justify-between items-start mb-2 pr-4"><h4 className="font-bold text-charcoal text-sm line-clamp-1">{m.name}</h4><span className="text-[10px] font-mono text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">{m.priceLevel}</span></div>
                                                <div className="text-xs text-slate-500 mb-1"><span className="text-orange-400 font-bold">‚òÖ Êé®:</span> {m.dish}</div>
                                                {m.note && <p className="text-[10px] text-slate-400 line-clamp-2 mb-3 bg-slate-50 p-1 rounded">{m.note}</p>}
                                                <div className="mt-auto flex gap-2">
                                                    {m.locationUrl && <a href={m.locationUrl} onClick={e => e.stopPropagation()} target="_blank" className="flex-1 py-1.5 text-center bg-slate-100 rounded-lg text-[10px] font-bold text-slate-600">Âú∞Âúñ</a>}
                                                    {m.url && <a href={m.url} onClick={e => e.stopPropagation()} target="_blank" className="flex-1 py-1.5 text-center bg-slate-100 rounded-lg text-[10px] font-bold text-slate-600">Êêú</a>}
                                                </div>
                                            </div>
                                        ))}
                                        <div onClick={() => onAdd(type)} className="min-w-[50px] flex items-center justify-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 cursor-pointer hover:border-matcha hover:bg-matcha/5 active:scale-95"><i className="fa-solid fa-plus text-slate-400"></i></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- 4. VIEW COMPONENTS ---

        const ItineraryView = ({ days, currentDayIdx, onDaySelect, onEventClick, onTransportClick, onAddEvent, onAddMeal, onEditMeal }) => {
            const isManualScroll = useRef(false);
            const [mapOpen, setMapOpen] = useState(false);

            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    if (isManualScroll.current) return;
                    const visibleDay = entries.find(e => e.isIntersecting);
                    if (visibleDay) {
                        const id = visibleDay.target.id;
                        const idx = parseInt(id.replace('day-', ''));
                        if (!isNaN(idx) && idx !== currentDayIdx) {
                            onDaySelect(idx); 
                        }
                    }
                }, { root: null, rootMargin: '-40% 0px -50% 0px', threshold: 0 });
                if(days) days.forEach((_, idx) => { const el = document.getElementById(`day-${idx}`); if (el) observer.observe(el); });
                return () => observer.disconnect();
            }, [days, currentDayIdx, onDaySelect]);

            const handleDayClick = (idx) => {
                isManualScroll.current = true;
                onDaySelect(idx);
                const el = document.getElementById(`day-${idx}`);
                if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); setTimeout(() => { isManualScroll.current = false; }, 600); }
            };

            return (
                <div className="px-6 pb-32">
                     <div className="mb-4">
                        <button onClick={() => setMapOpen(!mapOpen)} className="w-full bg-white border border-subtle rounded-xl p-3 flex items-center justify-between shadow-sm active:scale-[0.99] transition-transform">
                            <span className="text-xs font-bold text-charcoal flex items-center gap-2"><i className="fa-solid fa-map"></i> Êü•ÁúãË°åÁ®ãÁ∏ΩË¶ΩÂú∞Âúñ</span>
                            <i className={`fa-solid fa-chevron-down text-slate-300 transition-transform ${mapOpen ? 'rotate-180' : ''}`}></i>
                        </button>
                        {mapOpen && <div className="mt-2 rounded-xl overflow-hidden border border-subtle animate-fade-in"><img src="map.png" className="w-full object-cover" alt="Map" /></div>}
                     </div>

                    <div className="flex overflow-x-auto gap-5 py-4 hide-scrollbar sticky top-[60px] z-30 bg-rice/95 backdrop-blur -mx-6 px-6 mb-6 transition-all">
                        {days && days.map((day, idx) => (
                            <button key={idx} onClick={() => handleDayClick(idx)} className={`flex-shrink-0 text-center min-w-[48px] transition-all duration-300 group ${currentDayIdx === idx ? 'text-matcha scale-110' : 'text-slate-400 opacity-70'}`}>
                                <div className="text-[10px] font-bold uppercase tracking-widest mb-1">{day.weekday}</div>
                                <div className="text-xl font-bold font-mono relative">{day.date.split('/')[1] || day.date}{currentDayIdx === idx && (<div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-matcha"></div>)}</div>
                            </button>
                        ))}
                    </div>

                    <div className="space-y-12">
                        {days && days.map((day, dIdx) => (
                            <div id={`day-${dIdx}`} key={dIdx} className="scroll-mt-40 transition-opacity duration-500">
                                <div className="mb-6 px-1">
                                    <div className="flex items-center justify-between"><span className="text-xs font-bold text-slate-400 tracking-widest uppercase">{day.date} ¬∑ {day.weekday}</span><span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md"><i className="fa-solid fa-cloud-sun mr-1"></i>{day.weather}</span></div>
                                    <h2 className="text-2xl font-bold text-charcoal mt-2 tracking-wide">{day.title}</h2>
                                </div>
                                <MealOptions mealData={day.mealOptions} onAdd={(type) => onAddMeal(dIdx, type)} onEdit={(type, option) => onEditMeal(dIdx, type, option)} />
                                <div className="relative ml-2.5 pl-8 space-y-0 pb-4">
                                    <div className="absolute left-[10px] top-4 bottom-4 w-0.5 bg-slate-100 -z-10"></div>
                                    {day.events && day.events.map((ev, eIdx) => (
                                        <div key={ev.id}>
                                            <EventCard event={ev} onClick={() => onEventClick(dIdx, ev)} />
                                            {eIdx < day.events.length - 1 && <TransportConnector data={ev.transitToNext} onClick={() => onTransportClick(dIdx, ev.id)} />}
                                        </div>
                                    ))}
                                    <div className="h-8 border-l-2 border-slate-100 ml-[10px]"></div>
                                    <button onClick={() => onAddEvent(dIdx)} className="w-full py-4 border-2 border-dashed border-subtle rounded-xl text-slate-400 text-sm font-bold hover:border-matcha hover:text-matcha transition-colors">+ Êñ∞Â¢ûË°åÁ®ã</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const InfoView = ({ reservations, onEdit, onAdd }) => {
            const getStatusColor = (s) => s === 'booked' ? 'bg-matcha/10 text-matcha' : s === 'to-book' ? 'bg-orange-100 text-orange-500' : 'bg-slate-100 text-slate-500';
            const getStatusText = (s) => s === 'booked' ? 'Â∑≤È†êË®Ç' : s === 'to-book' ? 'ÂæÖÈ†êË®Ç' : 'ËôïÁêÜ‰∏≠';
            const getTypeIcon = (t) => t === 'flight' ? 'fa-plane' : t === 'hotel' ? 'fa-bed' : t === 'restaurant' ? 'fa-utensils' : 'fa-ticket';
            const speak = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); };

            return (
                <div className="px-6 space-y-6 pb-24 tracking-wide pt-6">
                    {/* Quick Links */}
                    <div className="grid grid-cols-2 gap-4">
                        <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" className="bg-blue-50 p-4 rounded-2xl flex flex-col items-center justify-center text-center border border-blue-100 active:scale-95 transition-transform"><i className="fa-solid fa-qrcode text-2xl text-blue-500 mb-2"></i><span className="text-xs font-bold text-blue-900">Visit Japan Web</span></a>
                        <a href="https://www.google.com/maps" target="_blank" className="bg-green-50 p-4 rounded-2xl flex flex-col items-center justify-center text-center border border-green-100 active:scale-95 transition-transform"><i className="fa-solid fa-map-location-dot text-2xl text-green-600 mb-2"></i><span className="text-xs font-bold text-green-900">Google Maps</span></a>
                    </div>
                    
                    {/* Japanese Phrases */}
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-subtle">
                         <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">ÊóÖÈÅäÂØ¶Áî®Êó•Ë™û (ÈªûÊìäÁôºÈü≥)</h3>
                         <div className="grid grid-cols-1 gap-2">
                            {PHRASES.map((p, i) => (
                                <div key={i} onClick={() => speak(p.jp)} className="flex justify-between items-start p-3 hover:bg-slate-50 rounded-xl cursor-pointer active:scale-[0.98] transition-all border border-transparent hover:border-subtle group">
                                    <div>
                                        <div className="text-lg font-bold text-matcha mb-1">{p.jp}</div>
                                        <div className="text-sm text-charcoal font-medium">{p.zh}</div>
                                        <div className="text-xs text-slate-400">{p.ro}</div>
                                    </div>
                                    <div className="text-slate-300 group-hover:text-matcha"><i className="fa-solid fa-volume-high"></i></div>
                                </div>
                            ))}
                         </div>
                    </div>

                    {/* Emergency Contacts */}
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-subtle">
                        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Á∑äÊÄ•ËÅØÁµ°</h3>
                        <div className="space-y-4">
                            <div className="flex justify-between items-center border-b border-slate-50 pb-3">
                                <div><div className="font-bold text-charcoal">ÊóÖÂ§ñÂúã‰∫∫ÊÄ•Èõ£ÊïëÂä©</div><div className="text-xs text-slate-400 mt-1">Êó•Êú¨Â¢ÉÂÖßÁõ¥Êí•</div></div>
                                <a href="tel:08010097179" className="text-red-500 font-mono font-bold text-lg">080-1009-7179</a>
                            </div>
                            <div className="flex justify-between items-center">
                                <div className="flex gap-4">
                                    <div><span className="text-xs text-slate-400 block">Â†±Ë≠¶</span><span className="font-bold text-xl">110</span></div>
                                    <div><span className="text-xs text-slate-400 block">ÊïëË≠∑</span><span className="font-bold text-xl">119</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Reservations */}
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-subtle">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest">È†êË®ÇËàáÁ•®Âà∏</h3><button onClick={onAdd} className="text-xs bg-[#f4f1e8] text-matcha px-3 py-1 rounded-full font-bold hover:bg-subtle transition-colors"><i className="fa-solid fa-plus mr-1"></i>Êñ∞Â¢û</button></div>
                        <div className="space-y-4">
                            {reservations && reservations.map(res => (
                                <div key={res.id} onClick={() => onEdit(res)} className="relative p-4 rounded-xl border border-subtle cursor-pointer active:scale-[0.98] transition-all hover:border-matcha group bg-slate-50/50">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-2">
                                            <div className="w-8 h-8 rounded-full bg-white border border-subtle flex items-center justify-center text-slate-500 group-hover:text-matcha group-hover:border-matcha transition-colors">
                                                <i className={`fa-solid ${getTypeIcon(res.type)}`}></i>
                                            </div>
                                            <div>
                                                <div className="text-xs font-bold text-slate-400 uppercase">{res.type}</div>
                                                <div className="text-base font-bold text-charcoal">{res.name}</div>
                                            </div>
                                        </div>
                                        <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${getStatusColor(res.status)}`}>{getStatusText(res.status)}</span>
                                    </div>
                                    
                                    <div className="pl-10 space-y-1">
                                        <div className="text-sm text-charcoal font-medium flex items-center gap-2">
                                            <i className="fa-regular fa-clock text-slate-400 text-xs"></i> {res.dateTime}
                                        </div>
                                        {res.refNumber && <div className="text-xs font-mono text-slate-500 bg-white inline-block px-1 rounded border border-slate-100">REF: {res.refNumber}</div>}
                                        {res.notes && <div className="text-xs text-matcha mt-1"><i className="fa-solid fa-circle-info mr-1"></i>{res.notes}</div>}
                                    </div>
                                </div>
                            ))}
                            {reservations.length === 0 && <div className="text-center text-slate-300 text-sm py-4 border-2 border-dashed border-slate-100 rounded-xl">Â∞öÁÑ°È†êË®ÇÁ¥ÄÈåÑ</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const PackingListView = ({ items, onToggle, onAdd, onDelete }) => {
            const [newItemText, setNewItemText] = useState('');
            const safeItems = items || [];
            const grouped = safeItems.reduce((acc, item) => { if (!acc[item.category]) acc[item.category] = []; acc[item.category].push(item); return acc; }, {});
            const progress = safeItems.length > 0 ? Math.round((safeItems.filter(i => i.checked).length / safeItems.length) * 100) : 0;
            return (
                <div className="px-6 pb-32 pt-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-subtle mb-8">
                        <div className="flex justify-between items-end mb-2"><h2 className="text-lg font-bold text-charcoal">Ë°åÊùéÊ∏ÖÂñÆ</h2><span className="text-2xl font-mono font-bold text-matcha">{progress}%</span></div>
                        <div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-matcha transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div></div>
                    </div>
                    <form onSubmit={(e) => { e.preventDefault(); if (newItemText.trim()) { onAdd(newItemText, 'Ëá™Ë®Ç'); setNewItemText(''); } }} className="mb-8 relative">
                        <input type="text" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} placeholder="Êñ∞Â¢ûÁâ©ÂìÅ..." className="w-full bg-rice border border-subtle rounded-xl py-3 pl-4 pr-12 focus:border-matcha focus:bg-white transition-all outline-none" />
                        <button type="submit" className="absolute right-2 top-2 w-8 h-8 bg-matcha text-white rounded-lg flex items-center justify-center active:scale-95 transition-transform"><i className="fa-solid fa-plus text-xs"></i></button>
                    </form>
                    <div className="space-y-8">
                        {Object.entries(grouped).map(([category, groupItems]) => (
                            <div key={category}>
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3 pl-1">{category}</h3>
                                <div className="bg-white rounded-2xl overflow-hidden border border-subtle divide-y divide-subtle">
                                    {groupItems.map(item => (
                                        <div key={item.id} className="p-4 flex items-center group relative">
                                            <div className="flex-1 flex items-center cursor-pointer" onClick={() => onToggle(item.id)}>
                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center mr-4 transition-colors flex-shrink-0 ${item.checked ? 'bg-matcha border-matcha' : 'border-slate-300'}`}>{item.checked && <i className="fa-solid fa-check text-white text-xs"></i>}</div>
                                                <span className={`flex-1 font-medium transition-opacity ${item.checked ? 'text-slate-400 line-through opacity-70' : 'text-charcoal'}`}>{item.text}</span>
                                            </div>
                                            <button onClick={() => onDelete(item.id)} className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-400 transition-colors"><i className="fa-solid fa-trash-can"></i></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const MoneyView = ({ expenses, members, currencyRate, currentCurrency, onDelete }) => {
            const [currency, setLocalCurrency] = useState(currentCurrency);
            const getMemberName = (id) => MEMBERS.find(m => m.id === id)?.name || id;
            const getMemberIcon = (id) => MEMBERS.find(m => m.id === id)?.icon || '';
            const balances = {}; MEMBERS.forEach(m => balances[m.id] = 0);
            let totalSpentJPY = 0;

            if(expenses) {
                expenses.forEach(ex => {
                    const amountJPY = ex.currency === 'TWD' ? ex.amount / currencyRate : ex.amount;
                    totalSpentJPY += amountJPY;
                    balances[ex.payer] += amountJPY;
                    if (ex.mode === 'custom' && ex.details) {
                        Object.entries(ex.details).forEach(([uid, amt]) => { const debtJPY = ex.currency === 'TWD' ? amt / currencyRate : amt; balances[uid] -= debtJPY; });
                    } else {
                        const share = amountJPY / ex.involved.length;
                        ex.involved.forEach(pid => balances[pid] -= share);
                    }
                });
            }

            const displayMoney = (valJPY) => {
                if (currency === 'JPY') return `¬•${Math.round(valJPY).toLocaleString()}`;
                return `NT$${Math.round(valJPY * currencyRate).toLocaleString()}`;
            };

            return (
                <div className="px-6 pb-32 tracking-wide pt-6">
                    <div className="bg-charcoal text-white p-6 rounded-2xl shadow-lg mb-8 relative overflow-hidden">
                        <div className="absolute top-4 right-4 text-xs font-bold opacity-50 border border-white/30 rounded-full px-2 py-0.5 cursor-pointer" onClick={() => setLocalCurrency(c => c === 'JPY' ? 'TWD' : 'JPY')}>{currency}</div>
                        <div className="text-xs text-white/60 uppercase font-bold tracking-widest">Total Expenses</div>
                        <div className="text-4xl font-black mt-2 font-mono">{displayMoney(totalSpentJPY)}</div>
                        <div className="mt-6 pt-4 border-t border-white/10 flex gap-4 items-center">
                            <i className="fa-solid fa-calculator text-white/40"></i>
                            <input type="number" placeholder="JPY" className="bg-transparent w-20 text-sm font-mono placeholder-white/30 outline-none border-b border-white/20 focus:border-matcha" onChange={e => { const val = parseFloat(e.target.value); const target = e.target.nextElementSibling; if(val) target.innerText = `‚âà NT$${Math.round(val * currencyRate)}`; else target.innerText = ''; }} />
                            <span className="text-xs text-white/60 font-mono"></span>
                        </div>
                    </div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 px-1">Balances (ÁµêÁÆó)</h3>
                    <div className="grid grid-cols-2 gap-3 mb-10">
                        {MEMBERS.map(m => {
                            const bal = balances[m.id];
                            const isPos = bal >= 0;
                            return (
                                <div key={m.id} className={`rounded-xl p-3 flex items-center justify-between border ${isPos ? 'bg-[#f0f4ef] border-matcha/20' : 'bg-red-50 border-red-100'}`}>
                                    <div className="flex items-center gap-2"><span className="text-xl">{m.icon}</span><span className="text-xs font-bold text-charcoal">{m.name}</span></div>
                                    <div className="text-right"><div className={`font-bold text-sm font-mono ${isPos ? 'text-matcha' : 'text-red-400'}`}>{displayMoney(Math.abs(bal))}</div><div className={`text-[9px] opacity-70 ${isPos ? 'text-matcha' : 'text-red-400'}`}>{isPos ? 'Êî∂' : '‰ªò'}</div></div>
                                </div>
                            );
                        })}
                    </div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 px-1">History</h3>
                    <div className="bg-white rounded-2xl border border-subtle divide-y divide-subtle">
                        {(!expenses || expenses.length === 0) ? <div className="text-center text-slate-300 py-8 text-sm">Â∞öÁÑ°Á¥ÄÈåÑ</div> : 
                            [...expenses].reverse().map(ex => (
                                <div key={ex.id} className="p-4 flex justify-between items-center group">
                                    <div>
                                        <div className="font-bold text-charcoal">{ex.title}</div>
                                        <div className="text-xs text-slate-400 mt-1 flex items-center gap-1"><span>{getMemberIcon(ex.payer)} ‰ªòÊ¨æ</span><span className="text-slate-300">|</span>{ex.mode === 'custom' ? <span className="text-orange-400">Ëá™Ë®ÇÂàÜÂ∏≥</span> : <span>{ex.involved.length === MEMBERS.length ? 'ÂÖ®Âì°' : ex.involved.map(id => getMemberIcon(id)).join('')}</span>}</div>
                                    </div>
                                    <div className="text-right"><div className="font-bold text-charcoal font-mono">{ex.currency === 'TWD' ? 'NT$' : '¬•'}{ex.amount}</div><button onClick={() => onDelete(ex.id)} className="text-xs text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity p-1">Âà™Èô§</button></div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            );
        };

        // --- 5. MODAL COMPONENTS ---

        const ExpenseModal = ({ isOpen, onClose, onSave, members }) => {
            const [data, setData] = useState({ title: '', amount: '', currency: 'JPY', payer: members[0].id, involved: members.map(m => m.id), mode: 'equal', details: {} });
            useEffect(() => { if(data.mode === 'equal') { const eq = {}; data.involved.forEach(id => eq[id] = 0); setData(d => ({...d, details: eq})); } }, [data.involved.length]);
            if (!isOpen) return null;
            const totalAllocated = Object.values(data.details).reduce((a, b) => Number(a) + Number(b), 0);
            const remaining = Number(data.amount) - totalAllocated;
            const isCustomValid = data.mode === 'equal' || Math.abs(remaining) < 1;
            return (
                 <div className="fixed inset-0 z-[80]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-6 pb-safe shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-bold text-charcoal mb-4">Êñ∞Â¢ûÊîØÂá∫</h3>
                        <div className="space-y-4">
                            <input type="text" value={data.title} onChange={e => setData({...data, title: e.target.value})} placeholder="È†ÖÁõÆ (Â¶Ç: ÊôöÈ§ê)" className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" />
                            <div className="flex gap-2"><input type="number" value={data.amount} onChange={e => setData({...data, amount: e.target.value})} placeholder="Á∏ΩÈáëÈ°ç" className="flex-[2] bg-white p-3 rounded-xl border border-subtle outline-none font-mono text-lg font-bold" /><select value={data.currency} onChange={e => setData({...data, currency: e.target.value})} className="flex-1 bg-white p-3 rounded-xl border border-subtle outline-none font-bold text-center"><option value="JPY">JPY</option><option value="TWD">TWD</option></select></div>
                            <div><label className="text-xs font-bold text-slate-400 block mb-2">Ë™∞ÂÖà‰ªòÈå¢?</label><div className="flex gap-3 overflow-x-auto pb-2">{members.map(m => (<div key={m.id} onClick={() => setData({...data, payer: m.id})} className={`flex flex-col items-center gap-1 min-w-[50px] cursor-pointer transition-all ${data.payer === m.id ? 'opacity-100 scale-110' : 'opacity-50 grayscale'}`}><span className="text-2xl">{m.icon}</span><span className="text-[10px] font-bold">{m.name}</span></div>))}</div></div>
                            <div className="bg-white p-3 rounded-xl border border-subtle">
                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-slate-400">ÂàÜÊî§ÊñπÂºè</label><div className="flex bg-slate-100 rounded-lg p-1"><button onClick={() => setData({...data, mode: 'equal'})} className={`text-xs px-3 py-1 rounded-md font-bold transition-colors ${data.mode==='equal'?'bg-white shadow-sm text-matcha':'text-slate-400'}`}>Âπ≥Âùá</button><button onClick={() => setData({...data, mode: 'custom'})} className={`text-xs px-3 py-1 rounded-md font-bold transition-colors ${data.mode==='custom'?'bg-white shadow-sm text-matcha':'text-slate-400'}`}>Ëá™Ë®Ç</button></div></div>
                                {data.mode === 'equal' ? (<div className="flex flex-wrap gap-2">{members.map(m => (<div key={m.id} onClick={() => { const newInvolved = data.involved.includes(m.id) ? data.involved.filter(id => id !== m.id) : [...data.involved, m.id]; setData({...data, involved: newInvolved}); }} className={`px-3 py-1.5 rounded-lg text-xs font-bold border cursor-pointer transition-colors ${data.involved.includes(m.id) ? 'bg-matcha text-white border-matcha' : 'bg-white text-slate-500 border-subtle'}`}>{m.icon} {m.name}</div>))}</div>) : (<div className="space-y-2">{members.map(m => (<div key={m.id} className="flex items-center gap-2"><div className="w-8 text-xl text-center">{m.icon}</div><input type="number" placeholder="0" value={data.details[m.id] || ''} onChange={(e) => { const val = parseFloat(e.target.value) || 0; const newDetails = {...data.details, [m.id]: val}; const newInvolved = Object.keys(newDetails).filter(k => newDetails[k] > 0); setData({...data, details: newDetails, involved: newInvolved}); }} className="flex-1 bg-slate-50 border-b border-subtle py-1 px-2 text-sm font-mono outline-none focus:border-matcha" /></div>))}<div className={`text-right text-xs font-bold mt-2 ${remaining === 0 ? 'text-matcha' : 'text-red-400'}`}>{remaining === 0 ? 'ÈáëÈ°çÊ≠£Á¢∫' : `ÈÇÑÊúâ ${remaining} Êú™ÂàÜÈÖç`}</div></div>)}
                            </div>
                            <button onClick={() => { if(!data.title || !data.amount || data.involved.length === 0 || !isCustomValid) return; onSave(data); }} disabled={!isCustomValid} className={`w-full text-white font-bold py-3.5 rounded-2xl shadow-lg mt-2 transition-opacity ${isCustomValid ? 'bg-matcha' : 'bg-slate-300'}`}>ÂÑ≤Â≠ò</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DetailModal = ({ event, onClose, onEdit }) => {
            if (!event) return null;
            return (
                <div className="fixed inset-0 z-[60]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-white rounded-t-[24px] overflow-hidden shadow-2xl max-h-[92vh] overflow-y-auto animate-slide-up">
                        <div className="relative h-72">
                            <img src={event.image || 'https://placehold.co/600x400/eceae6/a0a09e?text=NO+IMAGE'} className="w-full h-full object-cover" alt={event.title} onError={(e) => (e.target.src = 'https://placehold.co/600x400/eceae6/a0a09e?text=NO+IMAGE')} />
                            <div className="absolute inset-0 bg-gradient-to-t from-charcoal/80 via-charcoal/20 to-transparent"></div>
                            <button onClick={onClose} className="absolute top-5 right-5 bg-black/20 text-white/90 rounded-full w-8 h-8 flex items-center justify-center backdrop-blur-md active:bg-black/40 transition-colors"><i className="fa-solid fa-xmark"></i></button>
                            <div className="absolute bottom-6 left-6 text-white pr-4"><span className="text-[10px] font-bold px-2 py-1 bg-white/20 backdrop-blur-md rounded mb-3 inline-block tracking-wider uppercase">{event.type}</span><h2 className="text-3xl font-bold leading-tight tracking-wide drop-shadow-md">{event.title}</h2><p className="text-sm opacity-90 mt-2 font-medium flex items-center"><i className="fa-solid fa-location-dot mr-1.5 text-xs"></i>{event.loc || 'Êú™Áü•Âú∞Èªû'}</p></div>
                            <button onClick={onEdit} className="absolute -bottom-6 right-6 bg-matcha text-white rounded-2xl w-12 h-12 flex items-center justify-center shadow-lg active:scale-95 transition-transform z-20"><i className="fa-solid fa-pen"></i></button>
                        </div>
                        <div className="p-8 pt-12 pb-28 space-y-6 bg-rice">
                            {event.subItems && event.subItems.length > 0 && (<div className="mb-6"><h4 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-widest">ÂøÖÂÅöÊ∏ÖÂñÆ</h4><div className="space-y-2">{event.subItems.map(item => (<div key={item.id} className="flex items-center gap-3 bg-white p-3 rounded-xl border border-subtle"><div className={`w-5 h-5 rounded flex items-center justify-center text-[10px] ${item.checked ? 'bg-matcha text-white' : 'bg-slate-100 text-slate-400'}`}>{item.checked && <i className="fa-solid fa-check"></i>}</div><span className={`text-sm ${item.checked ? 'line-through text-slate-400' : 'text-charcoal'}`}>{item.type === 'buy' ? 'üõçÔ∏è' : item.type === 'eat' ? 'üç¥' : '‚ú®'} {item.text}</span></div>))}</div></div>)}
                            {event.tags && (<div className="flex flex-wrap gap-2">{event.tags.map(tag => (<span key={tag} className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold tracking-wider">#{tag}</span>))}</div>)}
                            <div className="text-charcoal leading-relaxed tracking-wide"><h4 className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">ÈóúÊñº</h4><p className="whitespace-pre-line">{event.desc || 'Êö´ÁÑ°Ë©≥Á¥∞ÊèèËø∞„ÄÇ'}</p></div>
                            {event.note && (<div className="bg-[#f4f1e8] p-4 rounded-xl border-l-2 border-matcha"><p className="text-xs font-bold text-matcha uppercase mb-1 tracking-widest">TIPS</p><p className="text-sm text-charcoal/80">{event.note}</p></div>)}
                            <div className="flex gap-4 pt-4"><a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((event.loc || '') + ' ' + event.title)}`} target="_blank" className="flex-1 border border-subtle text-charcoal py-3.5 rounded-2xl font-bold text-center active:bg-slate-50 transition-colors text-sm tracking-wider">Â∞éËà™</a><a href={`https://www.google.com/search?q=${encodeURIComponent(event.title)}`} target="_blank" className="flex-1 bg-charcoal text-white py-3.5 rounded-2xl font-bold text-center active:bg-charcoal/90 transition-colors text-sm tracking-wider">ÊêúÂ∞ã</a></div>
                        </div>
                    </div>
                </div>
            );
        };

        const EventModal = ({ isOpen, initialData, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ time: '09:00', type: 'sight', title: '', loc: '', image: '', desc: '', subItems: [] });
            const [newSub, setNewSub] = useState({ text: '', type: 'buy' });
            useEffect(() => { if (isOpen) setFormData(initialData || { time: '09:00', type: 'sight', title: '', loc: '', image: '', desc: '', subItems: [] }); }, [isOpen, initialData]);
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { const img = new Image(); img.src = reader.result; img.onload = () => { const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7); setFormData({...formData, image: compressedBase64}); } };
                    reader.readAsDataURL(file);
                }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl transform transition-transform duration-300 h-[90vh] flex flex-col animate-slide-up">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-8 tracking-wide">{initialData ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã'}</h3>
                        <div className="space-y-6 flex-1 overflow-y-auto hide-scrollbar">
                            <div className="flex gap-4"><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÊôÇÈñì</label><input type="time" value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 font-mono text-lg focus:border-matcha outline-none transition-colors" /></div><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">È°ûÂûã</label><select value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-lg focus:border-matcha outline-none"><option value="sight">üì∑ ÊôØÈªû</option><option value="food">üçú ÁæéÈ£ü</option><option value="transport">üöÖ ‰∫§ÈÄö</option><option value="hotel">üè® ‰ΩèÂÆø</option></select></div></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Ê®ôÈ°å</label><input type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="Ë´ãËº∏ÂÖ•Ê®ôÈ°å" className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Âú∞Èªû</label><input type="text" value={formData.loc} onChange={e => setFormData({...formData, loc: e.target.value})} placeholder="‰æãÂ¶ÇÔºöÊ∑∫Ëçâ" className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÂúñÁâá</label><div className="flex items-center gap-4">{formData.image && <img src={formData.image} className="w-16 h-16 rounded-lg object-cover bg-slate-100" />}<label className="bg-slate-100 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold cursor-pointer hover:bg-slate-200 transition-colors"><i className="fa-solid fa-camera mr-2"></i>‰∏äÂÇ≥ÁÖßÁâá<input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" /></label></div></div>
                            <div className="bg-white p-4 rounded-xl border border-subtle"><div className="flex gap-2 mb-2"><select value={newSub.type} onChange={e => setNewSub({...newSub, type: e.target.value})} className="bg-slate-100 rounded text-xs p-2"><option value="buy">üõçÔ∏è</option><option value="eat">üç¥</option><option value="do">‚ú®</option></select><input type="text" value={newSub.text} onChange={e => setNewSub({...newSub, text: e.target.value})} placeholder="Êñ∞Â¢ûÈ†ÖÁõÆ" className="flex-1 bg-slate-50 border-b border-subtle px-2 text-sm" /><button onClick={() => { if(newSub.text){ setFormData(p => ({...p, subItems: [...(p.subItems||[]), {id: generateId(), ...newSub, checked: false}]})); setNewSub(p => ({...p, text: ''})); }}} className="text-matcha font-bold">+</button></div>{formData.subItems?.map(i => <div key={i.id} className="flex justify-between text-sm bg-slate-50 p-2 rounded mb-1"><span>{i.type==='buy'?'üõçÔ∏è':i.type==='eat'?'üç¥':'‚ú®'} {i.text}</span><button onClick={() => setFormData(p => ({...p, subItems: p.subItems.filter(x => x.id !== i.id)}))} className="text-red-400">x</button></div>)}</div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÊèèËø∞</label><textarea value={formData.desc || ''} onChange={e => setFormData({...formData, desc: e.target.value})} rows={3} placeholder="ÂØ´Èªû‰ªÄÈ∫º..." className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none" /></div>
                        </div>
                        <div className="mt-8 flex gap-4">{initialData && onDelete && <button type="button" onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle">Âà™Èô§</button>}<button type="button" onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl shadow-lg">ÂÑ≤Â≠ò</button></div>
                    </div>
                </div>
            );
        };

        const TransportModal = ({ isOpen, initialData, onClose, onSave }) => {
            const [formData, setFormData] = useState({ mode: 'train', duration: '10m', note: '', url: '' });
            useEffect(() => { if (isOpen) setFormData(initialData || { mode: 'train', duration: '15m', note: '', url: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[75]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-6 pb-safe shadow-2xl animate-slide-up">
                        <h3 className="text-lg font-bold text-charcoal mb-6">‰∫§ÈÄöÊñπÂºè</h3>
                        <div className="space-y-4">
                            <div className="flex gap-4"><div className="flex-1"><label className="text-xs font-bold text-slate-400 block mb-1">ÊñπÂºè</label><select value={formData.mode} onChange={e => setFormData({...formData, mode: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none"><option value="train">ÈõªËªä/Âú∞Èêµ</option><option value="walk">Ê≠•Ë°å</option><option value="taxi">Ë®àÁ®ãËªä</option><option value="bus">Â∑¥Â£´</option><option value="other">ÂÖ∂‰ªñ</option></select></div><div className="flex-1"><label className="text-xs font-bold text-slate-400 block mb-1">È†ê‰º∞ÊôÇÈñì</label><input type="text" value={formData.duration} onChange={e => setFormData({...formData, duration: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" placeholder="ex: 15m" /></div></div>
                            <div><label className="text-xs font-bold text-slate-400 block mb-1">Ë™™Êòé</label><input type="text" value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" placeholder="ex: Â±±ÊâãÁ∑ö (Â§ñÂõû)" /></div>
                            <div><label className="text-xs font-bold text-slate-400 block mb-1">ÈÄ£Áµê</label><input type="text" value={formData.url || ''} onChange={e => setFormData({...formData, url: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" placeholder="https://maps..." /></div>
                            <div className="flex gap-3 pt-2">{formData.url && <a href={formData.url} target="_blank" className="flex-1 border border-subtle text-slate-500 py-3 rounded-xl font-bold text-center">ÈñãÂïüÂú∞Âúñ</a>}<button onClick={() => onSave(undefined)} className="flex-1 text-red-400 border border-red-100 py-3 rounded-xl font-bold">Ê∏ÖÈô§</button><button onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white py-3 rounded-xl font-bold shadow-lg">ÂÑ≤Â≠ò</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ReservationModal = ({ isOpen, initialData, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ type: 'ticket', name: '', status: 'pending', dateTime: '', refNumber: '', notes: '', url: '' });
            useEffect(() => { if (isOpen) setFormData(initialData || { type: 'ticket', name: '', status: 'pending', dateTime: '', refNumber: '', notes: '', url: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl transform transition-transform duration-300 max-h-[90vh] flex flex-col overflow-y-auto animate-slide-up">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8 flex-shrink-0"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-6">{initialData ? 'Á∑®ËºØÈ†êË®Ç' : 'Êñ∞Â¢ûÈ†êË®Ç'}</h3>
                        <div className="space-y-6">
                            <div className="flex gap-4">
                                <div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">È°ûÂûã</label><select value={formData.type} onChange={(e) => setFormData({...formData, type: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none"><option value="flight">‚úàÔ∏è Ëà™Áè≠</option><option value="hotel">üè® ‰ΩèÂÆø</option><option value="restaurant">üçΩÔ∏è È§êÂª≥</option><option value="ticket">üé´ Á•®Âà∏</option></select></div>
                                <div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÁãÄÊÖã</label><select value={formData.status} onChange={(e) => setFormData({...formData, status: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none"><option value="booked">‚úÖ Â∑≤È†êË®Ç</option><option value="pending">‚è≥ ËôïÁêÜ‰∏≠</option><option value="to-book">‚ö†Ô∏è ÂæÖÈ†êË®Ç</option></select></div>
                            </div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÂêçÁ®±</label><input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} placeholder="‰æãÂ¶ÇÔºöSkyliner ËªäÁ•®" className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÊôÇÈñì</label><input type="text" value={formData.dateTime} onChange={(e) => setFormData({...formData, dateTime: e.target.value})} placeholder="‰æãÂ¶ÇÔºö1/28 14:00" className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Á∑®Ëôü</label><input type="text" value={formData.refNumber || ''} onChange={(e) => setFormData({...formData, refNumber: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base font-mono focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÂÇôË®ª</label><textarea value={formData.notes || ''} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none" /></div>
                        </div>
                        <div className="mt-8 flex gap-4">{initialData && onDelete && <button onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle">Âà™Èô§</button>}<button onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl shadow-lg">ÂÑ≤Â≠ò</button></div>
                    </div>
                </div>
            );
        };

        const MealModal = ({ isOpen, initialData, type, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ name: '', dish: '', priceLevel: '', note: '', url: '', locationUrl: '' });
            useEffect(() => { if(isOpen) setFormData(initialData || { name: '', dish: '', priceLevel: '', note: '', url: '', locationUrl: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            const typeLabel = type === 'breakfast' ? 'Êó©È§ê' : type === 'lunch' ? 'ÂçàÈ§ê' : 'ÊôöÈ§ê';
            return (
                <div className="fixed inset-0 z-[80]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-6 tracking-wide">{initialData ? 'Á∑®ËºØ' : 'Êñ∞Â¢û'} {typeLabel}</h3>
                        <div className="space-y-6">
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">È§êÂª≥ÂêçÁ®±</label><input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div className="flex gap-4"><div className="flex-[2]"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Êé®Ëñ¶È§êÈªû</label><input type="text" value={formData.dish} onChange={(e) => setFormData({...formData, dish: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÂÉπ‰Ωç</label><input type="text" value={formData.priceLevel} onChange={(e) => setFormData({...formData, priceLevel: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base font-mono focus:border-matcha outline-none" /></div></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÈÄ£Áµê</label><input type="text" value={formData.url || ''} onChange={(e) => setFormData({...formData, url: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Á≠ÜË®ò</label><textarea value={formData.note || ''} onChange={(e) => setFormData({...formData, note: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none" /></div>
                        </div>
                        <div className="mt-8 flex gap-4">{initialData && onDelete && <button onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle">Âà™Èô§</button>}<button onClick={() => onSave({id: initialData?.id || generateId(), ...formData})} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl shadow-lg">ÂÑ≤Â≠ò</button></div>
                    </div>
                </div>
            );
        };

        // --- 6. APP COMPONENT ---

        const App = () => {
            const [view, setView] = useState('itinerary');
            const [data, setData] = useState(DEFAULT_DATA);
            const [currentDayIdx, setCurrentDayIdx] = useState(0);
            const [liveWeather, setLiveWeather] = useState(null);
            
            const [detailEvent, setDetailEvent] = useState(null);
            const [editingEvent, setEditingEvent] = useState(null);
            const [editingTransport, setEditingTransport] = useState(null);
            const [editingMeal, setEditingMeal] = useState(null);
            const [editingReservation, setEditingReservation] = useState(null);
            const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);

            useEffect(() => {
                if (!window.db) return;
                const dataRef = window.dbRef(window.db, 'tripData');
                const unsubscribe = window.dbOnValue(dataRef, (snapshot) => {
                    const val = snapshot.val();
                    if (val && val.days && val.days.length > 0 && val.version === DATA_VERSION) {
                        const safeData = { ...DEFAULT_DATA, ...val };
                        if(safeData.days) {
                            safeData.days.forEach(d => {
                                if (!d.mealOptions) d.mealOptions = { breakfast: [], lunch: [], dinner: [] };
                                // Ensure all meal arrays exist to prevent crashes
                                if (!d.mealOptions.breakfast) d.mealOptions.breakfast = [];
                                if (!d.mealOptions.lunch) d.mealOptions.lunch = [];
                                if (!d.mealOptions.dinner) d.mealOptions.dinner = [];
                                
                                if (!d.events) d.events = [];
                                d.events.forEach(e => { if (!e.subItems) e.subItems = []; });
                            });
                        }
                        if(!safeData.expenses) safeData.expenses = [];
                        if(!safeData.reservations) safeData.reservations = [];
                        if(!safeData.packingList) safeData.packingList = [];
                        setData(safeData);
                    } else {
                        // FORCE RESET if remote is empty or version mismatch
                        console.log("Remote data invalid or old version, resetting to default...");
                        window.dbSet(dataRef, DEFAULT_DATA);
                        setData(DEFAULT_DATA);
                    }
                });
                return () => unsubscribe();
            }, []);

            const syncData = (newData) => {
                setData(newData);
                if (window.db) { window.dbSet(window.dbRef(window.db, 'tripData'), newData); }
            };

            const handleSaveEvent = (eData) => {
                const newData = {...data};
                if(editingEvent.eventId) {
                    const list = newData.days[editingEvent.dayIdx].events;
                    const idx = list.findIndex(e => e.id === editingEvent.eventId);
                    if(idx >= 0) list[idx] = {...list[idx], ...eData};
                } else {
                    newData.days[editingEvent.dayIdx].events.push({id: generateId(), ...eData});
                    newData.days[editingEvent.dayIdx].events.sort((a,b)=>a.time.localeCompare(b.time));
                }
                syncData(newData); setEditingEvent(null);
            };
            const handleDeleteEvent = () => {
                 const newData = {...data};
                 newData.days[editingEvent.dayIdx].events = newData.days[editingEvent.dayIdx].events.filter(e => e.id !== editingEvent.eventId);
                 syncData(newData); setEditingEvent(null);
            };
            const handleSaveExpense = (exData) => {
                const newData = {...data};
                newData.expenses.push({ id: generateId(), ...exData, date: new Date().toISOString() });
                syncData(newData); setIsExpenseModalOpen(false);
            };

            const getWeatherIcon = (code) => {
                if (code === 0) return 'fa-sun';
                if (code >= 1 && code <= 3) return 'fa-cloud-sun';
                if (code >= 45 && code <= 48) return 'fa-smog';
                if (code >= 51 && code <= 67) return 'fa-cloud-rain';
                if (code >= 71 && code <= 77) return 'fa-snowflake';
                if (code >= 95) return 'fa-bolt';
                return 'fa-cloud';
            };

            return (
                <div className="min-h-screen bg-rice font-sans text-charcoal">
                    <header className="fixed top-0 w-full z-40 bg-rice/95 backdrop-blur-md transition-all duration-300 pt-safe border-b border-subtle">
                        <div className="flex justify-between items-end px-6 py-4 pb-3">
                            <div><p className="text-xs text-slate-400 font-medium tracking-widest uppercase mb-1">Tokyo Trip</p><h1 className="text-2xl font-bold tracking-wide text-charcoal">Êù±‰∫¨‰∏ÉÊó•</h1></div>
                        </div>
                    </header>
                    <main className="pt-24 max-w-lg mx-auto">
                        {view === 'itinerary' && <ItineraryView days={data.days} currentDayIdx={currentDayIdx} onDaySelect={setCurrentDayIdx} onEventClick={(d,e) => setDetailEvent({dayIdx:d, event:e})} onTransportClick={(d,id) => setEditingTransport({dayIdx:d, eventId:id})} onAddEvent={(d) => setEditingEvent({dayIdx:d})} onAddMeal={(d,t) => setEditingMeal({dayIdx:d, type:t})} onEditMeal={(d,t,o) => setEditingMeal({dayIdx:d, type:t, option:o})} />}
                        {view === 'info' && <InfoView reservations={data.reservations} onEdit={(r) => setEditingReservation({id:r.id, initial:r})} onAdd={() => setEditingReservation({})} />}
                        {view === 'money' && (
                            <>
                                <MoneyView expenses={data.expenses} members={MEMBERS.map(m=>m.id)} currencyRate={data.currencyRate} currentCurrency="JPY" onDelete={(id) => syncData({...data, expenses: data.expenses.filter(e => e.id !== id)})} />
                                <ExpenseModal isOpen={isExpenseModalOpen} onClose={() => setIsExpenseModalOpen(false)} members={MEMBERS} onSave={handleSaveExpense} />
                            </>
                        )}
                        {view === 'packing' && <PackingListView items={data.packingList} onToggle={(id) => {const n={...data}; n.packingList.find(i=>i.id===id).checked = !n.packingList.find(i=>i.id===id).checked; syncData(n)}} onAdd={(t,c) => {const n={...data}; n.packingList.push({id:generateId(), text:t, category:c, checked:false}); syncData(n)}} onDelete={(id) => {const n={...data}; n.packingList = n.packingList.filter(i=>i.id!==id); syncData(n)}} />}
                    </main>
                    <nav className="fixed bottom-0 w-full bg-rice/95 backdrop-blur-md border-t border-subtle pb-safe z-30 max-w-lg mx-auto left-0 right-0">
                        <div className="flex justify-around items-center h-[60px]">
                            <button onClick={() => setView('itinerary')} className={`flex-1 flex flex-col items-center justify-center h-full ${view==='itinerary'?'text-matcha':'text-slate-400'}`}><i className="fa-solid fa-map text-xl"></i><span className="text-[9px] font-bold">Ë°åÁ®ã</span></button>
                            <button onClick={() => setView('packing')} className={`flex-1 flex flex-col items-center justify-center h-full ${view==='packing'?'text-matcha':'text-slate-400'}`}><i className="fa-solid fa-suitcase text-xl"></i><span className="text-[9px] font-bold">Ë°åÊùé</span></button>
                            <button onClick={() => setView('info')} className={`flex-1 flex flex-col items-center justify-center h-full ${view==='info'?'text-matcha':'text-slate-400'}`}><i className="fa-solid fa-book text-xl"></i><span className="text-[9px] font-bold">Ë≥áË®ä</span></button>
                            <button onClick={() => setView('money')} className={`flex-1 flex flex-col items-center justify-center h-full ${view==='money'?'text-matcha':'text-slate-400'}`}><i className="fa-solid fa-coins text-xl"></i><span className="text-[9px] font-bold">ÂàÜÂ∏≥</span></button>
                        </div>
                    </nav>
                    {view === 'itinerary' && <button onClick={() => setEditingEvent({dayIdx: currentDayIdx})} className="fixed bottom-24 right-6 w-14 h-14 rounded-2xl bg-matcha shadow-xl shadow-matcha/40 flex items-center justify-center text-white z-40 active:scale-90 transition-transform"><i className="fa-solid fa-plus text-xl"></i></button>}
                    {view === 'money' && <button onClick={() => setIsExpenseModalOpen(true)} className="fixed bottom-24 right-6 w-14 h-14 rounded-2xl bg-matcha shadow-xl shadow-matcha/40 flex items-center justify-center text-white z-40 active:scale-90 transition-transform"><i className="fa-solid fa-plus text-xl"></i></button>}
                    
                    <EventModal isOpen={!!editingEvent} initialData={editingEvent?.eventId ? data.days[editingEvent.dayIdx].events.find(e => e.id === editingEvent.eventId) : undefined} onClose={() => setEditingEvent(null)} onSave={handleSaveEvent} onDelete={editingEvent?.eventId ? handleDeleteEvent : undefined} />
                    <DetailModal event={detailEvent ? detailEvent.event : null} onClose={() => setDetailEvent(null)} onEdit={() => { setEditingEvent({dayIdx: detailEvent.dayIdx, eventId: detailEvent.event.id}); setDetailEvent(null); }} />
                    <TransportModal isOpen={!!editingTransport} initialData={editingTransport ? data.days[editingTransport.dayIdx].events.find(e => e.id === editingTransport.eventId)?.transitToNext : undefined} onClose={() => setEditingTransport(null)} onSave={(td) => { const n={...data}; n.days[editingTransport.dayIdx].events.find(e => e.id === editingTransport.eventId).transitToNext = td; syncData(n); setEditingTransport(null); }} />
                    <MealModal isOpen={!!editingMeal} type={editingMeal?.type} initialData={editingMeal?.option} onClose={() => setEditingMeal(null)} onSave={(o) => { const n={...data}; const list = n.days[editingMeal.dayIdx].mealOptions[editingMeal.type]; if(editingMeal.option) { list[list.findIndex(x=>x.id===o.id)] = o; } else { list.push(o); } syncData(n); setEditingMeal(null); }} onDelete={() => { const n={...data}; n.days[editingMeal.dayIdx].mealOptions[editingMeal.type] = n.days[editingMeal.dayIdx].mealOptions[editingMeal.type].filter(x=>x.id!==editingMeal.option.id); syncData(n); setEditingMeal(null); }} />
                    <ReservationModal isOpen={!!editingReservation} initialData={editingReservation?.initial} onClose={() => setEditingReservation(null)} onSave={(r) => { const n={...data}; if(editingReservation.id) { const idx = n.reservations.findIndex(x=>x.id===editingReservation.id); n.reservations[idx] = {...n.reservations[idx], ...r}; } else { n.reservations.push({id: generateId(), ...r}); } syncData(n); setEditingReservation(null); }} onDelete={() => { const n={...data}; n.reservations = n.reservations.filter(x=>x.id!==editingReservation.id); syncData(n); setEditingReservation(null); }} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>