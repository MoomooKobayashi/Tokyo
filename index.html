<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Êù±‰∫¨‰∏ÉÊó•Ë°å 2026</title>
    
    <!-- PWA / Home Screen Settings -->
    <meta name="theme-color" content="#fcfaf7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tokyo Trip">
    
    <!-- Icon: Local Icons -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rice: '#fcfaf7',
                        charcoal: '#3e3a39',
                        matcha: '#6a7f60',
                        'matcha-light': '#8da583',
                        subtle: '#eceae6'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'Noto Sans JP', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            'from': { transform: 'translateY(100%)' },
                            'to': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #fcfaf7;
            color: #3e3a39;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            user-select: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "sweetalert2": "https://aistudiocdn.com/sweetalert2@^11.26.3"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useEffect, useRef } = React;

        // --- UTILS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- CONSTANTS ---
        const LOCATIONS = {
            tokyo: { lat: 35.6895, lon: 139.6917, name: 'Êù±‰∫¨' },
            yokohama: { lat: 35.4437, lon: 139.6380, name: 'Ê©´Êø±' },
            kamakura: { lat: 35.3192, lon: 139.5467, name: 'ÈéåÂÄâ' },
            kawagoe: { lat: 35.9251, lon: 139.4858, name: 'Â∑ùË∂ä' },
            nikko: { lat: 36.7199, lon: 139.6982, name: 'Êó•ÂÖâ' }
        };

        const INITIAL_PACKING_LIST = [
            { id: generateId(), category: 'Ë≠â‰ª∂/Èå¢ÂåÖ', text: 'Ë≠∑ÁÖß (ÊïàÊúü6ÂÄãÊúà‰ª•‰∏ä)', checked: false },
            { id: generateId(), category: 'Ë≠â‰ª∂/Èå¢ÂåÖ', text: 'Êó•Âπ£ÁèæÈáë', checked: false },
            { id: generateId(), category: 'Ë≠â‰ª∂/Èå¢ÂåÖ', text: '‰ø°Áî®Âç° (Êµ∑Â§ñÂõûÈ•ãÈ´ò)', checked: false },
            { id: generateId(), category: 'Ë≠â‰ª∂/Èå¢ÂåÖ', text: 'Visit Japan Web QR Code Êà™Âúñ', checked: false },
            { id: generateId(), category: 'ÈõªÂ≠êÁî¢ÂìÅ', text: 'ÊâãÊ©ü & ÂÖÖÈõªÁ∑ö', checked: false },
            { id: generateId(), category: 'ÈõªÂ≠êÁî¢ÂìÅ', text: 'Ë°åÂãïÈõªÊ∫ê', checked: false },
            { id: generateId(), category: 'ÈõªÂ≠êÁî¢ÂìÅ', text: 'Á∂≤Âç°/Êº´ÈÅäÈñãÈÄö', checked: false },
            { id: generateId(), category: 'Ë°£Áâ©', text: '‰øùÊöñÂ§ñÂ•ó (1-2ÊúàÂùáÊ∫´5Â∫¶)', checked: false },
            { id: generateId(), category: 'Ë°£Áâ©', text: 'Â•ΩËµ∞ÁöÑÈûã', checked: false },
            { id: generateId(), category: 'ÁîüÊ¥ªÁî®ÂìÅ', text: 'Â∏∏ÂÇôËó•ÂìÅ (ÊÑüÂÜí/ËÉÉËó•/OKÁπÉ)', checked: false },
            { id: generateId(), category: 'ÁîüÊ¥ªÁî®ÂìÅ', text: 'ÊäòÁñäÂÇò', checked: false },
        ];

        const DEFAULT_DATA = {
            currencyRate: 0.215,
            members: ["Êàë", "ÊóÖ‰º¥A", "ÊóÖ‰º¥B"],
            expenses: [],
            packingList: INITIAL_PACKING_LIST,
            reservations: [
                { id: generateId(), type: 'flight', name: 'ÂéªÁ®ã BR198', status: 'booked', dateTime: '1/28 08:50', refNumber: '6F3X9A', notes: 'Ê°ÉÂúí T2 -> ÊàêÁî∞ T1', url: '' },
                { id: generateId(), type: 'flight', name: 'ÂõûÁ®ã BR197', status: 'booked', dateTime: '2/3 13:00', refNumber: '6F3X9A', notes: 'ÊàêÁî∞ T1 -> Ê°ÉÂúí T2', url: '' },
                { id: generateId(), type: 'hotel', name: 'Dormy Inn Kawasaki', status: 'booked', dateTime: '1/28 - 1/30', notes: 'Á•ûÂ•àÂ∑ùÁúåÂ∑ùÂ¥éÂ∏ÇÂ∑ùÂ¥éÂå∫Êù±Áî∞Áî∫9-3 (+81-44-230-5489)', url: 'https://www.google.com/maps/search/?api=1&query=Dormy+Inn+Kawasaki' },
                { id: generateId(), type: 'hotel', name: 'Êù±Ê©´INN Ê∑∫ËçâËóèÂâç2ËôüÂ∫ó', status: 'booked', dateTime: '1/30 - 2/3', notes: 'Êù±‰∫¨ÈÉΩÂè∞Êù±Âå∫ËîµÂâç3-15-5 (+81-3-5821-1045)', url: 'https://www.google.com/maps/search/?api=1&query=Toyoko+Inn+Asakusa+Kuramae' },
            ],
            days: [
                {
                    date: "1/28", weekday: "ÈÄ±‰∏â",
                    title: "ÊäµÈÅîËàáÊ©´Êø±Ê∏ØÂ§úÊôØ",
                    weather: "Êô¥ÊôÇÂ§öÈõ≤ 4-11¬∞C",
                    locationKey: "yokohama",
                    imageUrl: "yokohama.jpg",
                    mealOptions: {
                        breakfast: [
                            { id: generateId(), name: "Ê©üÂ†¥Ë≤¥Ë≥ìÂÆ§/‰æøÂà©ÂïÜÂ∫ó", dish: "È£ØÁ≥∞/‰∏âÊòéÊ≤ª", priceLevel: "¬•500", url: "", locationUrl: "", note: "Âø´ÈÄüËß£Ê±∫" }
                        ],
                        lunch: [
                            { id: generateId(), name: "Skyliner ‰æøÁï∂", dish: "ÁÇ∏Ë±¨Êéí‰∏âÊòéÊ≤ª", priceLevel: "¬•1000", url: "", locationUrl: "", note: "Ëªä‰∏ä‰∫´Áî®" }
                        ],
                        dinner: [
                            { id: generateId(), name: "Lazona Â∑ùÂ¥éÂª£Â†¥", dish: "ÈáëÂ≠êÂçä‰πãÂä©/Âà©‰πÖÁâõËàå", priceLevel: "¬•1500~", url: "https://www.google.com/search?q=Lazona+Kawasaki+Restaurants", locationUrl: "https://maps.google.com/?q=Lazona+Kawasaki", note: "Â∑ùÂ¥éÁ´ôÁõ¥ÁµêÔºåÈÅ∏ÊìáÊ•µÂ§ö" },
                            { id: generateId(), name: "Bills Á¥ÖÁ£öÂÄâÂ∫´", dish: "RicottaÈ¨ÜÈ§Ö", priceLevel: "¬•2500", url: "https://billsjapan.com/jp/Ê®™ÊµúËµ§„É¨„É≥„Ç¨ÂÄâÂ∫´", locationUrl: "https://maps.google.com/?q=Bills+Yokohama+Red+Brick", note: "Ê∞£Ê∞õ‰Ω≥ÔºåÈúÄÈ†êÁ¥Ñ" },
                            { id: generateId(), name: "Afuri ÊãâÈ∫µ", dish: "ÊüöÂ≠êÈπΩÊãâÈ∫µ", priceLevel: "¬•1200", url: "https://afuri.com/", locationUrl: "https://maps.google.com/?q=Afuri+Yokohama+Landmark", note: "Ê©´Êø±Âú∞Ê®ôÂ°îÂ∫óÔºåÊ∏ÖÁàΩÁ≥ª" }
                        ]
                    },
                    events: [
                        { 
                            id: generateId(), time: "08:50", type: "transport", title: "Ëµ∑È£õ BR198", loc: "Ê°ÉÂúíÊ©üÂ†¥ T1", image: "airport.jpg", note: "06:30 ÈõÜÂêà", 
                            subItems: [{id: generateId(), type: 'do', text: 'È†òÂèñWifiÊ©ü', checked: false}, {id: generateId(), type: 'buy', text: 'ÂÖçÁ®ÖÂåñÂ¶ùÂìÅ', checked: false}],
                            transitToNext: { mode: 'other', duration: '3h 30m', note: 'È£õË°åÊôÇÈñì' } 
                        },
                        { 
                            id: generateId(), time: "12:55", type: "transport", title: "ÊäµÈÅî", loc: "ÊàêÁî∞Ê©üÂ†¥ T1", image: "narita.jpg", note: "È†òÂèñ Skyliner, Suica",
                            subItems: [{id: generateId(), type: 'buy', text: 'SuicaÂç° (ÂÑ≤ÂÄº¬•3000)', checked: false}],
                            transitToNext: { mode: 'train', duration: '50m', note: 'Skyliner (ÊàêÁî∞->‰∫¨Êàê‰∏äÈáé)' }
                        },
                        { 
                            id: generateId(), time: "14:00", type: "transport", title: "ÁßªÂãïÔºöÊàêÁî∞‚ÜíÂ∑ùÂ¥é", loc: "Skyliner", image: "skyliner.jpg", note: "ËΩâ JR ‰∏äÈáéÊù±‰∫¨Á∑ö",
                            transitToNext: { mode: 'train', duration: '40m', note: 'JR ‰∏äÈáéÊù±‰∫¨Á∑ö (‰∏äÈáé->Â∑ùÂ¥é)' }
                        },
                        { 
                            id: generateId(), time: "16:00", type: "hotel", title: "Check-in", loc: "Dormy Inn", image: "kawasaki_inn.jpg", note: "‰∫´ÂèóËøéË≥ìÂíñÂï°",
                            subItems: [{id: generateId(), type: 'do', text: 'Á¢∫Ë™çÊ∫´Ê≥âÈñãÊîæÊôÇÈñì', checked: false}],
                            transitToNext: { mode: 'train', duration: '20m', note: 'JR‰∫¨Êø±Êù±ÂåóÁ∑ö (Â∑ùÂ¥é->Ê´ªÊú®Áî∫)' }
                        },
                        { 
                            id: generateId(), time: "17:30", type: "sight", title: "Á¥ÖÁ£öÂÄâÂ∫´ÂÖ¨Âúí", loc: "Ê©´Êø±", image: "yo.jpg", tags: ["ÂøÖÊãç:Â§úÊôØ"], desc: "ÂÖÖÊªøÁï∞ÂúãÊÉÖË™øÁöÑÊ≠∑Âè≤ÂÄâÂ∫´Áæ§ÔºåÈÅ©ÂêàÊï£Ê≠•ÊãçÁÖß„ÄÇ",
                            subItems: [{id: generateId(), type: 'buy', text: 'Ê©´Êø±ÁÑ¶Á≥ñÁâõÂ•∂Á≥ñ', checked: false}, {id: generateId(), type: 'eat', text: 'Â¥éÈôΩËªíÁáíË≥£', checked: false}],
                            transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°åËá≥ÈÅãÊ≤≥ÂÖ¨ÂúíÁ´ô' }
                        },
                        { 
                            id: generateId(), time: "20:30", type: "sight", title: "Ê©´Êø±Á©∫‰∏≠Á∫úËªä", loc: "Ê´ªÊú®Áî∫Á´ô", image: "air_cabin.jpg", note: "ÂñÆÁ®ã 1000ÂÜÜÔºåÊ¨£Ë≥ûÊ∏ØÊú™‰æÜÂÖ®ÊôØ„ÄÇ",
                            subItems: [{id: generateId(), type: 'do', text: 'ÈåÑ‰∏ãÂ§úÊôØÁ∏ÆÊôÇ', checked: false}],
                            transitToNext: { mode: 'train', duration: '15m', note: 'JR‰∫¨Êø±Êù±ÂåóÁ∑öÂõûÂ∑ùÂ¥é' }
                        },
                        { 
                            id: generateId(), time: "22:00", type: "food", title: "Â§úÈ≥¥ÊãâÈ∫µ & Ê∫´Ê≥â", loc: "Dormy Inn", image: "dormy_ramen.jpg", tags: ["Ê∫´Ê≥â","ÂÖçË≤ªÊãâÈ∫µ","ÂÖçË≤ªÂÜ∞Ê£í","‰π≥ÈÖ∏È£≤Êñô"], desc: "È£ØÂ∫óÊãõÁâåÊúçÂãôÔºåÊ≥°ÊπØÂæå‰∫´Áî®ÂÖçË≤ªÈÜ¨Ê≤πÊãâÈ∫µ„ÄÇ" 
                        }
                    ]
                },
                {
                    date: "1/29", weekday: "ÈÄ±Âõõ",
                    title: "ÊπòÂçóÊµ∑Â≤∏ËàáÊ±ü‰πãÂ≥∂",
                    weather: "Êô¥Â§© 5-12¬∞C",
                    locationKey: "kamakura",
                    imageUrl: "bridge_enoshima.jpg",
                    mealOptions: {
                        breakfast: [
                            { id: generateId(), name: "È£ØÂ∫óÊó©È§ê", dish: "Ëá™Âä©È§ê", priceLevel: "Â∑≤Âê´", url: "", locationUrl: "", note: "ÂêÉÈ£ΩÂÜçÂá∫Áôº" }
                        ],
                        lunch: [
                            { id: generateId(), name: "Tobiccho Êú¨Â∫ó", dish: "È≠©‰ªîÈ≠ö‰∏º", priceLevel: "¬•1800", url: "https://tobiccho.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê±ü‰πãÂ≥∂ÊéíÈöäÂêçÂ∫óÔºåÂèØÊäΩÊï¥ÁêÜÂà∏" },
                            { id: generateId(), name: "È≠öË¶ã‰∫≠", dish: "Êµ∑ÈÆÆ‰∏º", priceLevel: "¬•2000", url: "https://enoshima-uomitei.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êá∏Â¥ñÈÇäÊà∂Â§ñÂ∫ß‰ΩçÔºåÊôØËâ≤ÁÑ°Êïµ" }
                        ],
                        dinner: [
                            { id: generateId(), name: "AFURI Ê©´Êø±", dish: "ÊüöÂ≠êÊãâÈ∫µ", priceLevel: "¬•1200", url: "https://afuri.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÂõûÁ®ãÁ∂ìÈÅéÊ©´Êø±ÂêÉ" },
                            { id: generateId(), name: "Á£Ø‰∏∏Ê∞¥Áî¢", dish: "ËüπÂë≥ÂôåÁî≤ÁæÖÁáí", priceLevel: "¬•2000", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "Â∑ùÂ¥éÁ´ôÂâçÊúâÂàÜÂ∫óÔºå24Â∞èÊôÇÁáüÊ•≠" }
                        ]
                    },
                    events: [
                        { 
                            id: generateId(), time: "09:00", type: "sight", title: "Êñ∞Ê±ü‰πãÂ≥∂Ê∞¥ÊóèÈ§®", loc: "Ê±ü‰πãÂ≥∂", image: "aqu.jpg", tags: ["Êé®Ëñ¶:Ê∞¥ÊØçÂª≥"], desc: "Áõ∏Ê®°ÁÅ£Â§ßÊ∞¥ÊßΩËàáÂ§¢ÂπªÊ∞¥ÊØçÂª≥„ÄÇ",
                            subItems: [{id: generateId(), type: 'do', text: 'ÁúãÊµ∑Ë±öË°®Êºî', checked: false}, {id: generateId(), type: 'buy', text: 'Ê∞¥ÊØçÁé©ÂÅ∂', checked: false}],
                            transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°åÈÅéÊ©ã' }
                        },
                        { 
                            id: generateId(), time: "11:30", type: "food", title: "‰ª≤Ë¶ã‰∏ñÈÄöÂêÉÈÄèÈÄè", loc: "Ê±ü‰πãÂ≥∂ËÄÅË°ó", image: "street_enoshima.jpg", tags: ["Á´†È≠ö‰ªôË≤ù", "È≠©‰ªîÈ≠ö"], desc: "ÂèÉÊãúÊ±üÂ≥∂Á•ûÁ§æÔºåË≥ºË≤∑ÊâãÊâ∂Ê¢ØÂ•óÁ•®ÔºåÈÇäËµ∞ÈÇäÂêÉ„ÄÇ", 
                            subItems: [{id: generateId(), type: 'eat', text: 'ÊúùÊó•Â†Ç Êï¥ÈöªÈæçËù¶‰ªôË≤ù', checked: false}, {id: generateId(), type: 'eat', text: 'Á¥Ä‰πãÂúãÂ±ãÂ•≥Â§´È•ÖÈ†≠', checked: false}],
                            transitToNext: { mode: 'walk', duration: '20m', note: 'Êê≠‰πòÊâãÊâ∂Ê¢ØËá≥È†ÇÁ´Ø' }
                        },
                        { 
                            id: generateId(), time: "13:00", type: "sight", title: "Êµ∑Ë†üÁá≠Â±ïÊúõÁáàÂ°î", loc: "Ê±ü‰πãÂ≥∂È†Ç", image: "candle.jpg", desc: "Â§©Ê∞£Â•ΩÂèØÁú∫ÊúõÂØåÂ£´Â±±„ÄÇ",
                            transitToNext: { mode: 'walk', duration: '15m', note: 'ÂæÄ‰∏ãËµ∞Ëá≥Â•ßÊ¥•ÂÆÆÊñπÂêë' }
                        },
                        { 
                            id: generateId(), time: "14:00", type: "food", title: "ÂçàÈ§êÔºöÈ≠öË¶ã‰∫≠", loc: "Ê±ü‰πãÂ≥∂Êá∏Â¥ñ", image: "restaurant_enoshima.jpg", tags: ["ÁµïÊôØÊà∂Â§ñÂ∫ß"], desc: "ÂùêÂú®Êá∏Â¥ñÈÇäÁúãÊµ∑ÂêÉÊµ∑ÈÆÆ‰∏ºÔºåË¶ñÈáéÊ•µ‰Ω≥„ÄÇ",
                            transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°åËá≥Â≤©Â±ã' }
                        },
                        { 
                            id: generateId(), time: "15:30", type: "sight", title: "Â≤©Â±ã", loc: "Ê±ü‰πãÂ≥∂ÂæåÂ±±", image: "cave.jpg", desc: "Êµ∑ËùïÂπ≥Âè∞ËàáÊ¥ûÁ™üÔºåÁµïÁæéÂ§ïÈôΩÂêçÊâÄ„ÄÇ",
                            subItems: [{id: generateId(), type: 'do', text: 'ÊãçÂØåÂ£´Â±±Â§ïÈôΩ', checked: false}],
                            transitToNext: { mode: 'walk', duration: '20m', note: 'Êê≠‰πòÂºÅÂ§©‰∏∏ÈÅäË¶ΩËàπÂõûÊ©ãÈ†≠(Ë¶ñÈ¢®Êµ™)' }
                        },
                        { 
                            id: generateId(), time: "17:00", type: "transport", title: "ÊπòÂçóÂñÆËªåÈõªËªä", loc: "ÊπòÂçóÊ±ü‰πãÂ≥∂", image: "monorail.jpg", note: "ÂÄíÊéõÂºèÈõªËªäÔºåÂÉèÈõ≤ÈúÑÈ£õËªäËà¨Âà∫ÊøÄ„ÄÇ",
                            transitToNext: { mode: 'train', duration: '30m', note: 'Â§ßËàπËΩâËªäÂõûÂ∑ùÂ¥é' }
                        }
                    ]
                },
                {
                    date: "1/30", weekday: "ÈÄ±‰∫î",
                    title: "ÈéåÂÄâÂè§ÈÉΩËàáÊô¥Á©∫Â°î",
                    weather: "Â§öÈõ≤ 4-10¬∞C",
                    locationKey: "kamakura",
                    imageUrl: "kamakura.jpg",
                    mealOptions: {
                        breakfast: [
                            { id: generateId(), name: "Bills ‰∏ÉÈáåÊø±", dish: "RicottaÈ¨ÜÈ§Ö", priceLevel: "¬•2200", url: "https://billsjapan.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÈúÄÊèêÂâçÂÖ©ÈÄ±È†êÁ¥ÑÁ™óÈÇä‰Ωç" }
                        ],
                        lunch: [
                            { id: generateId(), name: "Caraway", dish: "ÁâõËÇâÂíñÂì©", priceLevel: "¬•900", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÈéåÂÄâÊéíÈöäÂêçÂ∫óÔºåCPÂÄºÈ´ò" },
                            { id: generateId(), name: "Oxymoron", dish: "ÂíåÈ¢®ËÇâÊú´ÂíñÂì©", priceLevel: "¬•1500", url: "https://www.oxymoron.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Â∞èÁî∫ÈÄöÂ∑∑ÂÖßÊñáÈùíÂ∫ó" }
                        ],
                        dinner: [
                            { id: generateId(), name: "Âà©‰πÖÁâõËàå", dish: "ÁâõËàåÂÆöÈ£ü", priceLevel: "¬•2500", url: "https://www.rikyu-gyutan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êô¥Á©∫Â°î6FÔºåÂéöÂàáÁâõËàåÂøÖÂêÉ" },
                            { id: generateId(), name: "ÂÖ≠ÂéòËàç", dish: "ÁâπË£ΩÊ≤æÈ∫µ", priceLevel: "¬•1100", url: "https://www.rokurinsha.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êô¥Á©∫Â°î6FÔºåÈ∫µÊ¢ùQÂΩà" },
                            { id: generateId(), name: "Toriton Ëø¥ËΩâÂ£ΩÂè∏", dish: "ÂåóÊµ∑ÈÅìÊôÇ‰ª§Â£ΩÂè∏", priceLevel: "¬•3000", url: "http://toriton-kita1.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êô¥Á©∫Â°î6FÔºå‰æÜËá™ÂåóÊµ∑ÈÅìÁöÑË∂Ö‰∫∫Ê∞£Â∫ó" }
                        ]
                    },
                    events: [
                        { 
                            id: generateId(), time: "10:00", type: "food", title: "bills Êó©ÂçàÈ§ê", loc: "‰∏ÉÈáå„É∂Êµú", image: "bills.jpg", tags: ["ÂøÖÂêÉ:È¨ÜÈ§Ö", "È†êÁ¥Ñ"], desc: "ËôüÁ®±‰∏ñÁïåÁ¨¨‰∏ÄÊó©È§êÔºåÊµ∑ÊôØÁ¨¨‰∏ÄÊéí„ÄÇ",
                            transitToNext: { mode: 'train', duration: '15m', note: 'Ê±ü‰πãÈõª (‰∏ÉÈáåÊø±->Èï∑Ë∞∑)' }
                        },
                        { 
                            id: generateId(), time: "12:00", type: "sight", title: "ÈéåÂÄâÂ§ß‰Ωõ", loc: "È´òÂæ∑Èô¢", image: "buddha.jpg", desc: "ÂúãÂØ∂ÈäÖÈÄ†ÈòøÂΩåÈôÄÂ¶Ç‰æÜÂùêÂÉè„ÄÇ",
                            subItems: [{id: generateId(), type: 'do', text: 'ÈÄ≤ÂÖ•Â§ß‰ΩõËÉéÂÖßÂèÉËßÄ(¬•50)', checked: false}],
                            transitToNext: { mode: 'train', duration: '10m', note: 'Ê±ü‰πãÈõª (Èï∑Ë∞∑->ÈéåÂÄâ)' }
                        },
                        { 
                            id: generateId(), time: "13:30", type: "sight", title: "È∂¥Â≤°ÂÖ´Âπ°ÂÆÆ", loc: "ÈéåÂÄâ", image: "kamakura.jpg", tags: ["Â∞èÁî∫ÈÄö"], desc: "ÈéåÂÄâÂú∞Ê®ôÔºåÂèÉÈÅìÈùûÂ∏∏ÁÜ±È¨ßÔºåÊúâË®±Â§öÂ∞èÂêÉ„ÄÇ",
                            subItems: [{id: generateId(), type: 'buy', text: 'Ë±êÂ≥∂Â±ã È¥øÂ≠êÈ§Ö‰πæ', checked: false}, {id: generateId(), type: 'eat', text: 'Kamakura Chacha ÊäπËå∂ÈúúÊ∑áÊ∑ã', checked: false}, {id: generateId(), type: 'eat', text: 'Â§¢Ë¶ãÂ±ã Á≥∞Â≠ê', checked: false}],
                            transitToNext: { mode: 'train', duration: '60m', note: 'JRÊ©´È†àË≥ÄÁ∑ö -> Ê∑∫ËçâÁ∑ö (Áõ¥ÈÄö)' }
                        },
                        { 
                            id: generateId(), time: "16:00", type: "transport", title: "Check-in Ê∑∫Ëçâ", loc: "Êù±Ê©´INN", image: "inn.jpg", tags: ["Â∞èÁî∫ÈÄö"], note: "ÂØÑÊîæË°åÊùé„ÄÅÁ®ç‰Ωú‰ºëÊÅØ",
                            transitToNext: { mode: 'train', duration: '5m', note: 'Ê∑∫ËçâÁ∑ö (Ê∑∫Ëçâ->Êäº‰∏ä)' }
                        },
                        { 
                            id: generateId(), time: "19:00", type: "food", title: "Êô¥Á©∫Â°î", loc: "Êäº‰∏ä", image: "skytree.jpg", tags: ["ÂøÖÈÄõ", "ÊôöÈ§ê"], desc: "Ë≥ºÁâ©ÂïÜÂüéÔºåÂÖ≠ÂéòËàçÊ≤æÈ∫µ„ÄÅÂà©‰πÖÁâõËàåÈÉΩÂú®ÈÄô„ÄÇ",
                            subItems: [{id: generateId(), type: 'buy', text: 'Tokyo Banana (Êô¥Á©∫Â°îÈôêÂÆöË±πÁ¥ã)', checked: false}, {id: generateId(), type: 'buy', text: 'Press Butter Sand', checked: false}, {id: generateId(), type: 'do', text: 'ÂØ∂ÂèØÂ§¢‰∏≠ÂøÉ', checked: false}]
                        }
                    ]
                },
                {
                    date: "1/31", weekday: "ÈÄ±ÂÖ≠",
                    title: "Â∞èÊ±üÊà∂Â∑ùË∂ä",
                    weather: "Êô¥Â§© 3-11¬∞C",
                    locationKey: "kawagoe",
                    imageUrl: "oldstreet.jpg",
                    mealOptions: {
                        breakfast: [
                            { id: generateId(), name: "‰æøÂà©ÂïÜÂ∫ó", dish: "ÂíñÂï°/È∫µÂåÖ", priceLevel: "¬•400", url: "", locationUrl: "", note: "" }
                        ],
                        lunch: [
                            { id: generateId(), name: "Â∞èÂ∑ùËèä", dish: "È∞ªÈ≠öÈ£Ø", priceLevel: "¬•4000", url: "https://www.ogakiku.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÁôæÂπ¥ËÄÅÂ∫óÔºåÂãôÂøÖÈñãÈñÄÂâçÊéíÈöä" },
                            { id: generateId(), name: "Â∑ùË∂äÈáúÈ£Ø Torisei", dish: "ÈáúÈ£ØÂÆöÈ£ü", priceLevel: "¬•1500", url: "http://www.torisei.net/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÊéíÈöäÂêçÂ∫óÔºåÈõûËÇâÈáúÈ£ØÂæàÈ¶ô" },
                            { id: generateId(), name: "Hayashiya", dish: "È∞ªÈ≠öÈ£Ø", priceLevel: "¬•3500", url: "", locationUrl: "", note: "ËÄÅË°ó‰∏äÁöÑÂè¶‰∏ÄÈÅ∏Êìá" }
                        ],
                        dinner: [
                            { id: generateId(), name: "ÁÑ°ÊïµÂÆ∂", dish: "Ë±öÈ™®ÊãâÈ∫µ", priceLevel: "¬•1200", url: "https://mutekiya.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê±†Ë¢ãÂêçÂ∫óÔºåÂõûÁ®ãÈ†ÜË∑ØÂêÉ" },
                            { id: generateId(), name: "Ê¥ªÁæéÁôªÂà©Â£ΩÂè∏", dish: "Ëø¥ËΩâÂ£ΩÂè∏", priceLevel: "¬•2500", url: "https://katumidori.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê±†Ë¢ãË•øÊ≠¶ÁôæË≤®8FÔºåCPÂÄºÈ´ò" }
                        ]
                    },
                    events: [
                        { 
                            id: generateId(), time: "09:00", type: "transport", title: "ÂâçÂæÄÂ∑ùË∂ä", loc: "Ê±†Ë¢ãÁ´ô", image: "kawagoePass.png", note: "Ë≥ºË≤∑Êù±Ê≠¶Â∑ùË∂äÂë®ÈÅäÂà∏",
                            transitToNext: { mode: 'train', duration: '30m', note: 'Êù±Ê≠¶Êù±‰∏äÁ∑öÊÄ•Ë°å' }
                        },
                        { 
                            id: generateId(), time: "10:30", type: "sight", title: "ÂÜ∞Â∑ùÁ•ûÁ§æ", loc: "Â∑ùË∂ä", image: "hikawa.jpg", tags: ["È´îÈ©ó:Èá£ÈØõÈ≠ö"], desc: "Ê±ÇÂßªÁ∑£ÂêçÊâÄÔºåÁπ™È¶¨ÈößÈÅìÂøÖÊãç„ÄÇ",
                            subItems: [{id: generateId(), type: 'do', text: 'Èá£Á¥ÖËâ≤ÈØõÈ≠ö(Ê±ÇÂπ≥ÂÆâ)', checked: false}, {id: generateId(), type: 'do', text: 'Èá£Á≤âËâ≤ÈØõÈ≠ö(Ê±ÇËâØÁ∑£)', checked: false}, {id: generateId(), type: 'do', text: 'Êîæ‰∫∫ÂΩ¢ÊµÅ(Èô§Á©¢)', checked: false}],
                            transitToNext: { mode: 'bus', duration: '10m', note: 'Êù±Ê≠¶Â∑¥Â£´' }
                        },
                        { 
                            id: generateId(), time: "12:00", type: "food", title: "Â∑ùË∂äÈáúÈ£Ø Torisei", loc: "Â∑ùË∂ä", image: "torisei.jpg", desc: "ÊãõÁâåËèúÊòØ„ÄåÂ∑ùË∂äÈáúÈ£ØÂÆöÈ£ü„ÄçÔºàÈ∞ªÈ≠öÂ°äÈÖçÂ∑ùË∂äÂêçÁâ©Áï™ËñØÔºâÂèä„ÄåÈ≥•„ÇÇ„ÇÇÁÇ≠ÁÅ´ÁÑºÂÆöÈ£ü„Äç„ÄÇ",
                            transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°å' }
                        },
                        { 
                            id: generateId(), time: "13:00", type: "food", title: "Â∞èÂ∑ùËèä È∞ªÈ≠öÈ£Ø", loc: "Â∑ùË∂ä", image: "mini_unagi.jpg", tags: ["ÂøÖÂêÉ:È∞ªÈ≠ö"], desc: "ÁôæÂπ¥ËÄÅÂ∫óÔºåÁÇ≠ÁÉ§È¶ôÊ∞£ÂçÅË∂≥„ÄÇËã•Â§™‰πÖÂèØÊîπÂêÉ'ÂÇ≥Á±≥'ÔºåÂÇ≥Á±≥ÊúâÊèê‰æõËø∑‰Ω†È∞ªÈ≠öÈ£Ø„ÄÇ",
                            transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°åËá≥‰∏ÄÁï™Ë°ó' }
                        },
                        { 
                            id: generateId(), time: "14:00", type: "sight", title: "ËóèÈÄ†ËÄÅË°ó", loc: "‰∏ÄÁï™Ë°ó", image: "oldstreet.jpg", tags: ["ÈæúÂ±ãÈäÖÈëºÁáí","Â∑ùË∂äÂ∏É‰∏Å","Â∞èÊ±üÊà∂Â§ßËä±-ÁéâÂ≠êÁáí"], desc: "Âú®Â∑ùË∂äÁöÑ‰∏ªË¶ÅË°óÈÅì„ÄåÂ∞èÊ±üÊà∂Â∑ùË∂ä‰∏ÄÁï™Ë°óÂïÜÂ∫óË°ó„ÄçË£°...",
                            subItems: [{id: generateId(), type: 'eat', text: 'Â∑ùË∂äÂ∏É‰∏Å (Â∑ùË∂ä„Éó„É™„É≥)', checked: false}, {id: generateId(), type: 'eat', text: 'Â∞èÊ±üÊà∂Â§ßËä± Ê£çÁãÄÁéâÂ≠êÁáí', checked: false}, {id: generateId(), type: 'eat', text: 'Á¥´ËñØÂÜ∞Ê∑áÊ∑ã', checked: false}],
                            transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°å' }
                        },
                        { 
                            id: generateId(), time: "15:00", type: "sight", title: "ÊôÇ‰πãÈêò", loc: "‰∏ÄÁï™Ë°ó", image: "toki.jpg", tags: ["ÈæúÂ±ãÈäÖÈëºÁáí"], desc: "ÊôÇ‰πãÈêòÊòØ‰∏ÄÂÄãÈ´òÁ¥Ñ16ÂÖ¨Â∞∫ÁöÑÊú®Ë£ΩÈêòÊ®ìÔºåÁèæÂú®ÊòØÂ∑ùË∂äÁöÑÂú∞Ê®ôÊÄßÂª∫ÁØâ„ÄÇ",
                            subItems: [{id: generateId(), type: 'buy', text: 'ÈæúÂ±ã ÈäÖÈëºÁáí', checked: false}],
                            transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°å' }
                        },
                        { 
                            id: generateId(), time: "15:30", type: "sight", title: "Â§ßÊ≠£Êµ™Êº´Â§¢ÈÄö", loc: "Â∑ùË∂ä", image: "taisei.jpg", desc: "‰ΩçÂú®Â∑ùË∂äÁöÑ„ÄåÂ§ßÊ≠£Êµ™Êº´Â§¢ÈÄö„Çä„ÄçÊòØ‰∏ÄÊ¢ùÂÖÖÊªøÊá∑ËàäÊ∞õÂúçÁöÑÊ≠∑Âè≤ÂïÜÂ∫óË°ó„ÄÇ",
                            transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°å' }
                        },
                        { 
                            id: generateId(), time: "16:00", type: "sight", title: "ÁÜäÈáéÁ•ûÁ§æ", loc: "Â∑ùË∂ä", image: "kumano.jpg", tags:["Èå¢Ê¥óÂºÅË≤°Â§©","Ê∞¥Êô∂ÁêÉ","Â•óÂúàÂúà"], desc: "Â∑ùË∂äÁÜäÈáéÁ•ûÁ§æÊòØ‰∏ÄÂ∫ßÊ≠∑Âè≤ÊÇ†‰πÖÁöÑÈñãÈÅã„ÄÅÁµêÁ∑£Á•ûÁ§æ„ÄÇ",
                            subItems: [{id: generateId(), type: 'do', text: 'Ê¥óÈå¢ÂºÅË≤°Â§©', checked: false}, {id: generateId(), type: 'do', text: 'ÂÅ•Â∫∑Ê≠•ÈÅì', checked: false}],
                            transitToNext: { mode: 'train', duration: '45m', note: 'ÂõûÊ±†Ë¢ã/Ê∑∫Ëçâ' }
                        }
                    ]
                },
                {
                    date: "2/1", weekday: "ÈÄ±Êó•",
                    title: "Êó•ÂÖâ‰∏ñÁïåÈÅ∫Áî¢",
                    weather: "Èõ™/Èõ® 0-5¬∞C",
                    locationKey: "nikko",
                    imageUrl: "Toshogu.jpg",
                    mealOptions: {
                        breakfast: [
                            { id: generateId(), name: "Spacia X ËªäÂÖßË≤©ÂîÆ", dish: "Á≤æÈáÄÂï§ÈÖí/ÂíñÂï°", priceLevel: "¬•600", url: "", locationUrl: "", note: "Ëªä‰∏äCafe" }
                        ],
                        lunch: [
                            { id: generateId(), name: "Ê≤πÊ∫ê", dish: "ÊπØÊ≥¢(Ë±ÜÁöÆ)ÊñôÁêÜ", priceLevel: "¬•2000", url: "https://www.aburagen.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Êó•ÂÖâÂêçÁâ©ÔºåÂÅ•Â∫∑ÁæéÂë≥" },
                            { id: generateId(), name: "Meiji-no-Yakata", dish: "ËõãÂåÖÈ£Ø/Ëµ∑Âè∏ËõãÁ≥ï", priceLevel: "¬•2500", url: "http://www.meiji-yakata.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÊòéÊ≤ª‰πãÈ§®ÔºåÊ¥ãÈ£üÂêçÂ∫ó" },
                            { id: generateId(), name: "Komekichi Kozushi", dish: "Êó•ÂÖâÊπØÊ≥¢Â£ΩÂè∏", priceLevel: "¬•1800", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÂâµÊÑèÂ£ΩÂè∏" }
                        ],
                        dinner: [
                            { id: generateId(), name: "Ê∑∫Ëçâ ÁâõÁÇ∏(Gyukatsu)", dish: "ÁÇ∏ÁâõÊéí", priceLevel: "¬•1800", url: "https://www.asakusa-gyukatsu.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Èõ∑ÈñÄÂ∞çÈù¢Ôºå‰∫∫Ê∞£ÊéíÈöäÂ∫ó" },
                            { id: generateId(), name: "Yoroiya Ê∑∫ËçâÊãâÈ∫µ", dish: "ÈÜ¨Ê≤πÊãâÈ∫µ", priceLevel: "¬•900", url: "https://yoroiya.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê∏ÖÊ∑°Á≥ªÈÜ¨Ê≤πÊãâÈ∫µÔºåÂä†ÂÖ•ÊüöÂ≠êÊèêÂë≥" },
                            { id: generateId(), name: "Â§ßÈªëÂÆ∂", dish: "Êµ∑ËÄÅÂ§©‰∏º", priceLevel: "¬•2000", url: "http://www.tempura.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÈªëÈ∫ªÊ≤πÁÇ∏Â§©Â©¶ÁæÖÔºåÂè£Âë≥ËºÉÈáç" }
                        ]
                    },
                    events: [
                        { 
                            id: generateId(), time: "06:00", type: "transport", title: "SPACIA X (ÂéªÁ®ã)", loc: "Ê∑∫ËçâÁ´ô", image: "spaciaX.jpeg", tags: ["È†êÁ¥Ñ:ÂøÖÈ†à"], desc: "ÊúÄÊñ∞Â•¢ËèØËßÄÂÖâÂàóËªä„ÄÇ",
                            subItems: [{id: generateId(), type: 'eat', text: 'ËªäÂÖßÈôêÂÆö Craft Beer', checked: false}, {id: generateId(), type: 'eat', text: 'Êó•ÂÖâÊÑèÂºèÂÜ∞Ê∑áÊ∑ã', checked: false}],
                            transitToNext: { mode: 'train', duration: '1h 50m', note: 'Êù±Ê≠¶Êó•ÂÖâÁ∑ö' }
                        },
                        { 
                            id: generateId(), time: "09:30", type: "food", title: "ÁÇ∏ÊπØÊ≥¢È•ÖÈ†≠", loc: "Êó•ÂÖâSakaeya", image: "sakaeya.jpg", tags: ["ÂøÖÂêÉ"], desc: "Êíí‰∏äÈπΩÂ∑¥ÁöÑÁÇ∏Ë±ÜÁöÆÈ•ÖÈ†≠ÔºåÁîúÈππÁµïÈÖç„ÄÇ",
                            subItems: [{id: generateId(), type: 'eat', text: 'ÁÇ∏ÊπØÊ≥¢È•ÖÈ†≠', checked: false}],
                            transitToNext: { mode: 'bus', duration: '10m', note: '‰∏ñÁïåÈÅ∫Áî¢Â∑°ÈÅäÂ∑¥Â£´' }
                        },
                        { 
                            id: generateId(), time: "11:00", type: "sight", title: "Êó•ÂÖâ‰∏ñÁïåÈÅ∫Áî¢‰∫åÁ§æ‰∏ÄÂØ∫", loc: "Êó•ÂÖâ", image: "Toshogu.jpg", tags: ["‰∫åËçíÂ±±Á•ûÁ§æ","Êù±ÁÖßÂÆÆ","Â±±Ëº™ÁéãÂØ∫"], desc: "** Êó•ÂÖâÊù±ÁÖßÂÆÆ **\nÊó•ÂÖâÊù±ÁÖßÂÆÆÊòØ‰æõÂ•âÊ±üÊà∂ÂπïÂ∫úÁ¨¨‰∏Ä‰ª£Â∞áËªçÂæ∑Â∑ùÂÆ∂Â∫∑ÁöÑÁ•ûÁ§æ...",
                            subItems: [{id: generateId(), type: 'do', text: 'Êâæ„ÄåÁú†Ë≤ì„Äç', checked: false}, {id: generateId(), type: 'do', text: 'Êâæ„Äå‰∏âÁåø„Äç(ÈùûÁ¶ÆÂãøË¶ñ...)', checked: false}, {id: generateId(), type: 'do', text: 'ËÅΩ„ÄåÈ≥¥Èæç„ÄçÂõûÈü≥', checked: false}],
                            transitToNext: { mode: 'walk', duration: '10m', note: 'Ê≠•Ë°å' }
                        },
                        { 
                            id: generateId(), time: "13:30", type: "food", title: "ÊπØÊ≥¢ÊñôÁêÜÂçàÈ§ê", loc: "Ê≤πÊ∫ê", image: "yuba.jpg", tags: ["ÊπØÊ≥¢Âæ°ËÜ≥"], desc: "Êó•ÂÖâÂêçÁî¢Ë±ÜÁöÆÊñôÁêÜ„ÄÇ",
                            transitToNext: { mode: 'walk', duration: '15m', note: 'Ê≠•Ë°å' }
                        },
                        { 
                            id: generateId(), time: "15:30", type: "sight", title: "Á•ûÊ©ã", loc: "Êó•ÂÖâ", image: "hashi.jpg", desc: "Êú±Á¥ÖËâ≤Êã±Ê©ãËàáÈõ™ÊôØ/Ê∫™ÊµÅÁöÑÂ∞çÊØî„ÄÇ‰∏äÊ©ãË¶ÅËä±Èå¢ÔºåÂª∫Ë≠∞ÈÅ†ÁúãÂ∞±Â•Ω„ÄÇ",
                            transitToNext: { mode: 'bus', duration: '10m', note: 'Â∑¥Â£´ÂõûËªäÁ´ô' }
                        },
                        { 
                            id: generateId(), time: "16:30", type: "transport", title: "SPACIA X (ÂõûÁ®ã)", loc: "Êù±Ê≠¶Êó•ÂÖâÁ´ô", image: "spaciax.jpg", note: "Âú®Ëªä‰∏ä‰∫´Áî®Êó•ÂÖâÂ∏É‰∏ÅÊàñÂï§ÈÖí„ÄÇ",
                            transitToNext: { mode: 'train', duration: '2h', note: 'ÂõûÊ∑∫Ëçâ' }
                        }
                    ]
                },
                {
                    date: "2/2", weekday: "ÈÄ±‰∏Ä",
                    title: "Êù±‰∫¨Á∂ìÂÖ∏Á≤æÈÅ∏",
                    weather: "Â§öÈõ≤ 5-12¬∞C",
                    locationKey: "tokyo",
                    imageUrl: "tokyo_tower.jpg",
                    mealOptions: {
                        breakfast: [
                            { id: generateId(), name: "Pelican Cafe", dish: "ÁÇ≠ÁÉ§ÂêêÂè∏", priceLevel: "¬•800", url: "https://www.bakerpelican.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ê∑∫ËçâÈ∫µÂåÖËÄÅËàñÔºåÈúÄÊéíÈöä" },
                            { id: generateId(), name: "February Cafe", dish: "ÁÑ¶Á≥ñÂ∏É‰∏Å", priceLevel: "¬•700", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "‰ΩøÁî®PelicanÂêêÂè∏ÁöÑÊñáÈùíÂíñÂï°Â∫ó" }
                        ],
                        lunch: [
                            { id: generateId(), name: "Ê∑∫Ëçâ‰ªäÂçä", dish: "Â£ΩÂñúÁáíÂçàËÜ≥", priceLevel: "¬•4000", url: "https://www.asakusaimahan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÁôæÂπ¥ËÄÅÂ∫óÔºåÂçàÈ§êCPÂÄºËºÉÈ´ò" },
                            { id: generateId(), name: "Namiki Yabusoba", dish: "È¥®ÂçóË†ªËïéÈ∫•È∫µ", priceLevel: "¬•1800", url: "https://yabusoba.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "Ëó™ËïéÈ∫•Âæ°‰∏âÂÆ∂‰πã‰∏Ä" }
                        ],
                        dinner: [
                            { id: generateId(), name: "Ê†πÂÆ§Ëä±‰∏∏", dish: "Ëø¥ËΩâÂ£ΩÂè∏", priceLevel: "¬•3000", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "KITTE‰∏∏‰πãÂÖßÂ∫óÔºåÊéíÈöäÂêçÂ∫ó" },
                            { id: generateId(), name: "Tsurutontan", dish: "Â§ßÁ¢óÁÉèÈæçÈ∫µ", priceLevel: "¬•1500", url: "http://www.tsurutontan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ÈäÄÂ∫ßTokyu PlazaÔºåÁ¢óÊØîËáâÂ§ß" },
                            { id: generateId(), name: "ÈäÄÂ∫ß ÁØù (Kagari)", dish: "ÈõûÁôΩÊπØSoba", priceLevel: "¬•1200", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "Á±≥ÂÖ∂ÊûóÊé®Ëñ¶ÔºåÊøÉÈÉÅÈõûÁôΩÊπØ" }
                        ]
                    },
                    events: [
                        { 
                            id: generateId(), time: "9:00", type: "food", title: "Pelican CAFE", loc: "Áî∞ÂéüÁî∫", image: "pelican.jpg", tags: ["ÁÇ≠ÁÉ§ÂêêÂè∏"], desc: "Ê∑∫ËçâÈ∫µÂåÖËÄÅËàñ„ÄåÈµúÈ∂òÈ∫µÂåÖ„Äç‰∫∫Ê∞£Êó©È§êÔºåÂøÖÈªûÁÇ∏ÁÅ´ËÖø‰∏âÊòéÊ≤ª„ÄÇ",
                            transitToNext: { mode: 'walk', duration: '15m', note: 'Ê≠•Ë°åËá≥Èõ∑ÈñÄ' }
                        },
                        { 
                            id: generateId(), time: "10:30", type: "sight", title: "Ê∑∫ËçâÂØ∫ & Èõ∑ÈñÄ", loc: "Ê∑∫Ëçâ", image: "asakusa.jpg", tags: ["ÂàùË®™ÂøÖÂéª"], desc: "Êù±‰∫¨ÊúÄÂè§ËÄÅÂØ∫ÂªüÔºåÊó©‰∏äÂéª‰∫∫ËºÉÂ∞ë„ÄÇ",
                            subItems: [{id: generateId(), type: 'do', text: 'Ê±ÇÁ±§ (Âá∂Ë¶ÅÁ∂ÅÂú®Êû∂‰∏ä)', checked: false}, {id: generateId(), type: 'buy', text: '‰∫∫ÂΩ¢Ááí', checked: false}, {id: generateId(), type: 'eat', text: 'Ëä±ÊúàÂ†Ç Ëè†ËòøÈ∫µÂåÖ', checked: false}],
                            transitToNext: { mode: 'train', duration: '20m', note: 'ÈäÄÂ∫ßÁ∑ö (Ê∑∫Ëçâ->‰∫¨Ê©ã/Êó•Êú¨Ê©ã)' }
                        },
                        { 
                            id: generateId(), time: "13:00", type: "sight", title: "Êù±‰∫¨ËªäÁ´ô", loc: "‰∏∏‰πãÂÖß", image: "station.jpg", tags: ["‰º¥ÊâãÁ¶Æ"], desc: "Ê¨£Ë≥ûÁ¥ÖÁ£öËªäÁ´ôÂª∫ÁØâ„ÄÇ",
                            subItems: [{id: generateId(), type: 'buy', text: 'NY Perfect Cheese', checked: false}, {id: generateId(), type: 'buy', text: 'NewYork City Sand', checked: false}],
                            transitToNext: { mode: 'train', duration: '15m', note: '‰∏∏‰πãÂÖßÁ∑ö/JR (Êù±‰∫¨->Ëµ§ÁæΩÊ©ã)' }
                        },
                        { 
                            id: generateId(), time: "15:00", type: "sight", title: "Êù±‰∫¨ÈêµÂ°î", loc: "ËäùÂÖ¨Âúí", image: "tokyo_tower.jpg", tags: ["ÂøÖÊãç:ÂÖ®ÊôØ"], desc: "ÂùêÂú®ËçâÂú∞‰∏äËàáÊù±‰∫¨ÈêµÂ°îÂêàÁÖß„ÄÇ",
                            subItems: [{id: generateId(), type: 'do', text: 'Êãç„ÄåÂú∞‰∏ãÂÅúËªäÂ†¥Ê®ìÊ¢Ø„ÄçÁ∂≤ÁæéÁÖß', checked: false}]
                        },
                    ]
                },
                {
                    date: "2/3", weekday: "ÈÄ±‰∫å",
                    title: "Ê≠∏ÈÄî",
                    weather: "Êô¥ÊôÇÂ§öÈõ≤",
                    locationKey: "tokyo",
                    imageUrl: "narita.jpg",
                    mealOptions: {
                        breakfast: [
                            { id: generateId(), name: "È£ØÂ∫óÊó©È§ê", dish: "È£ØÁ≥∞", priceLevel: "", url: "", locationUrl: "", note: "" }
                        ],
                        lunch: [
                            { id: generateId(), name: "Â£ΩÂè∏‰∫¨Ëæ∞", dish: "Â£ΩÂè∏", priceLevel: "¬•3000", url: "", locationUrl: "", note: "ÊàêÁî∞Ê©üÂ†¥ÁÆ°Âà∂ÂçÄÂÖßÔºåÊúÄÂæå‰∏ÄÈ†ìÁæéÈ£ü" },
                            { id: generateId(), name: "È∫•Áï∂Âãû", dish: "ÂüπÊ†πÈ¶¨Èà¥ËñØÊ¥æ", priceLevel: "¬•500", url: "", locationUrl: "", note: "Êó•Êú¨ÈôêÂÆöÂè£Âë≥" }
                        ],
                        dinner: []
                    },
                    events: [
                        { 
                            id: generateId(), time: "08:00", type: "hotel", title: "Check-out", loc: "Êù±Ê©´INN", image: "inn.jpg", note: "Ê™¢Êü•Ë≠∑ÁÖß„ÄÅÈå¢ÂåÖ„ÄÇ",
                            transitToNext: { mode: 'walk', duration: '5m', note: 'Ê≠•Ë°åËá≥ËªäÁ´ô' }
                        },
                        { 
                            id: generateId(), time: "08:30", type: "transport", title: "ÂâçÂæÄÊ©üÂ†¥", loc: "AccessÁâπÂø´", image: "access.jpg", note: "Áõ¥ÈÅîÊàêÁî∞ (Á¥Ñ60ÂàÜ)„ÄÇ", 
                            transitToNext: { mode: 'train', duration: '60m', note: 'Áõ¥ÈÅîÁâπÂø´' }
                        },
                        { 
                            id: generateId(), time: "10:12", type: "sight", title: "Ê©üÂ†¥ÊúÄÂæåË°ùÂà∫", loc: "ÊàêÁî∞ T2", image: "naritaT.jpg", tags: ["ÂÖçÁ®ÖÂ∫ó"], desc: "Ë≥ºË≤∑ÁôΩËâ≤ÊàÄ‰∫∫„ÄÅRoyce„ÄÇ",
                            subItems: [{id: generateId(), type: 'buy', text: 'Royce ÁîüÂ∑ßÂÖãÂäõ', checked: false}, {id: generateId(), type: 'buy', text: 'LeTAO Ëµ∑Âè∏ËõãÁ≥ï', checked: false}, {id: generateId(), type: 'buy', text: 'ËñØÊ¢ù‰∏âÂÖÑÂºü', checked: false}],
                            transitToNext: { mode: 'walk', duration: '30m', note: 'ÁôªÊ©üÂè£' }
                        },
                        { 
                            id: generateId(), time: "13:00", type: "transport", title: "Ëµ∑È£õ BR197", loc: "ÊàêÁî∞Ê©üÂ†¥", image: "plane.jpg", note: "ÂÜçË¶ãÊù±‰∫¨ÔºÅ" }
                        ]
                    }
                ]
        };

        const fetchLiveWeather = async (locationKey) => {
            const loc = LOCATIONS[locationKey];
            if (!loc) return null;

            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true`);
                const data = await response.json();
                return {
                    temp: Math.round(data.current_weather.temperature),
                    code: data.current_weather.weathercode
                };
            } catch (error) {
                console.error("Failed to fetch weather", error);
                return null;
            }
        };

        const getWeatherIcon = (code) => {
            if (code === 0) return 'fa-sun';
            if (code >= 1 && code <= 3) return 'fa-cloud-sun';
            if (code >= 45 && code <= 48) return 'fa-smog';
            if (code >= 51 && code <= 67) return 'fa-cloud-rain';
            if (code >= 71 && code <= 77) return 'fa-snowflake';
            if (code >= 95) return 'fa-bolt';
            return 'fa-cloud';
        };

        // --- COMPONENTS ---

        const EventCard = ({ event, onClick }) => {
            const typeColors = {
                transport: 'text-blue-400',
                food: 'text-orange-400',
                hotel: 'text-indigo-400',
                sight: 'text-matcha'
            };
            return (
                <div onClick={onClick} className="relative group cursor-pointer bg-white/50 rounded-2xl p-3 border border-transparent hover:border-matcha/30 hover:bg-white/80 transition-all duration-300">
                    <div className="absolute -left-[45px] top-6 w-5 h-5 rounded-full border-4 border-rice bg-slate-300 group-hover:bg-matcha transition-colors shadow-sm z-10"></div>
                    <div className="flex justify-between items-start gap-3">
                        <div className="flex-1">
                            <div className="flex items-baseline gap-2 mb-1">
                                <span className="font-mono text-sm font-bold text-slate-500">{event.time}</span>
                                <span className={`text-[10px] font-bold uppercase tracking-wider ${typeColors[event.type] || 'text-slate-400'} opacity-80`}>
                                    {event.type}
                                </span>
                            </div>
                            <h3 className="text-lg font-bold text-charcoal leading-tight mb-1">{event.title}</h3>
                            <p className="text-sm text-slate-500 font-medium truncate tracking-wide flex items-center">
                                <i className="fa-solid fa-location-dot text-xs mr-1 opacity-70"></i>
                                {event.loc}
                            </p>
                            {event.subItems && event.subItems.length > 0 && (
                                <div className="mt-3 flex flex-wrap gap-2">
                                    {event.subItems.slice(0, 3).map(item => (
                                        <span key={item.id} className={`text-[10px] px-2 py-0.5 rounded-md border ${item.checked ? 'bg-matcha text-white border-matcha' : 'bg-white text-slate-500 border-slate-200'}`}>
                                            {item.type === 'buy' ? 'üõçÔ∏è' : item.type === 'eat' ? 'üç¥' : '‚ú®'} {item.text}
                                        </span>
                                    ))}
                                    {event.subItems.length > 3 && <span className="text-[10px] text-slate-400">+...</span>}
                                </div>
                            )}
                        </div>
                        {event.image && (
                            <img 
                                src={event.image} 
                                className="w-20 h-20 rounded-xl object-cover shadow-sm opacity-90 group-hover:opacity-100 transition-opacity bg-slate-200 flex-shrink-0" 
                                loading="lazy" 
                                alt=""
                                onError={(e) => { 
                                    // Fallback if local image fails
                                    e.target.src = 'https://placehold.co/100x100/eceae6/a0a09e?text=No+Img';
                                }}
                            />
                        )}
                    </div>
                </div>
            );
        };

        const TransportConnector = ({ data, onClick }) => {
            const getTransportIcon = (mode) => {
                switch(mode) {
                    case 'train': return 'fa-train-subway';
                    case 'walk': return 'fa-person-walking';
                    case 'taxi': return 'fa-taxi';
                    case 'bus': return 'fa-bus';
                    default: return 'fa-arrow-right';
                }
            };
            if (!data) {
                return (
                    <div className="relative h-12 ml-[10px] border-l-2 border-dotted border-slate-300 my-1 group cursor-pointer" onClick={(e) => { e.stopPropagation(); onClick(); }}>
                        <div className="absolute top-1/2 -left-[10px] -translate-y-1/2 w-6 h-6 rounded-full bg-white border border-slate-300 flex items-center justify-center text-slate-300 shadow-sm opacity-0 group-hover:opacity-100 transition-all hover:border-matcha hover:text-matcha active:scale-95">
                            <i className="fa-solid fa-plus text-[10px]"></i>
                        </div>
                    </div>
                );
            }
            return (
                <div className="relative h-16 ml-[10px] border-l-2 border-dashed border-slate-300 my-1 group">
                    <button onClick={(e) => { e.stopPropagation(); onClick(); }} className="absolute top-1/2 -left-[14px] -translate-y-1/2 flex items-center gap-2 bg-white border border-slate-200 shadow-sm px-3 py-1.5 rounded-full hover:border-matcha hover:text-matcha transition-all z-20 active:scale-95 max-w-[180px]">
                        <i className={`fa-solid ${getTransportIcon(data.mode)} text-xs text-slate-400 group-hover:text-matcha flex-shrink-0`}></i>
                        <div className="flex flex-col items-start text-left overflow-hidden">
                            <span className="text-[10px] font-bold text-slate-500 whitespace-nowrap group-hover:text-matcha leading-tight">{data.duration}</span>
                            {data.note && <span className="text-[9px] text-slate-400 truncate w-full group-hover:text-matcha/70 leading-tight">{data.note}</span>}
                        </div>
                    </button>
                </div>
            );
        };

        const MealOptions = ({ mealData, onAdd, onEdit }) => {
            const [isOpen, setIsOpen] = useState(false);
            if (!mealData) return null;
            const hasData = mealData.breakfast.length > 0 || mealData.lunch.length > 0 || mealData.dinner.length > 0;
            const RestaurantCard = ({ item, onClick }) => (
                <div onClick={onClick} className="min-w-[220px] bg-white rounded-xl p-3 border border-subtle shadow-sm flex flex-col snap-start active:scale-95 transition-transform cursor-pointer relative group">
                    <div className="absolute top-2 right-2 text-slate-300 group-hover:text-matcha transition-colors"><i className="fa-solid fa-pen-to-square text-xs"></i></div>
                    <div className="flex justify-between items-start mb-2 pr-4">
                        <h4 className="font-bold text-charcoal text-sm line-clamp-1">{item.name}</h4>
                        <span className="text-[10px] font-mono text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">{item.priceLevel}</span>
                    </div>
                    <div className="text-xs text-slate-500 mb-1"><span className="text-orange-400 font-bold">‚òÖ Êé®:</span> {item.dish}</div>
                    {item.note && <p className="text-[10px] text-slate-400 line-clamp-2 mb-3 bg-slate-50 p-1 rounded">{item.note}</p>}
                    <div className="mt-auto flex gap-2">
                        {item.locationUrl ? <a href={item.locationUrl} onClick={e => e.stopPropagation()} target="_blank" rel="noreferrer" className="flex-1 py-1.5 text-center bg-slate-100 hover:bg-slate-200 rounded-lg text-[10px] font-bold text-slate-600 transition-colors"><i className="fa-solid fa-map-location-dot mr-1"></i> Âú∞Âúñ</a> : <div className="flex-1"></div>}
                        {item.url ? <a href={item.url} onClick={e => e.stopPropagation()} target="_blank" rel="noreferrer" className="flex-1 py-1.5 text-center bg-slate-100 hover:bg-slate-200 rounded-lg text-[10px] font-bold text-slate-600 transition-colors"><i className="fa-brands fa-google mr-1"></i> Êêú</a> : <div className="flex-1"></div>}
                    </div>
                </div>
            );
            const AddCard = ({ onClick }) => (
                <div onClick={onClick} className="min-w-[50px] flex items-center justify-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 cursor-pointer hover:border-matcha hover:bg-matcha/5 transition-colors active:scale-95"><i className="fa-solid fa-plus text-slate-400"></i></div>
            );
            return (
                <div className="mb-8 px-1">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between bg-white border border-orange-100 p-3 rounded-xl shadow-sm mb-4 active:bg-orange-50 transition-colors">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><i className="fa-solid fa-utensils text-sm"></i></div>
                            <div className="text-left">
                                <div className="text-sm font-bold text-charcoal">ÁæéÈ£üÂÇôÊ°à & Êé®Ëñ¶</div>
                                <div className="text-[10px] text-slate-400">{isOpen ? 'ÈªûÊìäÊî∂Âêà' : (hasData ? 'ÈªûÊìäÂ±ïÈñãÊü•ÁúãÂë®ÈÇäÈ§êÂª≥' : 'ÈªûÊìäÊñ∞Â¢ûÈ§êÂª≥Âè£Ë¢ãÂêçÂñÆ')}</div>
                            </div>
                        </div>
                        <i className={`fa-solid fa-chevron-down text-slate-300 transition-transform ${isOpen ? 'rotate-180' : ''}`}></i>
                    </button>
                    {isOpen && (
                        <div className="space-y-6 animate-fade-in pl-2">
                            <div><div className="flex items-center justify-between mb-2 pr-2"><h5 className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Êó©È§ê</h5></div><div className="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x min-h-[100px]">{mealData.breakfast.map(m => (<RestaurantCard key={m.id} item={m} onClick={() => onEdit('breakfast', m)} />))}<AddCard onClick={() => onAdd('breakfast')} /></div></div>
                            <div><div className="flex items-center justify-between mb-2 pr-2"><h5 className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">ÂçàÈ§ê</h5></div><div className="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x min-h-[100px]">{mealData.lunch.map(m => (<RestaurantCard key={m.id} item={m} onClick={() => onEdit('lunch', m)} />))}<AddCard onClick={() => onAdd('lunch')} /></div></div>
                            <div><div className="flex items-center justify-between mb-2 pr-2"><h5 className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">ÊôöÈ§ê</h5></div><div className="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x min-h-[100px]">{mealData.dinner.map(m => (<RestaurantCard key={m.id} item={m} onClick={() => onEdit('dinner', m)} />))}<AddCard onClick={() => onAdd('dinner')} /></div></div>
                        </div>
                    )}
                </div>
            );
        };

        const MealModal = ({ isOpen, initialData, type, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ name: '', dish: '', priceLevel: '', note: '', url: '', locationUrl: '' });
            useEffect(() => { if (isOpen) setFormData(initialData || { name: '', dish: '', priceLevel: '', note: '', url: '', locationUrl: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            const typeLabel = type === 'breakfast' ? 'Êó©È§ê' : type === 'lunch' ? 'ÂçàÈ§ê' : 'ÊôöÈ§ê';
            return (
                <div className="fixed inset-0 z-[80]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-6 tracking-wide">{initialData ? `Á∑®ËºØ${typeLabel}ÈÅ∏Êìá` : `Êñ∞Â¢û${typeLabel}ÈÅ∏Êìá`}</h3>
                        <div className="space-y-6">
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">È§êÂª≥ÂêçÁ®±</label><input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} placeholder="‰æãÂ¶ÇÔºö‰∏ÄËò≠ÊãâÈ∫µ" className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div className="flex gap-4"><div className="flex-[2]"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Êé®Ëñ¶È§êÈªû</label><input type="text" value={formData.dish} onChange={(e) => setFormData({...formData, dish: e.target.value})} placeholder="‰æãÂ¶ÇÔºöË±öÈ™®ÊãâÈ∫µ" className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÂÉπ‰Ωç</label><input type="text" value={formData.priceLevel} onChange={(e) => setFormData({...formData, priceLevel: e.target.value})} placeholder="¬•1000" className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none font-mono" /></div></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Google Maps ÈÄ£Áµê (ÈÅ∏Â°´)</label><input type="text" value={formData.locationUrl || ''} onChange={(e) => setFormData({...formData, locationUrl: e.target.value})} placeholder="https://maps..." className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Á∂≤Á´ô/È£üË®òÈÄ£Áµê (ÈÅ∏Â°´)</label><input type="text" value={formData.url || ''} onChange={(e) => setFormData({...formData, url: e.target.value})} placeholder="https://..." className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Á≠ÜË®ò</label><textarea value={formData.note || ''} onChange={(e) => setFormData({...formData, note: e.target.value})} rows={2} placeholder="ÂøÖÈªû„ÄÅÊéíÈöäÊîªÁï•..." className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none"></textarea></div>
                        </div>
                        <div className="mt-8 flex gap-4">
                            {initialData && onDelete && (<button type="button" onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle active:bg-red-50 transition-colors tracking-wider">Âà™Èô§</button>)}
                            <button type="button" onClick={() => { if (!formData.name) return; onSave({ id: initialData?.id || generateId(), name: formData.name, dish: formData.dish || '', priceLevel: formData.priceLevel || '', note: formData.note, url: formData.url, locationUrl: formData.locationUrl }); }} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl active:scale-[0.98] transition-transform tracking-wider shadow-lg shadow-matcha/20">ÂÑ≤Â≠ò</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EventModal = ({ isOpen, initialData, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ time: '09:00', type: 'sight', title: '', loc: '', image: '', desc: '', subItems: [] });
            const [newSubText, setNewSubText] = useState('');
            const [newSubType, setNewSubType] = useState('buy');
            useEffect(() => { if (isOpen) { setFormData(initialData || { time: '09:00', type: 'sight', title: '', loc: '', image: '', desc: '', subItems: [] }); setNewSubText(''); } }, [isOpen, initialData]);
            const handleAddSubItem = () => {
                if (!newSubText.trim()) return;
                const newItem = { id: generateId(), type: newSubType, text: newSubText, checked: false };
                setFormData(prev => ({ ...prev, subItems: [...(prev.subItems || []), newItem] }));
                setNewSubText('');
            };
            const removeSubItem = (id) => { setFormData(prev => ({ ...prev, subItems: (prev.subItems || []).filter(i => i.id !== id) })); };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl transform transition-transform duration-300 h-[90vh] flex flex-col animate-slide-up">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-8 tracking-wide">{initialData ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã'}</h3>
                        <div className="space-y-6 flex-1 overflow-y-auto hide-scrollbar">
                            <div className="flex gap-4">
                                <div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÊôÇÈñì</label><input type="time" value={formData.time} onChange={(e) => setFormData({...formData, time: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 font-mono text-lg focus:border-matcha outline-none transition-colors" /></div>
                                <div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">È°ûÂûã</label><select value={formData.type} onChange={(e) => setFormData({...formData, type: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-lg focus:border-matcha outline-none"><option value="sight">üì∑ ÊôØÈªû</option><option value="food">üçú ÁæéÈ£ü</option><option value="transport">üöÖ ‰∫§ÈÄö</option><option value="hotel">üè® ‰ΩèÂÆø</option></select></div>
                            </div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Ê®ôÈ°å</label><input type="text" value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})} placeholder="Ë´ãËº∏ÂÖ•Ê®ôÈ°å" className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Âú∞Èªû</label><input type="text" value={formData.loc} onChange={(e) => setFormData({...formData, loc: e.target.value})} placeholder="‰æãÂ¶ÇÔºöÊ∑∫Ëçâ" className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div className="bg-white p-4 rounded-xl border border-subtle"><label className="text-xs uppercase font-bold text-slate-400 block mb-3">Â≠êÈ†ÖÁõÆ (ÂøÖÂêÉ/ÂøÖË≤∑)</label><div className="flex gap-2 mb-3"><select value={newSubType} onChange={(e) => setNewSubType(e.target.value)} className="bg-slate-100 rounded-lg text-xs p-2 outline-none"><option value="buy">üõçÔ∏è</option><option value="eat">üç¥</option><option value="do">‚ú®</option></select><input type="text" value={newSubText} onChange={(e) => setNewSubText(e.target.value)} placeholder="Êñ∞Â¢ûÂ≠êÈ†ÖÁõÆ..." className="flex-1 bg-slate-50 border-b border-subtle px-2 text-sm focus:border-matcha outline-none" /><button onClick={handleAddSubItem} type="button" className="text-matcha font-bold px-2">+</button></div><div className="space-y-2">{formData.subItems?.map(item => (<div key={item.id} className="flex justify-between items-center text-sm bg-slate-50 p-2 rounded"><span>{item.type === 'buy' ? 'üõçÔ∏è' : item.type === 'eat' ? 'üç¥' : '‚ú®'} {item.text}</span><button type="button" onClick={() => removeSubItem(item.id)} className="text-red-400"><i className="fa-solid fa-xmark"></i></button></div>))}</div></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">Á≠ÜË®ò</label><textarea value={formData.desc || ''} onChange={(e) => setFormData({...formData, desc: e.target.value})} rows={3} placeholder="ÂØ´Èªû‰ªÄÈ∫º..." className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none"></textarea></div>
                        </div>
                        <div className="mt-8 flex gap-4">
                            {initialData && onDelete && (<button type="button" onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle active:bg-red-50 transition-colors tracking-wider">Âà™Èô§</button>)}
                            <button type="button" onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl active:scale-[0.98] transition-transform tracking-wider shadow-lg shadow-matcha/20">ÂÑ≤Â≠ò</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DetailModal = ({ event, onClose, onEdit }) => {
            if (!event) return null;
            return (
                <div className="fixed inset-0 z-[60]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-white rounded-t-[24px] overflow-hidden shadow-2xl max-h-[92vh] overflow-y-auto animate-slide-up">
                        <div className="relative h-72">
                            <img src={event.image || 'https://images.unsplash.com/photo-1480796927426-f609979314bd?q=80&w=800&auto=format&fit=crop'} className="w-full h-full object-cover" alt={event.title} onError={(e) => e.target.src = 'https://placehold.co/600x400/eceae6/a0a09e?text=NO+IMAGE'} />
                            <div className="absolute inset-0 bg-gradient-to-t from-charcoal/80 via-charcoal/20 to-transparent"></div>
                            <button onClick={onClose} className="absolute top-5 right-5 bg-black/20 text-white/90 rounded-full w-8 h-8 flex items-center justify-center backdrop-blur-md active:bg-black/40 transition-colors"><i className="fa-solid fa-xmark"></i></button>
                            <div className="absolute bottom-6 left-6 text-white pr-4">
                                <span className="text-[10px] font-bold px-2 py-1 bg-white/20 backdrop-blur-md rounded mb-3 inline-block tracking-wider uppercase">{event.type}</span>
                                <h2 className="text-3xl font-bold leading-tight tracking-wide drop-shadow-md">{event.title}</h2>
                                <p className="text-sm opacity-90 mt-2 font-medium flex items-center"><i className="fa-solid fa-location-dot mr-1.5 text-xs"></i>{event.loc || 'Êú™Áü•Âú∞Èªû'}</p>
                            </div>
                            <button onClick={onEdit} className="absolute -bottom-6 right-6 bg-matcha text-white rounded-2xl w-12 h-12 flex items-center justify-center shadow-lg active:scale-95 transition-transform z-20"><i className="fa-solid fa-pen"></i></button>
                        </div>
                        <div className="p-8 pt-12 pb-28 space-y-6 bg-rice">
                            {event.subItems && event.subItems.length > 0 && (<div className="mb-6"><h4 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-widest">ÂøÖÂÅöÊ∏ÖÂñÆ</h4><div className="space-y-2">{event.subItems.map(item => (<div key={item.id} className="flex items-center gap-3 bg-white p-3 rounded-xl border border-subtle"><div className={`w-5 h-5 rounded flex items-center justify-center text-[10px] ${item.checked ? 'bg-matcha text-white' : 'bg-slate-100 text-slate-400'}`}>{item.checked && <i className="fa-solid fa-check"></i>}</div><span className={`text-sm ${item.checked ? 'line-through text-slate-400' : 'text-charcoal'}`}>{item.type === 'buy' ? 'üõçÔ∏è' : item.type === 'eat' ? 'üç¥' : '‚ú®'} {item.text}</span></div>))}</div></div>)}
                            {event.tags && (<div className="flex flex-wrap gap-2">{event.tags.map(tag => (<span key={tag} className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold tracking-wider">#{tag}</span>))}</div>)}
                            <div className="text-charcoal leading-relaxed tracking-wide"><h4 className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">ÈóúÊñº</h4><p className="whitespace-pre-line">{event.desc || 'Êö´ÁÑ°Ë©≥Á¥∞ÊèèËø∞„ÄÇ'}</p></div>
                            {event.note && (<div className="bg-[#f4f1e8] p-4 rounded-xl border-l-2 border-matcha"><p className="text-xs font-bold text-matcha uppercase mb-1 tracking-widest">TIPS</p><p className="text-sm text-charcoal/80">{event.note}</p></div>)}
                            <div className="flex gap-4 pt-4"><a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((event.loc || '') + ' ' + event.title)}`} target="_blank" rel="noreferrer" className="flex-1 border border-subtle text-charcoal py-3.5 rounded-2xl font-bold text-center active:bg-slate-50 transition-colors text-sm tracking-wider">Â∞éËà™</a><a href={`https://www.google.com/search?q=${encodeURIComponent(event.title)}`} target="_blank" rel="noreferrer" className="flex-1 bg-charcoal text-white py-3.5 rounded-2xl font-bold text-center active:bg-charcoal/90 transition-colors text-sm tracking-wider">ÊêúÂ∞ã</a></div>
                        </div>
                    </div>
                </div>
            );
        };

        const TransportModal = ({ isOpen, initialData, onClose, onSave }) => {
            const [formData, setFormData] = useState({ mode: 'train', duration: '10m', note: '', url: '' });
            useEffect(() => { if (isOpen) setFormData(initialData || { mode: 'train', duration: '15m', note: '', url: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[75]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-6 pb-safe shadow-2xl animate-slide-up">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-6"></div>
                        <h3 className="text-lg font-bold text-charcoal mb-6">‰∫§ÈÄöÊñπÂºè</h3>
                        <div className="space-y-4">
                            <div className="flex gap-4"><div className="flex-1"><label className="text-xs font-bold text-slate-400 block mb-1">ÊñπÂºè</label><select value={formData.mode} onChange={(e) => setFormData({...formData, mode: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none"><option value="train">ÈõªËªä/Âú∞Èêµ</option><option value="walk">Ê≠•Ë°å</option><option value="taxi">Ë®àÁ®ãËªä</option><option value="bus">Â∑¥Â£´</option><option value="other">ÂÖ∂‰ªñ</option></select></div><div className="flex-1"><label className="text-xs font-bold text-slate-400 block mb-1">È†ê‰º∞ÊôÇÈñì</label><input type="text" value={formData.duration} onChange={(e) => setFormData({...formData, duration: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" placeholder="ex: 15m" /></div></div>
                            <div><label className="text-xs font-bold text-slate-400 block mb-1">Ë™™Êòé</label><input type="text" value={formData.note || ''} onChange={(e) => setFormData({...formData, note: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" placeholder="ex: Â±±ÊâãÁ∑ö (Â§ñÂõû)" /></div>
                            <div><label className="text-xs font-bold text-slate-400 block mb-1">Google Maps ÈÄ£Áµê</label><input type="text" value={formData.url || ''} onChange={(e) => setFormData({...formData, url: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none text-sm" placeholder="https://maps.app.goo.gl/..." /></div>
                            <div className="flex gap-3 pt-2">{formData.url && (<a href={formData.url} target="_blank" rel="noreferrer" className="flex-1 border border-subtle text-slate-500 py-3 rounded-xl font-bold text-center">ÈñãÂïüÂú∞Âúñ</a>)}<button onClick={() => onSave(undefined)} className="flex-1 text-red-400 border border-red-100 py-3 rounded-xl font-bold">Ê∏ÖÈô§</button><button onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white py-3 rounded-xl font-bold shadow-lg shadow-matcha/20">ÂÑ≤Â≠ò</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const InfoView = ({ reservations, onEdit, onAdd }) => {
            const getStatusColor = (status) => { switch(status) { case 'booked': return 'bg-matcha/10 text-matcha'; case 'to-book': return 'bg-orange-100 text-orange-500'; default: return 'bg-slate-100 text-slate-500'; } };
            const getStatusText = (status) => { switch(status) { case 'booked': return 'Â∑≤È†êË®Ç'; case 'to-book': return 'ÂæÖÈ†êË®Ç'; default: return 'ËôïÁêÜ‰∏≠'; } };
            const getTypeIcon = (type) => { switch(type) { case 'flight': return 'fa-plane'; case 'hotel': return 'fa-bed'; case 'restaurant': return 'fa-utensils'; default: return 'fa-ticket'; } };
            return (
                <div className="px-6 space-y-6 pb-24 tracking-wide pt-6">
                    <div className="grid grid-cols-2 gap-4"><a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" rel="noreferrer" className="bg-blue-50 p-4 rounded-2xl flex flex-col items-center justify-center text-center active:scale-95 transition-transform border border-blue-100"><i className="fa-solid fa-qrcode text-2xl text-blue-500 mb-2"></i><span className="text-xs font-bold text-blue-900">Visit Japan Web</span></a><a href="https://www.google.com/maps" target="_blank" rel="noreferrer" className="bg-green-50 p-4 rounded-2xl flex flex-col items-center justify-center text-center active:scale-95 transition-transform border border-green-100"><i className="fa-solid fa-map-location-dot text-2xl text-green-600 mb-2"></i><span className="text-xs font-bold text-green-900">Google Maps</span></a></div>
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-subtle"><h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Á∑äÊÄ•ËÅØÁµ°</h3><div className="space-y-4"><div className="flex justify-between items-center border-b border-slate-50 pb-3"><div><div className="font-bold text-charcoal">ÊóÖÂ§ñÂúã‰∫∫ÊÄ•Èõ£ÊïëÂä©</div><div className="text-xs text-slate-400 mt-1">Êó•Êú¨Â¢ÉÂÖßÁõ¥Êí•</div></div><a href="tel:08010097179" className="text-red-500 font-mono font-bold text-lg">080-1009-7179</a></div><div className="flex justify-between items-center"><div className="flex gap-4"><div><span className="text-xs text-slate-400 block">Â†±Ë≠¶</span><span className="font-bold text-xl">110</span></div><div><span className="text-xs text-slate-400 block">ÊïëË≠∑</span><span className="font-bold text-xl">119</span></div></div></div></div></div>
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-subtle"><div className="flex justify-between items-center mb-4"><h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest">È†êË®ÇËàáÁ•®Âà∏</h3><button onClick={onAdd} className="text-xs bg-[#f4f1e8] text-matcha px-3 py-1 rounded-full font-bold hover:bg-subtle transition-colors"><i className="fa-solid fa-plus mr-1"></i>Êñ∞Â¢û</button></div><div className="space-y-6">{reservations.map(res => (<div key={res.id} onClick={() => onEdit(res)} className="relative pl-4 border-l-2 border-slate-100 cursor-pointer active:opacity-70 transition-opacity group"><div className="absolute left-[-5px] top-0 w-2 h-2 rounded-full bg-slate-200 group-hover:bg-matcha transition-colors"></div><div className="flex justify-between items-start mb-1"><span className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><i className={`fa-solid ${getTypeIcon(res.type)} text-[10px]`}></i> {res.type}</span><span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${getStatusColor(res.status)}`}>{getStatusText(res.status)}</span></div><div className="text-base font-bold text-charcoal">{res.name}</div><div className="text-sm text-slate-500 mt-1 font-mono">{res.dateTime}</div>{res.refNumber && <div className="text-xs font-mono text-slate-400 mt-1">REF: {res.refNumber}</div>}{res.notes && <div className="text-xs text-matcha mt-1 bg-matcha/5 p-2 rounded">{res.notes}</div>}</div>))}{reservations.length === 0 && <div className="text-center text-slate-300 text-sm py-2">Â∞öÁÑ°È†êË®ÇÁ¥ÄÈåÑ</div>}</div></div>
                </div>
            );
        };

        const ReservationModal = ({ isOpen, initialData, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ type: 'ticket', name: '', status: 'pending', dateTime: '', refNumber: '', notes: '', url: '' });
            useEffect(() => { if (isOpen) setFormData(initialData || { type: 'ticket', name: '', status: 'pending', dateTime: '', refNumber: '', notes: '', url: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl transform transition-transform duration-300 max-h-[90vh] flex flex-col overflow-y-auto animate-slide-up">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8 flex-shrink-0"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-6 tracking-wide flex-shrink-0">{initialData ? 'Á∑®ËºØÈ†êË®Ç' : 'Êñ∞Â¢ûÈ†êË®Ç'}</h3>
                        <div className="space-y-6 flex-1 overflow-y-auto hide-scrollbar pb-4">
                            <div className="flex gap-4"><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">È°ûÂûã</label><select value={formData.type} onChange={(e) => setFormData({...formData, type: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none"><option value="flight">‚úàÔ∏è Ëà™Áè≠</option><option value="hotel">üè® ‰ΩèÂÆø</option><option value="restaurant">üçΩÔ∏è È§êÂª≥</option><option value="ticket">üé´ Á•®Âà∏</option></select></div><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÁãÄÊÖã</label><select value={formData.status} onChange={(e) => setFormData({...formData, status: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none"><option value="booked">‚úÖ Â∑≤È†êË®Ç</option><option value="pending">‚è≥ ËôïÁêÜ‰∏≠</option><option value="to-book">‚ö†Ô∏è ÂæÖÈ†êË®Ç</option></select></div></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÂêçÁ®±</label><input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} placeholder="‰æãÂ¶ÇÔºöSkyliner ËªäÁ•®" className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÊôÇÈñì / Êó•Êúü</label><input type="text" value={formData.dateTime} onChange={(e) => setFormData({...formData, dateTime: e.target.value})} placeholder="‰æãÂ¶ÇÔºö1/28 14:00" className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÂèÉËÄÉÁ∑®Ëôü (ÈÅ∏Â°´)</label><input type="text" value={formData.refNumber || ''} onChange={(e) => setFormData({...formData, refNumber: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base font-mono focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ÂÇôË®ª</label><textarea value={formData.notes || ''} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none" /></div>
                        </div>
                        <div className="mt-8 flex gap-4 flex-shrink-0">
                            {initialData && onDelete && (<button type="button" onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle active:bg-red-50 transition-colors tracking-wider">Âà™Èô§</button>)}
                            <button type="button" onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl active:scale-[0.98] transition-transform tracking-wider shadow-lg shadow-matcha/20">ÂÑ≤Â≠ò</button>
                        </div>
                    </div>
                </div>
            );
        };

        const PackingListView = ({ items, onToggle, onAdd, onDelete }) => {
            const [newItemText, setNewItemText] = useState('');
            const grouped = items.reduce((acc, item) => { if (!acc[item.category]) acc[item.category] = []; acc[item.category].push(item); return acc; }, {});
            const progress = items.length > 0 ? Math.round((items.filter(i => i.checked).length / items.length) * 100) : 0;
            const handleQuickAdd = (e) => { e.preventDefault(); if (newItemText.trim()) { onAdd(newItemText, 'Ëá™Ë®Ç'); setNewItemText(''); } };
            return (
                <div className="px-6 pb-32 pt-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-subtle mb-8"><div className="flex justify-between items-end mb-2"><h2 className="text-lg font-bold text-charcoal">Ë°åÊùéÊ∏ÖÂñÆ</h2><span className="text-2xl font-mono font-bold text-matcha">{progress}%</span></div><div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-matcha transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div></div></div>
                    <form onSubmit={handleQuickAdd} className="mb-8 relative"><input type="text" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} placeholder="Êñ∞Â¢ûÁâ©ÂìÅ..." className="w-full bg-rice border border-subtle rounded-xl py-3 pl-4 pr-12 focus:border-matcha focus:bg-white transition-all outline-none" /><button type="submit" className="absolute right-2 top-2 w-8 h-8 bg-matcha text-white rounded-lg flex items-center justify-center active:scale-95 transition-transform"><i className="fa-solid fa-plus text-xs"></i></button></form>
                    <div className="space-y-8">{Object.entries(grouped).map(([category, groupItems]) => (<div key={category}><h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3 pl-1">{category}</h3><div className="bg-white rounded-2xl overflow-hidden border border-subtle divide-y divide-subtle">{groupItems.map(item => (<div key={item.id} className="p-4 flex items-center group relative"><div className="flex-1 flex items-center cursor-pointer" onClick={() => onToggle(item.id)}><div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center mr-4 transition-colors flex-shrink-0 ${item.checked ? 'bg-matcha border-matcha' : 'border-slate-300'}`}>{item.checked && <i className="fa-solid fa-check text-white text-xs"></i>}</div><span className={`flex-1 font-medium transition-opacity ${item.checked ? 'text-slate-400 line-through opacity-70' : 'text-charcoal'}`}>{item.text}</span></div><button onClick={() => onDelete(item.id)} className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-400 transition-colors"><i className="fa-solid fa-trash-can"></i></button></div>))}</div></div>))}</div>
                </div>
            );
        };

        const MoneyView = ({ expenses, members, currencyRate, currentCurrency, onDelete }) => {
            const balances = {}; members.forEach(m => balances[m] = 0);
            let totalSpent = 0;
            expenses.forEach(ex => { totalSpent += ex.amount; balances[ex.payer] += ex.amount; const share = ex.amount / ex.involved.length; ex.involved.forEach(p => { balances[p] -= share; }); });
            const formatMoney = (amount) => { if (currentCurrency === 'JPY') return `¬•${Math.round(amount).toLocaleString()}`; return `NT$${Math.round(amount * currencyRate).toLocaleString()}`; };
            return (
                <div className="px-6 pb-32 tracking-wide pt-6">
                    <div className="mb-10 text-center"><span className="text-xs text-slate-400 uppercase font-bold tracking-widest">Total Expenses</span><div className="text-4xl font-black mt-2 text-charcoal font-mono">¬•{totalSpent.toLocaleString()}</div><div className="text-sm text-slate-500 mt-2 font-medium">‚âà NT${Math.round(totalSpent * currencyRate).toLocaleString()}`;</div></div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 px-1">Balances</h3><div className="grid grid-cols-3 gap-4 mb-10">{Object.keys(balances).map(m => { const bal = balances[m]; const isPos = bal >= 0; return (<div key={m} className={`rounded-xl p-4 text-center border border-subtle ${isPos ? 'bg-[#f0f4ef]' : 'bg-red-50'}`}><div className="text-xs text-slate-500 font-bold mb-2">{m}</div><div className={`font-bold text-base font-mono ${isPos ? 'text-matcha' : 'text-red-400'}`}>{formatMoney(Math.abs(bal))}</div><div className={`text-[10px] opacity-70 mt-1 font-medium ${isPos ? 'text-matcha' : 'text-red-400'}`}>{isPos ? 'Êî∂' : '‰ªò'}</div></div>); })}</div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 px-1">History</h3><div className="bg-white rounded-2xl border border-subtle divide-y divide-subtle">{expenses.length === 0 ? (<div className="text-center text-slate-300 py-8 text-sm font-medium">Â∞öÁÑ°Ê∂àË≤ªÁ¥ÄÈåÑ</div>) : ([...expenses].reverse().map((ex) => (<div key={ex.id} className="flex justify-between items-center p-4"><div><div className="font-bold text-charcoal text-base">{ex.title}</div><div className="text-xs text-slate-400 mt-1 font-medium">Áî± <span className="text-slate-600">{ex.payer}</span> ÊîØ‰ªò</div></div><div className="text-right"><div className="font-bold text-charcoal font-mono">¬•{ex.amount.toLocaleString()}</div><button onClick={() => onDelete(ex.id)} className="text-xs text-slate-300 mt-2 px-2 py-1 hover:text-red-400 transition-colors">Âà™Èô§</button></div></div>)))}</div>
                </div>
            );
        };

        const ItineraryView = ({ days, currentDayIdx, onDaySelect, onEventClick, onTransportClick, onAddEvent, onAddMeal, onEditMeal }) => {
            const isManualScroll = useRef(false);
            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    if (isManualScroll.current) return;
                    const visibleDay = entries.find(e => e.isIntersecting);
                    if (visibleDay) {
                        const id = visibleDay.target.id;
                        const idx = parseInt(id.replace('day-', ''));
                        if (!isNaN(idx) && idx !== currentDayIdx) onDaySelect(idx); 
                    }
                }, { root: null, rootMargin: '-40% 0px -50% 0px', threshold: 0 });
                days.forEach((_, idx) => { const el = document.getElementById(`day-${idx}`); if (el) observer.observe(el); });
                return () => observer.disconnect();
            }, [days, currentDayIdx, onDaySelect]);
            const handleDayClick = (idx) => {
                isManualScroll.current = true;
                onDaySelect(idx);
                const el = document.getElementById(`day-${idx}`);
                if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); setTimeout(() => { isManualScroll.current = false; }, 600); }
            };
            return (
                <div className="px-6 pb-32">
                    <div className="flex overflow-x-auto gap-5 py-4 hide-scrollbar sticky top-[60px] z-30 bg-rice/95 backdrop-blur -mx-6 px-6 mb-6 transition-all">{days.map((day, idx) => (<button key={idx} onClick={() => handleDayClick(idx)} className={`flex-shrink-0 text-center min-w-[48px] transition-all duration-300 group ${currentDayIdx === idx ? 'text-matcha scale-110' : 'text-slate-400 opacity-70'}`}><div className="text-[10px] font-bold uppercase tracking-widest mb-1">{day.weekday}</div><div className="text-xl font-bold font-mono relative">{day.date.split('/')[1] || day.date}{currentDayIdx === idx && (<div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-matcha"></div>)}</div></button>))}</div>
                    <div className="space-y-12">{days.map((day, dIdx) => (<div id={`day-${dIdx}`} key={dIdx} className="scroll-mt-40 transition-opacity duration-500"><div className="mb-6 px-1"><div className="flex items-center justify-between"><span className="text-xs font-bold text-slate-400 tracking-widest uppercase">{day.date} ¬∑ {day.weekday}</span><span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md"><i className="fa-solid fa-cloud-sun mr-1"></i>{day.weather}</span></div><h2 className="text-2xl font-bold text-charcoal mt-2 tracking-wide">{day.title}</h2></div><MealOptions mealData={day.mealOptions} onAdd={(type) => onAddMeal(dIdx, type)} onEdit={(type, option) => onEditMeal(dIdx, type, option)} /><div className="relative ml-2.5 pl-8 space-y-0 pb-4"><div className="absolute left-[10px] top-4 bottom-4 w-0.5 bg-slate-100 -z-10"></div>{day.events.map((ev, eIdx) => (<div key={ev.id}><EventCard event={ev} onClick={() => onEventClick(dIdx, ev)} />{eIdx < day.events.length - 1 && (<TransportConnector data={ev.transitToNext} onClick={() => onTransportClick(dIdx, ev.id)} />)}</div>))}<div className="h-8 border-l-2 border-slate-100 ml-[10px]"></div><button onClick={() => onAddEvent(dIdx)} className="w-full py-4 border-2 border-dashed border-subtle rounded-xl text-slate-400 text-sm font-bold hover:border-matcha hover:text-matcha transition-colors">+ Êñ∞Â¢ûË°åÁ®ã</button></div></div>))}</div>
                </div>
            );
        };

        const App = () => {
            const STORAGE_KEY = 'tokyoTripFinal_V9_Bundle';
            const [view, setView] = useState('itinerary');
            const [data, setData] = useState(DEFAULT_DATA);
            const [currentDayIdx, setCurrentDayIdx] = useState(0);
            const [currency, setCurrency] = useState('JPY');
            const [liveWeather, setLiveWeather] = useState(null);
            
            const [detailEvent, setDetailEvent] = useState(null);
            const [editingEvent, setEditingEvent] = useState(null);
            const [editingTransport, setEditingTransport] = useState(null);
            const [editingMeal, setEditingMeal] = useState(null);
            const [editingReservation, setEditingReservation] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.days) {
                            parsed.days.forEach((day) => {
                                if (!day.mealOptions) day.mealOptions = { breakfast: [], lunch: [], dinner: [] };
                                day.events.forEach((ev) => { if (!ev.subItems) ev.subItems = []; });
                            });
                        }
                        setData({ ...DEFAULT_DATA, ...parsed });
                    } catch (e) { console.error("Data load failed", e); }
                }
            }, []);
            useEffect(() => { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }, [data]);
            useEffect(() => {
                const currentDay = data.days[currentDayIdx];
                if (currentDay && currentDay.locationKey) {
                    const loc = LOCATIONS[currentDay.locationKey];
                    if (loc) {
                        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true`).then(res => res.json()).then(d => { if(d.current_weather) { setLiveWeather({ temp: Math.round(d.current_weather.temperature), code: d.current_weather.weathercode }); } }).catch(e => console.error(e));
                    }
                }
            }, [currentDayIdx, data.days]);

            const handleSaveEvent = (eventData) => {
                if (!editingEvent) return;
                const newData = { ...data };
                if (editingEvent.eventId) {
                    const dayEvents = newData.days[editingEvent.dayIdx].events;
                    const idx = dayEvents.findIndex(e => e.id === editingEvent.eventId);
                    if (idx >= 0) dayEvents[idx] = { ...dayEvents[idx], ...eventData };
                } else {
                    newData.days[editingEvent.dayIdx].events.push({ ...eventData, id: generateId() });
                    newData.days[editingEvent.dayIdx].events.sort((a, b) => a.time.localeCompare(b.time));
                }
                setData(newData);
                setEditingEvent(null);
                setDetailEvent(null);
            };
            const handleDeleteEvent = () => {
                if (!editingEvent?.eventId) return;
                Swal.fire({ title: 'Á¢∫ÂÆöÂà™Èô§?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Âà™Èô§', cancelButtonText: 'ÂèñÊ∂à', confirmButtonColor: '#ef4444' }).then((result) => {
                    if (result.isConfirmed) {
                        const newData = { ...data };
                        newData.days[editingEvent.dayIdx].events = newData.days[editingEvent.dayIdx].events.filter(e => e.id !== editingEvent.eventId);
                        setData(newData);
                        setEditingEvent(null);
                    }
                });
            };
            const handleSaveTransport = (transportData) => {
                if (!editingTransport) return;
                const newData = { ...data };
                const dayEvents = newData.days[editingTransport.dayIdx].events;
                const idx = dayEvents.findIndex(e => e.id === editingTransport.eventId);
                if (idx >= 0) { dayEvents[idx].transitToNext = transportData; }
                setData(newData);
                setEditingTransport(null);
            };
            const handleSaveMeal = (mealData) => {
                if (!editingMeal) return;
                const newData = { ...data };
                const list = newData.days[editingMeal.dayIdx].mealOptions[editingMeal.type];
                if (editingMeal.option) { const idx = list.findIndex(m => m.id === editingMeal.option.id); if (idx >= 0) list[idx] = mealData; } else { list.push(mealData); }
                setData(newData);
                setEditingMeal(null);
            };
            const handleDeleteMeal = () => {
                if (!editingMeal?.option) return;
                Swal.fire({ title: 'Á¢∫ÂÆöÂà™Èô§?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Âà™Èô§', cancelButtonText: 'ÂèñÊ∂à', confirmButtonColor: '#ef4444' }).then((result) => {
                    if (result.isConfirmed) {
                        const newData = { ...data };
                        const list = newData.days[editingMeal.dayIdx].mealOptions[editingMeal.type];
                        newData.days[editingMeal.dayIdx].mealOptions[editingMeal.type] = list.filter(m => m.id !== editingMeal.option.id);
                        setData(newData);
                        setEditingMeal(null);
                    }
                });
            }
            const handleSaveReservation = (resData) => {
                const newData = { ...data };
                if (editingReservation?.id) { const idx = newData.reservations.findIndex(r => r.id === editingReservation.id); if (idx >= 0) newData.reservations[idx] = { ...newData.reservations[idx], ...resData }; } else { newData.reservations.push({ ...resData, id: generateId() }); }
                setData(newData);
                setEditingReservation(null);
            };
            const handleDeleteReservation = () => {
                if (!editingReservation?.id) return;
                Swal.fire({ title: 'Á¢∫ÂÆöÂà™Èô§?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Âà™Èô§', cancelButtonText: 'ÂèñÊ∂à', confirmButtonColor: '#ef4444' }).then((result) => { if (result.isConfirmed) { const newData = { ...data }; newData.reservations = newData.reservations.filter(r => r.id !== editingReservation.id); setData(newData); setEditingReservation(null); } });
            };
            const handleTogglePacking = (id) => { const newData = { ...data }; const item = newData.packingList.find(i => i.id === id); if (item) item.checked = !item.checked; setData(newData); };
            const handleAddPackingItem = (text, category) => { const newData = { ...data }; newData.packingList.push({ id: generateId(), text, category, checked: false }); setData(newData); };
            const handleDeletePackingItem = (id) => { const newData = { ...data }; newData.packingList = newData.packingList.filter(i => i.id !== id); setData(newData); };
            const handleAddExpense = async () => {
                const { value: formValues } = await Swal.fire({
                    title: '<span class="text-charcoal font-bold">Êñ∞Â¢ûÊîØÂá∫ (JPY)</span>',
                    html: `
                        <div class="space-y-4 text-left">
                            <input id="swal-item" class="w-full p-2 border-b border-subtle outline-none font-medium" placeholder="È†ÖÁõÆ (Â¶Ç: ÊôöÈ§ê)">
                            <input id="swal-amount" type="number" class="w-full p-2 border-b border-subtle outline-none font-mono font-bold" placeholder="ÈáëÈ°ç (Êó•Âπ£)">
                            <div class="pt-2"><label class="text-xs font-bold text-slate-400 uppercase tracking-widest">ÂÖà‰ªòËÄÖ</label><select id="swal-payer" class="w-full p-2 border-b border-subtle outline-none bg-transparent font-medium mt-1">${data.members.map(m => `<option value="${m}">${m}</option>`).join('')}</select></div>
                        </div>
                    `,
                    focusConfirm: false, showCancelButton: true, confirmButtonText: 'Êñ∞Â¢û', cancelButtonText: 'ÂèñÊ∂à', confirmButtonColor: '#6a7f60',
                    preConfirm: () => {
                        const item = document.getElementById('swal-item').value;
                        const amount = document.getElementById('swal-amount').value;
                        const payer = document.getElementById('swal-payer').value;
                        return [item, amount, payer];
                    }
                });
                if (formValues) {
                    const [title, amount, payer] = formValues;
                    if (!title || !amount) return;
                    const newExpense = { id: generateId(), title, amount: parseInt(amount), payer, involved: data.members, date: new Date().toISOString() };
                    setData({ ...data, expenses: [...data.expenses, newExpense] });
                }
            };
            const handleDeleteExpense = (id) => { setData({ ...data, expenses: data.expenses.filter(e => e.id !== id) }); };

            return (
                <div className="min-h-screen bg-rice font-sans text-charcoal">
                    <header className="fixed top-0 w-full z-40 bg-rice/95 backdrop-blur-md transition-all duration-300 pt-safe border-b border-subtle">
                        <div className="flex justify-between items-end px-6 py-4 pb-3">
                            <div><p className="text-xs text-slate-400 font-medium tracking-widest uppercase mb-1">Tokyo Trip</p><h1 className="text-2xl font-bold tracking-wide text-charcoal">Êù±‰∫¨‰∏ÉÊó•</h1></div>
                            <div className="flex items-center gap-3">
                                {liveWeather ? (<div className="text-sm font-medium text-slate-500 flex items-center bg-slate-100 px-3 py-1 rounded-full"><i className={`fa-solid ${getWeatherIcon(liveWeather.code)} text-slate-400 mr-2`}></i><span>{data.days[currentDayIdx].locationKey === 'tokyo' ? 'Êù±‰∫¨' : LOCATIONS[data.days[currentDayIdx].locationKey].name} {liveWeather.temp}¬∞C</span></div>) : (<div className="text-sm font-medium text-slate-300"><i className="fa-solid fa-spinner fa-spin"></i></div>)}
                                <button onClick={() => setCurrency(c => c === 'JPY' ? 'TWD' : 'JPY')} className="text-xs border border-subtle text-slate-500 px-3 py-1.5 rounded-full font-bold active:bg-slate-100 transition-colors tracking-wider">{currency}</button>
                            </div>
                        </div>
                    </header>
                    <main className="pt-24 max-w-lg mx-auto">
                        {view === 'itinerary' && (<ItineraryView days={data.days} currentDayIdx={currentDayIdx} onDaySelect={setCurrentDayIdx} onEventClick={(dIdx, ev) => setDetailEvent({ dayIdx: dIdx, event: ev })} onTransportClick={(dIdx, eId) => setEditingTransport({ dayIdx: dIdx, eventId: eId })} onAddEvent={(dIdx) => setEditingEvent({ dayIdx: dIdx })} onAddMeal={(dIdx, type) => setEditingMeal({ dayIdx: dIdx, type })} onEditMeal={(dIdx, type, option) => setEditingMeal({ dayIdx: dIdx, type, option })} />)}
                        {view === 'info' && (<InfoView reservations={data.reservations} onEdit={(res) => setEditingReservation({ id: res.id, initial: res })} onAdd={() => setEditingReservation({})} />)}
                        {view === 'money' && (<MoneyView expenses={data.expenses} members={data.members} currencyRate={data.currencyRate} currentCurrency={currency} onDelete={handleDeleteExpense} />)}
                        {view === 'packing' && (<PackingListView items={data.packingList} onToggle={handleTogglePacking} onAdd={handleAddPackingItem} onDelete={handleDeletePackingItem} />)}
                    </main>
                    <nav className="fixed bottom-0 w-full bg-rice/95 backdrop-blur-md border-t border-subtle pb-safe z-30 max-w-lg mx-auto left-0 right-0">
                        <div className="flex justify-around items-center h-[60px]">
                            <button onClick={() => setView('itinerary')} className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${view === 'itinerary' ? 'text-matcha' : 'text-slate-400'}`}><i className="fa-solid fa-map text-xl mb-0.5"></i><span className="text-[9px] font-bold tracking-wider">Ë°åÁ®ã</span></button>
                            <button onClick={() => setView('packing')} className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${view === 'packing' ? 'text-matcha' : 'text-slate-400'}`}><i className="fa-solid fa-suitcase text-xl mb-0.5"></i><span className="text-[9px] font-bold tracking-wider">Ë°åÊùé</span></button>
                            <button onClick={() => setView('info')} className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${view === 'info' ? 'text-matcha' : 'text-slate-400'}`}><i className="fa-solid fa-book text-xl mb-0.5"></i><span className="text-[9px] font-bold tracking-wider">Ë≥áË®ä</span></button>
                            <button onClick={() => setView('money')} className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${view === 'money' ? 'text-matcha' : 'text-slate-400'}`}><i className="fa-solid fa-coins text-xl mb-0.5"></i><span className="text-[9px] font-bold tracking-wider">ÂàÜÂ∏≥</span></button>
                        </div>
                    </nav>
                    {view === 'itinerary' && (<button onClick={() => setEditingEvent({ dayIdx: currentDayIdx })} className="fixed bottom-24 right-6 w-14 h-14 rounded-2xl bg-matcha shadow-xl shadow-matcha/40 flex items-center justify-center text-white z-40 active:scale-90 transition-transform"><i className="fa-solid fa-plus text-xl"></i></button>)}
                    {view === 'money' && (<button onClick={handleAddExpense} className="fixed bottom-24 right-6 w-14 h-14 rounded-2xl bg-matcha shadow-xl shadow-matcha/40 flex items-center justify-center text-white z-40 active:scale-90 transition-transform"><i className="fa-solid fa-plus text-xl"></i></button>)}
                    <EventModal isOpen={!!editingEvent} initialData={editingEvent?.eventId ? data.days[editingEvent.dayIdx].events.find(e => e.id === editingEvent.eventId) : undefined} onClose={() => setEditingEvent(null)} onSave={handleSaveEvent} onDelete={editingEvent?.eventId ? handleDeleteEvent : undefined} />
                    <DetailModal event={detailEvent ? detailEvent.event : null} onClose={() => setDetailEvent(null)} onEdit={() => { if(detailEvent) { setEditingEvent({ dayIdx: detailEvent.dayIdx, eventId: detailEvent.event.id }); setDetailEvent(null); } }} />
                    <TransportModal isOpen={!!editingTransport} initialData={editingTransport ? data.days[editingTransport.dayIdx].events.find(e => e.id === editingTransport.eventId)?.transitToNext : undefined} onClose={() => setEditingTransport(null)} onSave={handleSaveTransport} />
                    <ReservationModal isOpen={!!editingReservation} initialData={editingReservation?.initial} onClose={() => setEditingReservation(null)} onSave={handleSaveReservation} onDelete={editingReservation?.id ? handleDeleteReservation : undefined} />
                    {editingMeal && (<MealModal isOpen={true} type={editingMeal.type} initialData={editingMeal.option} onClose={() => setEditingMeal(null)} onSave={handleSaveMeal} onDelete={editingMeal.option ? handleDeleteMeal : undefined} />)}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
