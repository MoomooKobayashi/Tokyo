<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ±äº¬ä¸ƒæ—¥è¡Œ 2026</title>
    
    <!-- PWA / Home Screen Settings -->
    <meta name="theme-color" content="#fcfaf7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tokyo Trip">
    
    <!-- Icon Settings (Updated to Klook Image) -->
    <link rel="apple-touch-icon" href="https://res.klook.com/image/upload/fl_lossy.progressive,q_60/Mobile/City/lgra7vcg7b2g3zcts3sl.jpg">
    <link rel="icon" type="image/jpeg" href="https://res.klook.com/image/upload/fl_lossy.progressive,q_60/Mobile/City/lgra7vcg7b2g3zcts3sl.jpg">
    <link rel="manifest" href="manifest.json?v=4">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rice: '#fcfaf7',
                        charcoal: '#3e3a39',
                        matcha: '#6a7f60',
                        'matcha-light': '#8da583',
                        subtle: '#eceae6'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'Noto Sans JP', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            'from': { transform: 'translateY(100%)' },
                            'to': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #fcfaf7;
            color: #3e3a39;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            user-select: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
    
    <!-- Import Map for Firebase -->
    <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "sweetalert2": "https://aistudiocdn.com/sweetalert2@^11.26.3"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- 1. Firebase Logic -->
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, onValue, set } from "firebase/database";

        // --- FIREBASE CONFIG (æ‚¨çš„è¨­å®š) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCMuSoz3MhH4Pxtg9hcWV2aIoXk3Rw2Pbs",
            authDomain: "tokyotrip2026-d2ddc.firebaseapp.com",
            databaseURL: "https://tokyotrip2026-d2ddc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tokyotrip2026-d2ddc",
            storageBucket: "tokyotrip2026-d2ddc.firebasestorage.app",
            messagingSenderId: "144324842672",
            appId: "1:144324842672:web:b82a365e306d1593c51775"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Expose to window for React
        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        
        window.firebaseInitialized = true;
        window.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <!-- 2. React Application -->
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const DATA_VERSION = 2; 

        const MEMBERS = [
            { id: 'm1', name: 'ç¶­å°¼', icon: 'ğŸ»' },
            { id: 'm2', name: 'è€é¼ ', icon: 'ğŸ­' },
            { id: 'm3', name: 'é‡è±¬', icon: 'ğŸ—' },
            { id: 'm4', name: 'å“†å•¦', icon: 'ğŸ±' },
        ];

        const LOCATIONS = {
            tokyo: { lat: 35.6895, lon: 139.6917, name: 'æ±äº¬' },
            yokohama: { lat: 35.4437, lon: 139.6380, name: 'æ©«æ¿±' },
            kamakura: { lat: 35.3192, lon: 139.5467, name: 'éŒå€‰' },
            kawagoe: { lat: 35.9251, lon: 139.4858, name: 'å·è¶Š' },
            nikko: { lat: 36.7199, lon: 139.6982, name: 'æ—¥å…‰' }
        };

        const PHRASES = [
            { jp: "ã™ã¿ã¾ã›ã‚“", ro: "Sumimasen", zh: "ä¸å¥½æ„æ€/å€Ÿé" },
            { jp: "ã‚ã‚ŠãŒã¨ã†", ro: "Arigatou", zh: "è¬è¬" },
            { jp: "ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™", ro: "Kore wo onegaishimasu", zh: "æˆ‘è¦é€™å€‹" },
            { jp: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™", ro: "Okaikei wo onegaishimasu", zh: "éº»ç…©çµå¸³" },
            { jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹", ro: "Toire wa doko desu ka", zh: "å»æ‰€åœ¨å“ªè£¡" },
            { jp: "å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹", ro: "Shashin wo totte mo ii desu ka", zh: "å¯ä»¥æ‹ç…§å—" },
        ];

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const INITIAL_PACKING_LIST = [
            { id: generateId(), category: 'è­‰ä»¶/éŒ¢åŒ…', text: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', checked: false },
            { id: generateId(), category: 'è­‰ä»¶/éŒ¢åŒ…', text: 'æ—¥å¹£ç¾é‡‘', checked: false },
            { id: generateId(), category: 'è­‰ä»¶/éŒ¢åŒ…', text: 'ä¿¡ç”¨å¡ (æµ·å¤–å›é¥‹é«˜)', checked: false },
            { id: generateId(), category: 'è­‰ä»¶/éŒ¢åŒ…', text: 'Visit Japan Web QR Code æˆªåœ–', checked: false },
            { id: generateId(), category: 'é›»å­ç”¢å“', text: 'æ‰‹æ©Ÿ & å……é›»ç·š', checked: false },
            { id: generateId(), category: 'é›»å­ç”¢å“', text: 'è¡Œå‹•é›»æº', checked: false },
            { id: generateId(), category: 'é›»å­ç”¢å“', text: 'ç¶²å¡/æ¼«éŠé–‹é€š', checked: false },
            { id: generateId(), category: 'è¡£ç‰©', text: 'ä¿æš–å¤–å¥— (1-2æœˆå‡æº«5åº¦)', checked: false },
            { id: generateId(), category: 'è¡£ç‰©', text: 'å¥½èµ°çš„é‹', checked: false },
            { id: generateId(), category: 'ç”Ÿæ´»ç”¨å“', text: 'å¸¸å‚™è—¥å“ (æ„Ÿå†’/èƒƒè—¥/OKç¹ƒ)', checked: false },
            { id: generateId(), category: 'ç”Ÿæ´»ç”¨å“', text: 'æŠ˜ç–Šå‚˜', checked: false },
        ];

        const DEFAULT_DATA = {
            version: DATA_VERSION,
            currencyRate: 0.215,
            members: ["æˆ‘", "æ—…ä¼´A", "æ—…ä¼´B"],
            expenses: [],
            packingList: INITIAL_PACKING_LIST,
            reservations: [
                { id: generateId(), type: 'flight', name: 'å»ç¨‹ BR198', status: 'booked', dateTime: '1/28 08:50', refNumber: '6F3X9A', notes: 'æ¡ƒåœ’ T2 -> æˆç”° T1', url: '' },
                { id: generateId(), type: 'flight', name: 'å›ç¨‹ BR197', status: 'booked', dateTime: '2/3 13:00', refNumber: '6F3X9A', notes: 'æˆç”° T1 -> æ¡ƒåœ’ T2', url: '' },
                { id: generateId(), type: 'hotel', name: 'Dormy Inn Kawasaki', status: 'booked', dateTime: '1/28 - 1/30', notes: 'ç¥å¥ˆå·çœŒå·å´å¸‚å·å´åŒºæ±ç”°ç”º9-3 (+81-44-230-5489)', url: 'https://www.google.com/maps/search/?api=1&query=Dormy+Inn+Kawasaki' },
                { id: generateId(), type: 'hotel', name: 'æ±æ©«INN æ·ºè‰è—å‰2è™Ÿåº—', status: 'booked', dateTime: '1/30 - 2/3', notes: 'æ±äº¬éƒ½å°æ±åŒºè”µå‰3-15-5 (+81-3-5821-1045)', url: 'https://www.google.com/maps/search/?api=1&query=Toyoko+Inn+Asakusa+Kuramae' },
            ],
            days: [
                {
                    date: "1/28", weekday: "é€±ä¸‰",
                    title: "æŠµé”èˆ‡æ©«æ¿±æ¸¯å¤œæ™¯",
                    weather: "æ™´æ™‚å¤šé›² 4-11Â°C",
                    locationKey: "yokohama",
                    imageUrl: "yokohama.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "æ©Ÿå ´è²´è³“å®¤/ä¾¿åˆ©å•†åº—", dish: "é£¯ç³°/ä¸‰æ˜æ²»", priceLevel: "Â¥500", url: "", locationUrl: "", note: "å¿«é€Ÿè§£æ±º" }],
                        lunch: [{ id: generateId(), name: "Skyliner ä¾¿ç•¶", dish: "ç‚¸è±¬æ’ä¸‰æ˜æ²»", priceLevel: "Â¥1000", url: "", locationUrl: "", note: "è»Šä¸Šäº«ç”¨" }],
                        dinner: [
                            { id: generateId(), name: "Lazona å·å´å»£å ´", dish: "é‡‘å­åŠä¹‹åŠ©/åˆ©ä¹…ç‰›èˆŒ", priceLevel: "Â¥1500~", url: "https://www.google.com/search?q=Lazona+Kawasaki+Restaurants", locationUrl: "https://maps.google.com/?q=Lazona+Kawasaki", note: "å·å´ç«™ç›´çµï¼Œé¸æ“‡æ¥µå¤š" },
                            { id: generateId(), name: "Bills ç´…ç£šå€‰åº«", dish: "Ricottaé¬†é¤…", priceLevel: "Â¥2500", url: "https://billsjapan.com/jp/æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«", locationUrl: "https://maps.google.com/?q=Bills+Yokohama+Red+Brick", note: "æ°£æ°›ä½³ï¼Œéœ€é ç´„" },
                            { id: generateId(), name: "Afuri æ‹‰éºµ", dish: "æŸšå­é¹½æ‹‰éºµ", priceLevel: "Â¥1200", url: "https://afuri.com/", locationUrl: "https://maps.google.com/?q=Afuri+Yokohama+Landmark", note: "æ©«æ¿±åœ°æ¨™å¡”åº—ï¼Œæ¸…çˆ½ç³»" }
                        ]
                    },
                    events: [
                        { id: generateId(), time: "08:50", type: "transport", title: "èµ·é£› BR198", loc: "æ¡ƒåœ’æ©Ÿå ´ T1", image: "airport.jpg", note: "06:30 é›†åˆ", subItems: [{id: generateId(), type: 'do', text: 'é ˜å–Wifiæ©Ÿ', checked: false}, {id: generateId(), type: 'buy', text: 'å…ç¨…åŒ–å¦å“', checked: false}], transitToNext: { mode: 'other', duration: '3h 30m', note: 'é£›è¡Œæ™‚é–“' } },
                        { id: generateId(), time: "12:55", type: "transport", title: "æŠµé”", loc: "æˆç”°æ©Ÿå ´ T1", image: "narita.jpg", note: "é ˜å– Skyliner, Suica", subItems: [{id: generateId(), type: 'buy', text: 'Suicaå¡ (å„²å€¼Â¥3000)', checked: false}], transitToNext: { mode: 'train', duration: '50m', note: 'Skyliner (æˆç”°->äº¬æˆä¸Šé‡)' } },
                        { id: generateId(), time: "14:00", type: "transport", title: "ç§»å‹•ï¼šæˆç”°â†’å·å´", loc: "Skyliner", image: "skyliner.jpg", note: "è½‰ JR ä¸Šé‡æ±äº¬ç·š", transitToNext: { mode: 'train', duration: '40m', note: 'JR ä¸Šé‡æ±äº¬ç·š (ä¸Šé‡->å·å´)' } },
                        { id: generateId(), time: "16:00", type: "hotel", title: "Check-in", loc: "Dormy Inn", image: "kawasaki_inn.jpg", note: "äº«å—è¿è³“å’–å•¡", subItems: [{id: generateId(), type: 'do', text: 'ç¢ºèªæº«æ³‰é–‹æ”¾æ™‚é–“', checked: false}], transitToNext: { mode: 'train', duration: '20m', note: 'JRäº¬æ¿±æ±åŒ—ç·š (å·å´->æ«»æœ¨ç”º)' } },
                        { id: generateId(), time: "17:30", type: "sight", title: "ç´…ç£šå€‰åº«å…¬åœ’", loc: "æ©«æ¿±", image: "yo.jpg", tags: ["å¿…æ‹:å¤œæ™¯"], desc: "å……æ»¿ç•°åœ‹æƒ…èª¿çš„æ­·å²å€‰åº«ç¾¤ï¼Œé©åˆæ•£æ­¥æ‹ç…§ã€‚", subItems: [{id: generateId(), type: 'buy', text: 'æ©«æ¿±ç„¦ç³–ç‰›å¥¶ç³–', checked: false}, {id: generateId(), type: 'eat', text: 'å´é™½è»’ç‡’è³£', checked: false}], transitToNext: { mode: 'walk', duration: '10m', note: 'æ­¥è¡Œè‡³é‹æ²³å…¬åœ’ç«™' } },
                        { id: generateId(), time: "20:30", type: "sight", title: "æ©«æ¿±ç©ºä¸­çºœè»Š", loc: "æ«»æœ¨ç”ºç«™", image: "air_cabin.jpg", note: "å–®ç¨‹ 1000å††ï¼Œæ¬£è³æ¸¯æœªä¾†å…¨æ™¯ã€‚", subItems: [{id: generateId(), type: 'do', text: 'éŒ„ä¸‹å¤œæ™¯ç¸®æ™‚', checked: false}], transitToNext: { mode: 'train', duration: '15m', note: 'JRäº¬æ¿±æ±åŒ—ç·šå›å·å´' } },
                        { id: generateId(), time: "22:00", type: "food", title: "å¤œé³´æ‹‰éºµ & æº«æ³‰", loc: "Dormy Inn", image: "dormy_ramen.jpg", tags: ["æº«æ³‰","å…è²»æ‹‰éºµ","å…è²»å†°æ£’","ä¹³é…¸é£²æ–™"], desc: "é£¯åº—æ‹›ç‰Œæœå‹™ï¼Œæ³¡æ¹¯å¾Œäº«ç”¨å…è²»é†¬æ²¹æ‹‰éºµã€‚" }
                    ]
                },
                {
                    date: "1/29", weekday: "é€±å››",
                    title: "æ¹˜å—æµ·å²¸èˆ‡æ±Ÿä¹‹å³¶",
                    weather: "æ™´å¤© 5-12Â°C",
                    locationKey: "kamakura",
                    imageUrl: "bridge_enoshima.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "é£¯åº—æ—©é¤", dish: "è‡ªåŠ©é¤", priceLevel: "å·²å«", url: "", locationUrl: "", note: "åƒé£½å†å‡ºç™¼" }],
                        lunch: [{ id: generateId(), name: "Tobiccho æœ¬åº—", dish: "é­©ä»”é­šä¸¼", priceLevel: "Â¥1800", url: "https://tobiccho.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ±Ÿä¹‹å³¶æ’éšŠååº—ï¼Œå¯æŠ½æ•´ç†åˆ¸" }, { id: generateId(), name: "é­šè¦‹äº­", dish: "æµ·é®®ä¸¼", priceLevel: "Â¥2000", url: "https://enoshima-uomitei.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ‡¸å´–é‚Šæˆ¶å¤–åº§ä½ï¼Œæ™¯è‰²ç„¡æ•µ" }],
                        dinner: [{ id: generateId(), name: "AFURI æ©«æ¿±", dish: "æŸšå­æ‹‰éºµ", priceLevel: "Â¥1200", url: "https://afuri.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "å›ç¨‹ç¶“éæ©«æ¿±åƒ" }, { id: generateId(), name: "ç£¯ä¸¸æ°´ç”¢", dish: "èŸ¹å‘³å™Œç”²ç¾…ç‡’", priceLevel: "Â¥2000", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "å·å´ç«™å‰æœ‰åˆ†åº—ï¼Œ24å°æ™‚ç‡Ÿæ¥­" }]
                    },
                    events: [
                        { id: generateId(), time: "09:00", type: "sight", title: "æ–°æ±Ÿä¹‹å³¶æ°´æ—é¤¨", loc: "æ±Ÿä¹‹å³¶", image: "aqu.jpg", tags: ["æ¨è–¦:æ°´æ¯å»³"], desc: "ç›¸æ¨¡ç£å¤§æ°´æ§½èˆ‡å¤¢å¹»æ°´æ¯å»³ã€‚", subItems: [{id: generateId(), type: 'do', text: 'çœ‹æµ·è±šè¡¨æ¼”', checked: false}, {id: generateId(), type: 'buy', text: 'æ°´æ¯ç©å¶', checked: false}], transitToNext: { mode: 'walk', duration: '10m', note: 'æ­¥è¡Œéæ©‹' } },
                        { id: generateId(), time: "11:30", type: "food", title: "ä»²è¦‹ä¸–é€šåƒé€é€", loc: "æ±Ÿä¹‹å³¶è€è¡—", image: "street_enoshima.jpg", tags: ["ç« é­šä»™è²", "é­©ä»”é­š"], desc: "åƒæ‹œæ±Ÿå³¶ç¥ç¤¾ï¼Œè³¼è²·æ‰‹æ‰¶æ¢¯å¥—ç¥¨ï¼Œé‚Šèµ°é‚Šåƒã€‚", subItems: [{id: generateId(), type: 'eat', text: 'æœæ—¥å ‚ æ•´éš»é¾è¦ä»™è²', checked: false}, {id: generateId(), type: 'eat', text: 'ç´€ä¹‹åœ‹å±‹å¥³å¤«é¥…é ­', checked: false}], transitToNext: { mode: 'walk', duration: '20m', note: 'æ­ä¹˜æ‰‹æ‰¶æ¢¯è‡³é ‚ç«¯' } },
                        { id: generateId(), time: "13:00", type: "sight", title: "æµ·è Ÿç‡­å±•æœ›ç‡ˆå¡”", loc: "æ±Ÿä¹‹å³¶é ‚", image: "candle.jpg", desc: "å¤©æ°£å¥½å¯çœºæœ›å¯Œå£«å±±ã€‚", transitToNext: { mode: 'walk', duration: '15m', note: 'å¾€ä¸‹èµ°è‡³å¥§æ´¥å®®æ–¹å‘' } },
                        { id: generateId(), time: "14:00", type: "food", title: "åˆé¤ï¼šé­šè¦‹äº­", loc: "æ±Ÿä¹‹å³¶æ‡¸å´–", image: "restaurant_enoshima.jpg", tags: ["çµ•æ™¯æˆ¶å¤–åº§"], desc: "ååœ¨æ‡¸å´–é‚Šçœ‹æµ·åƒæµ·é®®ä¸¼ï¼Œè¦–é‡æ¥µä½³ã€‚", transitToNext: { mode: 'walk', duration: '10m', note: 'æ­¥è¡Œè‡³å²©å±‹' } },
                        { id: generateId(), time: "15:30", type: "sight", title: "å²©å±‹", loc: "æ±Ÿä¹‹å³¶å¾Œå±±", image: "cave.jpg", desc: "æµ·è•å¹³å°èˆ‡æ´çªŸï¼Œçµ•ç¾å¤•é™½åæ‰€ã€‚", subItems: [{id: generateId(), type: 'do', text: 'æ‹å¯Œå£«å±±å¤•é™½', checked: false}], transitToNext: { mode: 'walk', duration: '20m', note: 'æ­ä¹˜å¼å¤©ä¸¸éŠè¦½èˆ¹å›æ©‹é ­(è¦–é¢¨æµª)' } },
                        { id: generateId(), time: "17:00", type: "transport", title: "æ¹˜å—å–®è»Œé›»è»Š", loc: "æ¹˜å—æ±Ÿä¹‹å³¶", image: "monorail.jpg", note: "å€’æ›å¼é›»è»Šï¼Œåƒé›²éœ„é£›è»Šèˆ¬åˆºæ¿€ã€‚", transitToNext: { mode: 'train', duration: '30m', note: 'å¤§èˆ¹è½‰è»Šå›å·å´' } }
                    ]
                },
                {
                    date: "1/30", weekday: "é€±äº”",
                    title: "éŒå€‰å¤éƒ½èˆ‡æ™´ç©ºå¡”",
                    weather: "å¤šé›² 4-10Â°C",
                    locationKey: "kamakura",
                    imageUrl: "kamakura.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "Bills ä¸ƒé‡Œæ¿±", dish: "Ricottaé¬†é¤…", priceLevel: "Â¥2200", url: "https://billsjapan.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "éœ€æå‰å…©é€±é ç´„çª—é‚Šä½" }],
                        lunch: [{ id: generateId(), name: "Caraway", dish: "ç‰›è‚‰å’–å“©", priceLevel: "Â¥900", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "éŒå€‰æ’éšŠååº—ï¼ŒCPå€¼é«˜" }, { id: generateId(), name: "Oxymoron", dish: "å’Œé¢¨è‚‰æœ«å’–å“©", priceLevel: "Â¥1500", url: "https://www.oxymoron.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "å°ç”ºé€šå··å…§æ–‡é’åº—" }],
                        dinner: [{ id: generateId(), name: "åˆ©ä¹…ç‰›èˆŒ", dish: "ç‰›èˆŒå®šé£Ÿ", priceLevel: "Â¥2500", url: "https://www.rikyu-gyutan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ™´ç©ºå¡”6Fï¼Œåšåˆ‡ç‰›èˆŒå¿…åƒ" }, { id: generateId(), name: "å…­å˜èˆ", dish: "ç‰¹è£½æ²¾éºµ", priceLevel: "Â¥1100", url: "https://www.rokurinsha.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ™´ç©ºå¡”6Fï¼Œéºµæ¢Qå½ˆ" }, { id: generateId(), name: "Toriton è¿´è½‰å£½å¸", dish: "åŒ—æµ·é“æ™‚ä»¤å£½å¸", priceLevel: "Â¥3000", url: "http://toriton-kita1.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ™´ç©ºå¡”6Fï¼Œä¾†è‡ªåŒ—æµ·é“çš„è¶…äººæ°£åº—" }]
                    },
                    events: [
                        { id: generateId(), time: "10:00", type: "food", title: "bills æ—©åˆé¤", loc: "ä¸ƒé‡Œãƒ¶æµœ", image: "bills.jpg", tags: ["å¿…åƒ:é¬†é¤…", "é ç´„"], desc: "è™Ÿç¨±ä¸–ç•Œç¬¬ä¸€æ—©é¤ï¼Œæµ·æ™¯ç¬¬ä¸€æ’ã€‚", transitToNext: { mode: 'train', duration: '15m', note: 'æ±Ÿä¹‹é›» (ä¸ƒé‡Œæ¿±->é•·è°·)' } },
                        { id: generateId(), time: "12:00", type: "sight", title: "éŒå€‰å¤§ä½›", loc: "é«˜å¾·é™¢", image: "buddha.jpg", desc: "åœ‹å¯¶éŠ…é€ é˜¿å½Œé™€å¦‚ä¾†ååƒã€‚", subItems: [{id: generateId(), type: 'do', text: 'é€²å…¥å¤§ä½›èƒå…§åƒè§€(Â¥50)', checked: false}], transitToNext: { mode: 'train', duration: '10m', note: 'æ±Ÿä¹‹é›» (é•·è°·->éŒå€‰)' } },
                        { id: generateId(), time: "13:30", type: "sight", title: "é¶´å²¡å…«å¹¡å®®", loc: "éŒå€‰", image: "kamakura.jpg", tags: ["å°ç”ºé€š"], desc: "éŒå€‰åœ°æ¨™ï¼Œåƒé“éå¸¸ç†±é¬§ï¼Œæœ‰è¨±å¤šå°åƒã€‚", subItems: [{id: generateId(), type: 'buy', text: 'è±å³¶å±‹ é´¿å­é¤…ä¹¾', checked: false}, {id: generateId(), type: 'eat', text: 'Kamakura Chacha æŠ¹èŒ¶éœœæ·‡æ·‹', checked: false}, {id: generateId(), type: 'eat', text: 'å¤¢è¦‹å±‹ ç³°å­', checked: false}], transitToNext: { mode: 'train', duration: '60m', note: 'JRæ©«é ˆè³€ç·š -> æ·ºè‰ç·š (ç›´é€š)' } },
                        { id: generateId(), time: "16:00", type: "transport", title: "Check-in æ·ºè‰", loc: "æ±æ©«INN", image: "inn.jpg", tags: ["å°ç”ºé€š"], note: "å¯„æ”¾è¡Œæã€ç¨ä½œä¼‘æ¯", transitToNext: { mode: 'train', duration: '5m', note: 'æ·ºè‰ç·š (æ·ºè‰->æŠ¼ä¸Š)' } },
                        { id: generateId(), time: "19:00", type: "food", title: "æ™´ç©ºå¡”", loc: "æŠ¼ä¸Š", image: "skytree.jpg", tags: ["å¿…é€›", "æ™šé¤"], desc: "è³¼ç‰©å•†åŸï¼Œå…­å˜èˆæ²¾éºµã€åˆ©ä¹…ç‰›èˆŒéƒ½åœ¨é€™ã€‚", subItems: [{id: generateId(), type: 'buy', text: 'Tokyo Banana (æ™´ç©ºå¡”é™å®šè±¹ç´‹)', checked: false}, {id: generateId(), type: 'buy', text: 'Press Butter Sand', checked: false}, {id: generateId(), type: 'do', text: 'å¯¶å¯å¤¢ä¸­å¿ƒ', checked: false}] }
                    ]
                },
                {
                    date: "1/31", weekday: "é€±å…­",
                    title: "å°æ±Ÿæˆ¶å·è¶Š",
                    weather: "æ™´å¤© 3-11Â°C",
                    locationKey: "kawagoe",
                    imageUrl: "oldstreet.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "ä¾¿åˆ©å•†åº—", dish: "å’–å•¡/éºµåŒ…", priceLevel: "Â¥400", url: "", locationUrl: "", note: "" }],
                        lunch: [{ id: generateId(), name: "å°å·èŠ", dish: "é°»é­šé£¯", priceLevel: "Â¥4000", url: "https://www.ogakiku.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ç™¾å¹´è€åº—ï¼Œå‹™å¿…é–‹é–€å‰æ’éšŠ" }, { id: generateId(), name: "å·è¶Šé‡œé£¯ Torisei", dish: "é‡œé£¯å®šé£Ÿ", priceLevel: "Â¥1500", url: "http://www.torisei.net/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ’éšŠååº—ï¼Œé›è‚‰é‡œé£¯å¾ˆé¦™" }, { id: generateId(), name: "Hayashiya", dish: "é°»é­šé£¯", priceLevel: "Â¥3500", url: "", locationUrl: "", note: "è€è¡—ä¸Šçš„å¦ä¸€é¸æ“‡" }],
                        dinner: [{ id: generateId(), name: "ç„¡æ•µå®¶", dish: "è±šéª¨æ‹‰éºµ", priceLevel: "Â¥1200", url: "https://mutekiya.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ± è¢‹ååº—ï¼Œå›ç¨‹é †è·¯åƒ" }, { id: generateId(), name: "æ´»ç¾ç™»åˆ©å£½å¸", dish: "è¿´è½‰å£½å¸", priceLevel: "Â¥2500", url: "https://katumidori.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ± è¢‹è¥¿æ­¦ç™¾è²¨8Fï¼ŒCPå€¼é«˜" }]
                    },
                    events: [
                        { id: generateId(), time: "09:00", type: "transport", title: "å‰å¾€å·è¶Š", loc: "æ± è¢‹ç«™", image: "kawagoePass.png", note: "è³¼è²·æ±æ­¦å·è¶Šå‘¨éŠåˆ¸", transitToNext: { mode: 'train', duration: '30m', note: 'æ±æ­¦æ±ä¸Šç·šæ€¥è¡Œ' } },
                        { id: generateId(), time: "10:30", type: "sight", title: "å†°å·ç¥ç¤¾", loc: "å·è¶Š", image: "hikawa.jpg", tags: ["é«”é©—:é‡£é¯›é­š"], desc: "æ±‚å§»ç·£åæ‰€ï¼Œç¹ªé¦¬éš§é“å¿…æ‹ã€‚", subItems: [{id: generateId(), type: 'do', text: 'é‡£ç´…è‰²é¯›é­š(æ±‚å¹³å®‰)', checked: false}, {id: generateId(), type: 'do', text: 'é‡£ç²‰è‰²é¯›é­š(æ±‚è‰¯ç·£)', checked: false}, {id: generateId(), type: 'do', text: 'æ”¾äººå½¢æµ(é™¤ç©¢)', checked: false}], transitToNext: { mode: 'bus', duration: '10m', note: 'æ±æ­¦å·´å£«' } },
                        { id: generateId(), time: "12:00", type: "food", title: "å·è¶Šé‡œé£¯ Torisei", loc: "å·è¶Š", image: "torisei.jpg", desc: "æ‹›ç‰Œèœæ˜¯ã€Œå·è¶Šé‡œé£¯å®šé£Ÿã€ï¼ˆé°»é­šå¡Šé…å·è¶Šåç‰©ç•ªè–¯ï¼‰åŠã€Œé³¥ã‚‚ã‚‚ç‚­ç«ç„¼å®šé£Ÿã€ã€‚", transitToNext: { mode: 'walk', duration: '5m', note: 'æ­¥è¡Œ' } },
                        { id: generateId(), time: "13:00", type: "food", title: "å°å·èŠ é°»é­šé£¯", loc: "å·è¶Š", image: "mini_unagi.jpg", tags: ["å¿…åƒ:é°»é­š"], desc: "ç™¾å¹´è€åº—ï¼Œç‚­çƒ¤é¦™æ°£åè¶³ã€‚è‹¥å¤ªä¹…å¯æ”¹åƒ'å‚³ç±³'ï¼Œå‚³ç±³æœ‰æä¾›è¿·ä½ é°»é­šé£¯ã€‚", transitToNext: { mode: 'walk', duration: '5m', note: 'æ­¥è¡Œè‡³ä¸€ç•ªè¡—' } },
                        { id: generateId(), time: "14:00", type: "sight", title: "è—é€ è€è¡—", loc: "ä¸€ç•ªè¡—", image: "oldstreet.jpg", tags: ["é¾œå±‹éŠ…é‘¼ç‡’","å·è¶Šå¸ƒä¸","å°æ±Ÿæˆ¶å¤§èŠ±-ç‰å­ç‡’"], desc: "åœ¨å·è¶Šçš„ä¸»è¦è¡—é“ã€Œå°æ±Ÿæˆ¶å·è¶Šä¸€ç•ªè¡—å•†åº—è¡—ã€è£¡...", subItems: [{id: generateId(), type: 'eat', text: 'å·è¶Šå¸ƒä¸ (å·è¶Šãƒ—ãƒªãƒ³)', checked: false}, {id: generateId(), type: 'eat', text: 'å°æ±Ÿæˆ¶å¤§èŠ± æ£ç‹€ç‰å­ç‡’', checked: false}, {id: generateId(), type: 'eat', text: 'ç´«è–¯å†°æ·‡æ·‹', checked: false}], transitToNext: { mode: 'walk', duration: '5m', note: 'æ­¥è¡Œ' } },
                        { id: generateId(), time: "15:00", type: "sight", title: "æ™‚ä¹‹é˜", loc: "ä¸€ç•ªè¡—", image: "toki.jpg", tags: ["é¾œå±‹éŠ…é‘¼ç‡’"], desc: "æ™‚ä¹‹é˜æ˜¯ä¸€å€‹é«˜ç´„16å…¬å°ºçš„æœ¨è£½é˜æ¨“ï¼Œç¾åœ¨æ˜¯å·è¶Šçš„åœ°æ¨™æ€§å»ºç¯‰ã€‚", subItems: [{id: generateId(), type: 'buy', text: 'é¾œå±‹ éŠ…é‘¼ç‡’', checked: false}], transitToNext: { mode: 'walk', duration: '10m', note: 'æ­¥è¡Œ' } },
                        { id: generateId(), time: "15:30", type: "sight", title: "å¤§æ­£æµªæ¼«å¤¢é€š", loc: "å·è¶Š", image: "taisei.jpg", desc: "ä½åœ¨å·è¶Šçš„ã€Œå¤§æ­£æµªæ¼«å¤¢é€šã‚Šã€æ˜¯ä¸€æ¢å……æ»¿æ‡·èˆŠæ°›åœçš„æ­·å²å•†åº—è¡—ã€‚", transitToNext: { mode: 'walk', duration: '5m', note: 'æ­¥è¡Œ' } },
                        { id: generateId(), time: "16:00", type: "sight", title: "ç†Šé‡ç¥ç¤¾", loc: "å·è¶Š", image: "kumano.jpg", tags:["éŒ¢æ´—å¼è²¡å¤©","æ°´æ™¶çƒ","å¥—åœˆåœˆ"], desc: "å·è¶Šç†Šé‡ç¥ç¤¾æ˜¯ä¸€åº§æ­·å²æ‚ ä¹…çš„é–‹é‹ã€çµç·£ç¥ç¤¾ã€‚", subItems: [{id: generateId(), type: 'do', text: 'æ´—éŒ¢å¼è²¡å¤©', checked: false}, {id: generateId(), type: 'do', text: 'å¥åº·æ­¥é“', checked: false}], transitToNext: { mode: 'train', duration: '45m', note: 'å›æ± è¢‹/æ·ºè‰' } }
                    ]
                },
                {
                    date: "2/1", weekday: "é€±æ—¥",
                    title: "æ—¥å…‰ä¸–ç•Œéºç”¢",
                    weather: "é›ª/é›¨ 0-5Â°C",
                    locationKey: "nikko",
                    imageUrl: "Toshogu.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "Spacia X è»Šå…§è²©å”®", dish: "ç²¾é‡€å•¤é…’/å’–å•¡", priceLevel: "Â¥600", url: "", locationUrl: "", note: "è»Šä¸ŠCafe" }],
                        lunch: [{ id: generateId(), name: "æ²¹æº", dish: "æ¹¯æ³¢(è±†çš®)æ–™ç†", priceLevel: "Â¥2000", url: "https://www.aburagen.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ—¥å…‰åç‰©ï¼Œå¥åº·ç¾å‘³" }, { id: generateId(), name: "Meiji-no-Yakata", dish: "è›‹åŒ…é£¯/èµ·å¸è›‹ç³•", priceLevel: "Â¥2500", url: "http://www.meiji-yakata.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ˜æ²»ä¹‹é¤¨ï¼Œæ´‹é£Ÿååº—" }, { id: generateId(), name: "Komekichi Kozushi", dish: "æ—¥å…‰æ¹¯æ³¢å£½å¸", priceLevel: "Â¥1800", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "å‰µæ„å£½å¸" }],
                        dinner: [{ id: generateId(), name: "æ·ºè‰ ç‰›ç‚¸(Gyukatsu)", dish: "ç‚¸ç‰›æ’", priceLevel: "Â¥1800", url: "https://www.asakusa-gyukatsu.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "é›·é–€å°é¢ï¼Œäººæ°£æ’éšŠåº—" }, { id: generateId(), name: "Yoroiya æ·ºè‰æ‹‰éºµ", dish: "é†¬æ²¹æ‹‰éºµ", priceLevel: "Â¥900", url: "https://yoroiya.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ¸…æ·¡ç³»é†¬æ²¹æ‹‰éºµï¼ŒåŠ å…¥æŸšå­æå‘³" }, { id: generateId(), name: "å¤§é»‘å®¶", dish: "æµ·è€å¤©ä¸¼", priceLevel: "Â¥2000", url: "http://www.tempura.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "é»‘éº»æ²¹ç‚¸å¤©å©¦ç¾…ï¼Œå£å‘³è¼ƒé‡" }]
                    },
                    events: [
                        { id: generateId(), time: "06:00", type: "transport", title: "SPACIA X (å»ç¨‹)", loc: "æ·ºè‰ç«™", image: "spaciaX.jpeg", tags: ["é ç´„:å¿…é ˆ"], desc: "æœ€æ–°å¥¢è¯è§€å…‰åˆ—è»Šã€‚", subItems: [{id: generateId(), type: 'eat', text: 'è»Šå…§é™å®š Craft Beer', checked: false}, {id: generateId(), type: 'eat', text: 'æ—¥å…‰æ„å¼å†°æ·‡æ·‹', checked: false}], transitToNext: { mode: 'train', duration: '1h 50m', note: 'æ±æ­¦æ—¥å…‰ç·š' } },
                        { id: generateId(), time: "09:30", type: "food", title: "ç‚¸æ¹¯æ³¢é¥…é ­", loc: "æ—¥å…‰Sakaeya", image: "sakaeya.jpg", tags: ["å¿…åƒ"], desc: "æ’’ä¸Šé¹½å·´çš„ç‚¸è±†çš®é¥…é ­ï¼Œç”œé¹¹çµ•é…ã€‚", subItems: [{id: generateId(), type: 'eat', text: 'ç‚¸æ¹¯æ³¢é¥…é ­', checked: false}], transitToNext: { mode: 'bus', duration: '10m', note: 'ä¸–ç•Œéºç”¢å·¡éŠå·´å£«' } },
                        { id: generateId(), time: "11:00", type: "sight", title: "æ—¥å…‰ä¸–ç•Œéºç”¢äºŒç¤¾ä¸€å¯º", loc: "æ—¥å…‰", image: "Toshogu.jpg", tags: ["äºŒè’å±±ç¥ç¤¾","æ±ç…§å®®","å±±è¼ªç‹å¯º"], desc: "** æ—¥å…‰æ±ç…§å®® **\næ—¥å…‰æ±ç…§å®®æ˜¯ä¾›å¥‰æ±Ÿæˆ¶å¹•åºœç¬¬ä¸€ä»£å°‡è»å¾·å·å®¶åº·çš„ç¥ç¤¾...", subItems: [{id: generateId(), type: 'do', text: 'æ‰¾ã€Œçœ è²“ã€', checked: false}, {id: generateId(), type: 'do', text: 'æ‰¾ã€Œä¸‰çŒ¿ã€(éç¦®å‹¿è¦–...)', checked: false}, {id: generateId(), type: 'do', text: 'è½ã€Œé³´é¾ã€å›éŸ³', checked: false}], transitToNext: { mode: 'walk', duration: '10m', note: 'æ­¥è¡Œ' } },
                        { id: generateId(), time: "13:30", type: "food", title: "æ¹¯æ³¢æ–™ç†åˆé¤", loc: "æ²¹æº", image: "yuba.jpg", tags: ["æ¹¯æ³¢å¾¡è†³"], desc: "æ—¥å…‰åç”¢è±†çš®æ–™ç†ã€‚", transitToNext: { mode: 'walk', duration: '15m', note: 'æ­¥è¡Œ' } },
                        { id: generateId(), time: "15:30", type: "sight", title: "ç¥æ©‹", loc: "æ—¥å…‰", image: "hashi.jpg", desc: "æœ±ç´…è‰²æ‹±æ©‹èˆ‡é›ªæ™¯/æºªæµçš„å°æ¯”ã€‚ä¸Šæ©‹è¦èŠ±éŒ¢ï¼Œå»ºè­°é çœ‹å°±å¥½ã€‚", transitToNext: { mode: 'bus', duration: '10m', note: 'å·´å£«å›è»Šç«™' } },
                        { id: generateId(), time: "16:30", type: "transport", title: "SPACIA X (å›ç¨‹)", loc: "æ±æ­¦æ—¥å…‰ç«™", image: "spaciax.jpeg", note: "åœ¨è»Šä¸Šäº«ç”¨æ—¥å…‰å¸ƒä¸æˆ–å•¤é…’ã€‚", transitToNext: { mode: 'train', duration: '2h', note: 'å›æ·ºè‰' } }
                    ]
                },
                {
                    date: "2/2", weekday: "é€±ä¸€",
                    title: "æ±äº¬ç¶“å…¸ç²¾é¸",
                    weather: "å¤šé›² 5-12Â°C",
                    locationKey: "tokyo",
                    imageUrl: "tokyo_tower.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "Pelican Cafe", dish: "ç‚­çƒ¤åå¸", priceLevel: "Â¥800", url: "https://www.bakerpelican.com/", locationUrl: "https://maps.app.goo.gl/xxx", note: "æ·ºè‰éºµåŒ…è€èˆ–ï¼Œéœ€æ’éšŠ" }, { id: generateId(), name: "February Cafe", dish: "ç„¦ç³–å¸ƒä¸", priceLevel: "Â¥700", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "ä½¿ç”¨Pelicanåå¸çš„æ–‡é’å’–å•¡åº—" }],
                        lunch: [{ id: generateId(), name: "æ·ºè‰ä»ŠåŠ", dish: "å£½å–œç‡’åˆè†³", priceLevel: "Â¥4000", url: "https://www.asakusaimahan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "ç™¾å¹´è€åº—ï¼Œåˆé¤CPå€¼è¼ƒé«˜" }, { id: generateId(), name: "Namiki Yabusoba", dish: "é´¨å—è »è•éº¥éºµ", priceLevel: "Â¥1800", url: "https://yabusoba.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "è—ªè•éº¥å¾¡ä¸‰å®¶ä¹‹ä¸€" }],
                        dinner: [{ id: generateId(), name: "æ ¹å®¤èŠ±ä¸¸", dish: "è¿´è½‰å£½å¸", priceLevel: "Â¥3000", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "KITTEä¸¸ä¹‹å…§åº—ï¼Œæ’éšŠååº—" }, { id: generateId(), name: "Tsurutontan", dish: "å¤§ç¢—çƒé¾éºµ", priceLevel: "Â¥1500", url: "http://www.tsurutontan.co.jp/", locationUrl: "https://maps.app.goo.gl/xxx", note: "éŠ€åº§Tokyu Plazaï¼Œç¢—æ¯”è‡‰å¤§" }, { id: generateId(), name: "éŠ€åº§ ç¯ (Kagari)", dish: "é›ç™½æ¹¯Soba", priceLevel: "Â¥1200", url: "", locationUrl: "https://maps.app.goo.gl/xxx", note: "ç±³å…¶æ—æ¨è–¦ï¼Œæ¿ƒéƒé›ç™½æ¹¯" }]
                    },
                    events: [
                        { id: generateId(), time: "9:00", type: "food", title: "Pelican CAFE", loc: "ç”°åŸç”º", image: "pelican.jpg", tags: ["ç‚­çƒ¤åå¸"], desc: "æ·ºè‰éºµåŒ…è€èˆ–ã€Œéµœé¶˜éºµåŒ…ã€äººæ°£æ—©é¤ï¼Œå¿…é»ç‚¸ç«è…¿ä¸‰æ˜æ²»ã€‚", transitToNext: { mode: 'walk', duration: '15m', note: 'æ­¥è¡Œè‡³é›·é–€' } },
                        { id: generateId(), time: "10:30", type: "sight", title: "æ·ºè‰å¯º & é›·é–€", loc: "æ·ºè‰", image: "asakusa.jpg", tags: ["åˆè¨ªå¿…å»"], desc: "æ±äº¬æœ€å¤è€å¯ºå»Ÿï¼Œæ—©ä¸Šå»äººè¼ƒå°‘ã€‚", subItems: [{id: generateId(), type: 'do', text: 'æ±‚ç±¤ (å‡¶è¦ç¶åœ¨æ¶ä¸Š)', checked: false}, {id: generateId(), type: 'buy', text: 'äººå½¢ç‡’', checked: false}, {id: generateId(), type: 'eat', text: 'èŠ±æœˆå ‚ è è˜¿éºµåŒ…', checked: false}], transitToNext: { mode: 'train', duration: '20m', note: 'éŠ€åº§ç·š (æ·ºè‰->äº¬æ©‹/æ—¥æœ¬æ©‹)' } },
                        { id: generateId(), time: "13:00", type: "sight", title: "æ±äº¬è»Šç«™", loc: "ä¸¸ä¹‹å…§", image: "station.jpg", tags: ["ä¼´æ‰‹ç¦®"], desc: "æ¬£è³ç´…ç£šè»Šç«™å»ºç¯‰ã€‚", subItems: [{id: generateId(), type: 'buy', text: 'NY Perfect Cheese', checked: false}, {id: generateId(), type: 'buy', text: 'NewYork City Sand', checked: false}], transitToNext: { mode: 'train', duration: '15m', note: 'ä¸¸ä¹‹å…§ç·š/JR (æ±äº¬->èµ¤ç¾½æ©‹)' } },
                        { id: generateId(), time: "15:00", type: "sight", title: "æ±äº¬éµå¡”", loc: "èŠå…¬åœ’", image: "tokyo_tower.jpg", tags: ["å¿…æ‹:å…¨æ™¯"], desc: "ååœ¨è‰åœ°ä¸Šèˆ‡æ±äº¬éµå¡”åˆç…§ã€‚", subItems: [{id: generateId(), type: 'do', text: 'æ‹ã€Œåœ°ä¸‹åœè»Šå ´æ¨“æ¢¯ã€ç¶²ç¾ç…§', checked: false}] }
                    ]
                },
                {
                    date: "2/3", weekday: "é€±äºŒ",
                    title: "æ­¸é€”",
                    weather: "æ™´æ™‚å¤šé›²",
                    locationKey: "tokyo",
                    imageUrl: "skytree.jpg",
                    mealOptions: {
                        breakfast: [{ id: generateId(), name: "é£¯åº—æ—©é¤", dish: "é£¯ç³°", priceLevel: "", url: "", locationUrl: "", note: "" }],
                        lunch: [{ id: generateId(), name: "å£½å¸äº¬è¾°", dish: "å£½å¸", priceLevel: "Â¥3000", url: "", locationUrl: "", note: "æˆç”°æ©Ÿå ´ç®¡åˆ¶å€å…§ï¼Œæœ€å¾Œä¸€é “ç¾é£Ÿ" }, { id: generateId(), name: "éº¥ç•¶å‹", dish: "åŸ¹æ ¹é¦¬éˆ´è–¯æ´¾", priceLevel: "Â¥500", url: "", locationUrl: "", note: "æ—¥æœ¬é™å®šå£å‘³" }],
                        dinner: []
                    },
                    events: [
                        { id: generateId(), time: "08:00", type: "hotel", title: "Check-out", loc: "æ±æ©«INN", image: "inn.jpg", note: "æª¢æŸ¥è­·ç…§ã€éŒ¢åŒ…ã€‚", transitToNext: { mode: 'walk', duration: '5m', note: 'æ­¥è¡Œè‡³è»Šç«™' } },
                        { id: generateId(), time: "08:30", type: "transport", title: "å‰å¾€æ©Ÿå ´", loc: "Accessç‰¹å¿«", image: "access.jpg", note: "ç›´é”æˆç”° (ç´„60åˆ†)ã€‚", transitToNext: { mode: 'train', duration: '60m', note: 'ç›´é”ç‰¹å¿«' } },
                        { id: generateId(), time: "10:12", type: "sight", title: "æ©Ÿå ´æœ€å¾Œè¡åˆº", loc: "æˆç”° T2", image: "naritaT.jpg", tags: ["å…ç¨…åº—"], desc: "è³¼è²·ç™½è‰²æˆ€äººã€Royceã€‚", subItems: [{id: generateId(), type: 'buy', text: 'Royce ç”Ÿå·§å…‹åŠ›', checked: false}, {id: generateId(), type: 'buy', text: 'LeTAO èµ·å¸è›‹ç³•', checked: false}, {id: generateId(), type: 'buy', text: 'è–¯æ¢ä¸‰å…„å¼Ÿ', checked: false}], transitToNext: { mode: 'walk', duration: '30m', note: 'ç™»æ©Ÿå£' } },
                        { id: generateId(), time: "13:00", type: "transport", title: "èµ·é£› BR197", loc: "æˆç”°æ©Ÿå ´", image: "plane.jpg", note: "å†è¦‹æ±äº¬ï¼" }
                    ]
                }
            ]
        };

        // --- HELPER COMPONENTS ---

        const typeColors = {
            transport: 'text-blue-400',
            food: 'text-orange-400',
            hotel: 'text-indigo-400',
            sight: 'text-matcha'
        };

        const EventCard = ({ event, onClick }) => (
            <div onClick={onClick} className="relative group cursor-pointer bg-white/50 rounded-2xl p-3 border border-transparent hover:border-matcha/30 hover:bg-white/80 transition-all duration-300">
                <div className="absolute -left-[45px] top-6 w-5 h-5 rounded-full border-4 border-rice bg-slate-300 group-hover:bg-matcha transition-colors shadow-sm z-10"></div>
                <div className="flex justify-between items-start gap-3">
                    <div className="flex-1">
                        <div className="flex items-baseline gap-2 mb-1">
                            <span className="font-mono text-sm font-bold text-slate-500">{event.time}</span>
                            <span className={`text-[10px] font-bold uppercase tracking-wider ${typeColors[event.type] || 'text-slate-400'} opacity-80`}>{event.type}</span>
                        </div>
                        <h3 className="text-lg font-bold text-charcoal leading-tight mb-1">{event.title}</h3>
                        <p className="text-sm text-slate-500 font-medium truncate tracking-wide flex items-center"><i className="fa-solid fa-location-dot text-xs mr-1 opacity-70"></i>{event.loc}</p>
                        {event.subItems && event.subItems.length > 0 && (
                            <div className="mt-3 flex flex-wrap gap-2">
                                {event.subItems.slice(0, 3).map(item => (
                                    <span key={item.id} className={`text-[10px] px-2 py-0.5 rounded-md border ${item.checked ? 'bg-matcha text-white border-matcha' : 'bg-white text-slate-500 border-slate-200'}`}>
                                        {item.type === 'buy' ? 'ğŸ›ï¸' : item.type === 'eat' ? 'ğŸ´' : 'âœ¨'} {item.text}
                                    </span>
                                ))}
                                {event.subItems.length > 3 && <span className="text-[10px] text-slate-400">+...</span>}
                            </div>
                        )}
                    </div>
                    {event.image && <img src={event.image} className="w-20 h-20 rounded-xl object-cover shadow-sm opacity-90 group-hover:opacity-100 transition-opacity bg-slate-200 flex-shrink-0" loading="lazy" onError={(e) => e.target.style.display = 'none'} />}
                </div>
            </div>
        );

        const getTransportIcon = (mode) => {
            switch(mode) {
                case 'train': return 'fa-train-subway';
                case 'walk': return 'fa-person-walking';
                case 'taxi': return 'fa-taxi';
                case 'bus': return 'fa-bus';
                default: return 'fa-arrow-right';
            }
        };

        const TransportConnector = ({ data, onClick }) => {
            if (!data) return (
                <div className="relative h-12 ml-[10px] border-l-2 border-dotted border-slate-300 my-1 group cursor-pointer" onClick={(e) => { e.stopPropagation(); onClick(); }}>
                    <div className="absolute top-1/2 -left-[10px] -translate-y-1/2 w-6 h-6 rounded-full bg-white border border-slate-300 flex items-center justify-center text-slate-300 shadow-sm opacity-0 group-hover:opacity-100 transition-all hover:border-matcha hover:text-matcha active:scale-95"><i className="fa-solid fa-plus text-[10px]"></i></div>
                </div>
            );
            return (
                <div className="relative h-16 ml-[10px] border-l-2 border-dashed border-slate-300 my-1 group">
                    <button onClick={(e) => { e.stopPropagation(); onClick(); }} className="absolute top-1/2 -left-[14px] -translate-y-1/2 flex items-center gap-2 bg-white border border-slate-200 shadow-sm px-3 py-1.5 rounded-full hover:border-matcha hover:text-matcha transition-all z-20 active:scale-95 max-w-[180px]">
                        <i className={`fa-solid ${getTransportIcon(data.mode)} text-xs text-slate-400 group-hover:text-matcha flex-shrink-0`}></i>
                        <div className="flex flex-col items-start text-left overflow-hidden">
                            <span className="text-[10px] font-bold text-slate-500 whitespace-nowrap group-hover:text-matcha leading-tight">{data.duration}</span>
                            {data.note && <span className="text-[9px] text-slate-400 truncate w-full group-hover:text-matcha/70 leading-tight">{data.note}</span>}
                        </div>
                    </button>
                </div>
            );
        };

        const MealOptions = ({ mealData, onAdd, onEdit }) => {
            const [isOpen, setIsOpen] = useState(false);
            if (!mealData) return null;
            const hasData = (mealData.breakfast?.length > 0) || (mealData.lunch?.length > 0) || (mealData.dinner?.length > 0);
            return (
                <div className="mb-8 px-1">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between bg-white border border-orange-100 p-3 rounded-xl shadow-sm mb-4 active:bg-orange-50 transition-colors">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><i className="fa-solid fa-utensils text-sm"></i></div>
                            <div className="text-left"><div className="text-sm font-bold text-charcoal">ç¾é£Ÿå‚™æ¡ˆ & æ¨è–¦</div><div className="text-[10px] text-slate-400">{isOpen ? 'é»æ“Šæ”¶åˆ' : (hasData ? 'é»æ“Šå±•é–‹æŸ¥çœ‹å‘¨é‚Šé¤å»³' : 'é»æ“Šæ–°å¢é¤å»³å£è¢‹åå–®')}</div></div>
                        </div>
                        <i className={`fa-solid fa-chevron-down text-slate-300 transition-transform ${isOpen ? 'rotate-180' : ''}`}></i>
                    </button>
                    {isOpen && (
                        <div className="space-y-6 animate-fade-in pl-2">
                            {['breakfast', 'lunch', 'dinner'].map(type => (
                                <div key={type}>
                                    <div className="flex items-center justify-between mb-2 pr-2"><h5 className="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">{type === 'breakfast' ? 'æ—©é¤' : type === 'lunch' ? 'åˆé¤' : 'æ™šé¤'}</h5></div>
                                    <div className="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x min-h-[100px]">
                                        {mealData[type]?.map(m => (
                                            <div key={m.id} onClick={() => onEdit(type, m)} className="min-w-[220px] bg-white rounded-xl p-3 border border-subtle shadow-sm flex flex-col snap-start active:scale-95 transition-transform cursor-pointer relative group">
                                                <div className="absolute top-2 right-2 text-slate-300 group-hover:text-matcha transition-colors"><i className="fa-solid fa-pen-to-square text-xs"></i></div>
                                                <div className="flex justify-between items-start mb-2 pr-4"><h4 className="font-bold text-charcoal text-sm line-clamp-1">{m.name}</h4><span className="text-[10px] font-mono text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">{m.priceLevel}</span></div>
                                                <div className="text-xs text-slate-500 mb-1"><span className="text-orange-400 font-bold">â˜… æ¨:</span> {m.dish}</div>
                                                {m.note && <p className="text-[10px] text-slate-400 line-clamp-2 mb-3 bg-slate-50 p-1 rounded">{m.note}</p>}
                                                <div className="mt-auto flex gap-2">
                                                    {m.locationUrl && <a href={m.locationUrl} onClick={e => e.stopPropagation()} target="_blank" className="flex-1 py-1.5 text-center bg-slate-100 rounded-lg text-[10px] font-bold text-slate-600">åœ°åœ–</a>}
                                                    {m.url && <a href={m.url} onClick={e => e.stopPropagation()} target="_blank" className="flex-1 py-1.5 text-center bg-slate-100 rounded-lg text-[10px] font-bold text-slate-600">æœ</a>}
                                                </div>
                                            </div>
                                        ))}
                                        <div onClick={() => onAdd(type)} className="min-w-[50px] flex items-center justify-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 cursor-pointer hover:border-matcha hover:bg-matcha/5 active:scale-95"><i className="fa-solid fa-plus text-slate-400"></i></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const InfoView = ({ reservations, onEdit, onAdd }) => {
            const getStatusColor = (s) => s === 'booked' ? 'bg-matcha/10 text-matcha' : s === 'to-book' ? 'bg-orange-100 text-orange-500' : 'bg-slate-100 text-slate-500';
            const getStatusText = (s) => s === 'booked' ? 'å·²é è¨‚' : s === 'to-book' ? 'å¾…é è¨‚' : 'è™•ç†ä¸­';
            const getTypeIcon = (t) => t === 'flight' ? 'fa-plane' : t === 'hotel' ? 'fa-bed' : t === 'restaurant' ? 'fa-utensils' : 'fa-ticket';
            const speak = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u); };

            return (
                <div className="px-6 space-y-6 pb-24 tracking-wide pt-6">
                    <div className="grid grid-cols-2 gap-4">
                        <a href="https://vjw-lp.digital.go.jp/zh-hant/" target="_blank" className="bg-blue-50 p-4 rounded-2xl flex flex-col items-center justify-center text-center border border-blue-100 active:scale-95 transition-transform"><i className="fa-solid fa-qrcode text-2xl text-blue-500 mb-2"></i><span className="text-xs font-bold text-blue-900">Visit Japan Web</span></a>
                        <a href="https://www.google.com/maps" target="_blank" className="bg-green-50 p-4 rounded-2xl flex flex-col items-center justify-center text-center border border-green-100 active:scale-95 transition-transform"><i className="fa-solid fa-map-location-dot text-2xl text-green-600 mb-2"></i><span className="text-xs font-bold text-green-900">Google Maps</span></a>
                    </div>
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-subtle">
                         <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">æ—…éŠå¯¦ç”¨æ—¥èª (é»æ“Šç™¼éŸ³)</h3>
                         <div className="grid grid-cols-1 gap-2">
                            {PHRASES.map((p, i) => (
                                <div key={i} onClick={() => speak(p.jp)} className="flex justify-between items-start p-3 hover:bg-slate-50 rounded-xl cursor-pointer active:scale-[0.98] transition-all border border-transparent hover:border-subtle group">
                                    <div><div className="text-lg font-bold text-matcha mb-1">{p.jp}</div><div className="text-sm text-charcoal font-medium">{p.zh}</div><div className="text-xs text-slate-400">{p.ro}</div></div>
                                    <div className="text-slate-300 group-hover:text-matcha"><i className="fa-solid fa-volume-high"></i></div>
                                </div>
                            ))}
                         </div>
                    </div>
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-subtle">
                        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">ç·Šæ€¥è¯çµ¡</h3>
                        <div className="space-y-4">
                            <div className="flex justify-between items-center border-b border-slate-50 pb-3"><div><div className="font-bold text-charcoal">æ—…å¤–åœ‹äººæ€¥é›£æ•‘åŠ©</div><div className="text-xs text-slate-400 mt-1">æ—¥æœ¬å¢ƒå…§ç›´æ’¥</div></div><a href="tel:08010097179" className="text-red-500 font-mono font-bold text-lg">080-1009-7179</a></div>
                            <div className="flex justify-between items-center"><div className="flex gap-4"><div><span className="text-xs text-slate-400 block">å ±è­¦</span><span className="font-bold text-xl">110</span></div><div><span className="text-xs text-slate-400 block">æ•‘è­·</span><span className="font-bold text-xl">119</span></div></div></div>
                        </div>
                    </div>
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-subtle">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest">é è¨‚èˆ‡ç¥¨åˆ¸</h3><button onClick={onAdd} className="text-xs bg-[#f4f1e8] text-matcha px-3 py-1 rounded-full font-bold hover:bg-subtle transition-colors"><i className="fa-solid fa-plus mr-1"></i>æ–°å¢</button></div>
                        <div className="space-y-4">
                            {reservations && reservations.map(res => (
                                <div key={res.id} onClick={() => onEdit(res)} className="relative p-4 rounded-xl border border-subtle cursor-pointer active:scale-[0.98] transition-all hover:border-matcha group bg-slate-50/50">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-white border border-subtle flex items-center justify-center text-slate-500 group-hover:text-matcha group-hover:border-matcha transition-colors"><i className={`fa-solid ${getTypeIcon(res.type)}`}></i></div><div><div className="text-xs font-bold text-slate-400 uppercase">{res.type}</div><div className="text-base font-bold text-charcoal">{res.name}</div></div></div>
                                        <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${getStatusColor(res.status)}`}>{getStatusText(res.status)}</span>
                                    </div>
                                    <div className="pl-10 space-y-1"><div className="text-sm text-charcoal font-medium flex items-center gap-2"><i className="fa-regular fa-clock text-slate-400 text-xs"></i> {res.dateTime}</div>{res.refNumber && <div className="text-xs font-mono text-slate-500 bg-white inline-block px-1 rounded border border-slate-100">REF: {res.refNumber}</div>}{res.notes && <div className="text-xs text-matcha mt-1"><i className="fa-solid fa-circle-info mr-1"></i>{res.notes}</div>}</div>
                                </div>
                            ))}
                            {reservations.length === 0 && <div className="text-center text-slate-300 text-sm py-4 border-2 border-dashed border-slate-100 rounded-xl">å°šç„¡é è¨‚ç´€éŒ„</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const ReservationModal = ({ isOpen, initialData, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ type: 'ticket', name: '', status: 'pending', dateTime: '', refNumber: '', notes: '', url: '' });
            useEffect(() => { if (isOpen) setFormData(initialData || { type: 'ticket', name: '', status: 'pending', dateTime: '', refNumber: '', notes: '', url: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl transform transition-transform duration-300 max-h-[90vh] flex flex-col overflow-y-auto animate-slide-up">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8 flex-shrink-0"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-6">{initialData ? 'ç·¨è¼¯é è¨‚' : 'æ–°å¢é è¨‚'}</h3>
                        <div className="space-y-6">
                            <div className="flex gap-4">
                                <div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">é¡å‹</label><select value={formData.type} onChange={(e) => setFormData({...formData, type: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none"><option value="flight">âœˆï¸ èˆªç­</option><option value="hotel">ğŸ¨ ä½å®¿</option><option value="restaurant">ğŸ½ï¸ é¤å»³</option><option value="ticket">ğŸ« ç¥¨åˆ¸</option></select></div>
                                <div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ç‹€æ…‹</label><select value={formData.status} onChange={(e) => setFormData({...formData, status: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none"><option value="booked">âœ… å·²é è¨‚</option><option value="pending">â³ è™•ç†ä¸­</option><option value="to-book">âš ï¸ å¾…é è¨‚</option></select></div>
                            </div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">åç¨±</label><input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} placeholder="ä¾‹å¦‚ï¼šSkyliner è»Šç¥¨" className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">æ™‚é–“</label><input type="text" value={formData.dateTime} onChange={(e) => setFormData({...formData, dateTime: e.target.value})} placeholder="ä¾‹å¦‚ï¼š1/28 14:00" className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ç·¨è™Ÿ</label><input type="text" value={formData.refNumber || ''} onChange={(e) => setFormData({...formData, refNumber: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base font-mono focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">å‚™è¨»</label><textarea value={formData.notes || ''} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none" /></div>
                        </div>
                        <div className="mt-8 flex gap-4">{initialData && onDelete && <button onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle">åˆªé™¤</button>}<button onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl shadow-lg">å„²å­˜</button></div>
                    </div>
                </div>
            );
        };

        const PackingListView = ({ items, onToggle, onAdd, onDelete }) => {
            const [newItemText, setNewItemText] = useState('');
            const safeItems = items || [];
            const grouped = safeItems.reduce((acc, item) => { if (!acc[item.category]) acc[item.category] = []; acc[item.category].push(item); return acc; }, {});
            const progress = safeItems.length > 0 ? Math.round((safeItems.filter(i => i.checked).length / safeItems.length) * 100) : 0;
            return (
                <div className="px-6 pb-32 pt-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-subtle mb-8">
                        <div className="flex justify-between items-end mb-2"><h2 className="text-lg font-bold text-charcoal">è¡Œææ¸…å–®</h2><span className="text-2xl font-mono font-bold text-matcha">{progress}%</span></div>
                        <div className="h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-matcha transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div></div>
                    </div>
                    <form onSubmit={(e) => { e.preventDefault(); if (newItemText.trim()) { onAdd(newItemText, 'è‡ªè¨‚'); setNewItemText(''); } }} className="mb-8 relative">
                        <input type="text" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} placeholder="æ–°å¢ç‰©å“..." className="w-full bg-rice border border-subtle rounded-xl py-3 pl-4 pr-12 focus:border-matcha focus:bg-white transition-all outline-none" />
                        <button type="submit" className="absolute right-2 top-2 w-8 h-8 bg-matcha text-white rounded-lg flex items-center justify-center active:scale-95 transition-transform"><i className="fa-solid fa-plus text-xs"></i></button>
                    </form>
                    <div className="space-y-8">
                        {Object.entries(grouped).map(([category, groupItems]) => (
                            <div key={category}>
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3 pl-1">{category}</h3>
                                <div className="bg-white rounded-2xl overflow-hidden border border-subtle divide-y divide-subtle">
                                    {groupItems.map(item => (
                                        <div key={item.id} className="p-4 flex items-center group relative">
                                            <div className="flex-1 flex items-center cursor-pointer" onClick={() => onToggle(item.id)}>
                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center mr-4 transition-colors flex-shrink-0 ${item.checked ? 'bg-matcha border-matcha' : 'border-slate-300'}`}>{item.checked && <i className="fa-solid fa-check text-white text-xs"></i>}</div>
                                                <span className={`flex-1 font-medium transition-opacity ${item.checked ? 'text-slate-400 line-through opacity-70' : 'text-charcoal'}`}>{item.text}</span>
                                            </div>
                                            <button onClick={() => onDelete(item.id)} className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-400 transition-colors"><i className="fa-solid fa-trash-can"></i></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const MoneyView = ({ expenses, members, currencyRate, currentCurrency, onDelete }) => {
            const [currency, setLocalCurrency] = useState(currentCurrency);
            const getMemberName = (id) => MEMBERS.find(m => m.id === id)?.name || id;
            const getMemberIcon = (id) => MEMBERS.find(m => m.id === id)?.icon || '';
            const balances = {}; MEMBERS.forEach(m => balances[m.id] = 0);
            let totalSpentJPY = 0;

            if(expenses) {
                expenses.forEach(ex => {
                    const amountJPY = ex.currency === 'TWD' ? ex.amount / currencyRate : ex.amount;
                    totalSpentJPY += amountJPY;
                    balances[ex.payer] += amountJPY;
                    if (ex.mode === 'custom' && ex.details) {
                        Object.entries(ex.details).forEach(([uid, amt]) => { const debtJPY = ex.currency === 'TWD' ? amt / currencyRate : amt; balances[uid] -= debtJPY; });
                    } else {
                        const share = amountJPY / ex.involved.length;
                        ex.involved.forEach(pid => balances[pid] -= share);
                    }
                });
            }

            const displayMoney = (valJPY) => {
                if (currency === 'JPY') return `Â¥${Math.round(valJPY).toLocaleString()}`;
                return `NT$${Math.round(valJPY * currencyRate).toLocaleString()}`;
            };

            return (
                <div className="px-6 pb-32 tracking-wide pt-6">
                    <div className="bg-charcoal text-white p-6 rounded-2xl shadow-lg mb-8 relative overflow-hidden">
                        <div className="absolute top-4 right-4 text-xs font-bold opacity-50 border border-white/30 rounded-full px-2 py-0.5 cursor-pointer" onClick={() => setLocalCurrency(c => c === 'JPY' ? 'TWD' : 'JPY')}>{currency}</div>
                        <div className="text-xs text-white/60 uppercase font-bold tracking-widest">Total Expenses</div>
                        <div className="text-4xl font-black mt-2 font-mono">{displayMoney(totalSpentJPY)}</div>
                        <div className="mt-6 pt-4 border-t border-white/10 flex gap-4 items-center">
                            <i className="fa-solid fa-calculator text-white/40"></i>
                            <input type="number" placeholder="JPY" className="bg-transparent w-20 text-sm font-mono placeholder-white/30 outline-none border-b border-white/20 focus:border-matcha" onChange={e => { const val = parseFloat(e.target.value); const target = e.target.nextElementSibling; if(val) target.innerText = `â‰ˆ NT$${Math.round(val * currencyRate)}`; else target.innerText = ''; }} />
                            <span className="text-xs text-white/60 font-mono"></span>
                        </div>
                    </div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 px-1">Balances (çµç®—)</h3>
                    <div className="grid grid-cols-2 gap-3 mb-10">
                        {MEMBERS.map(m => {
                            const bal = balances[m.id];
                            const isPos = bal >= 0;
                            return (
                                <div key={m.id} className={`rounded-xl p-3 flex items-center justify-between border ${isPos ? 'bg-[#f0f4ef] border-matcha/20' : 'bg-red-50 border-red-100'}`}>
                                    <div className="flex items-center gap-2"><span className="text-xl">{m.icon}</span><span className="text-xs font-bold text-charcoal">{m.name}</span></div>
                                    <div className="text-right"><div className={`font-bold text-sm font-mono ${isPos ? 'text-matcha' : 'text-red-400'}`}>{displayMoney(Math.abs(bal))}</div><div className={`text-[9px] opacity-70 ${isPos ? 'text-matcha' : 'text-red-400'}`}>{isPos ? 'æ”¶' : 'ä»˜'}</div></div>
                                </div>
                            );
                        })}
                    </div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 px-1">History</h3>
                    <div className="bg-white rounded-2xl border border-subtle divide-y divide-subtle">
                        {(!expenses || expenses.length === 0) ? <div className="text-center text-slate-300 py-8 text-sm">å°šç„¡ç´€éŒ„</div> : 
                            [...expenses].reverse().map(ex => (
                                <div key={ex.id} className="p-4 flex justify-between items-center group">
                                    <div>
                                        <div className="font-bold text-charcoal">{ex.title}</div>
                                        <div className="text-xs text-slate-400 mt-1 flex items-center gap-1"><span>{getMemberIcon(ex.payer)} ä»˜æ¬¾</span><span className="text-slate-300">|</span>{ex.mode === 'custom' ? <span className="text-orange-400">è‡ªè¨‚åˆ†å¸³</span> : <span>{ex.involved.length === MEMBERS.length ? 'å…¨å“¡' : ex.involved.map(id => getMemberIcon(id)).join('')}</span>}</div>
                                    </div>
                                    <div className="text-right"><div className="font-bold text-charcoal font-mono">{ex.currency === 'TWD' ? 'NT$' : 'Â¥'}{ex.amount}</div><button onClick={() => onDelete(ex.id)} className="text-xs text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity p-1">åˆªé™¤</button></div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            );
        };

        const ExpenseModal = ({ isOpen, onClose, onSave, members }) => {
            const [data, setData] = useState({ title: '', amount: '', currency: 'JPY', payer: members[0].id, involved: members.map(m => m.id), mode: 'equal', details: {} });
            useEffect(() => { if(data.mode === 'equal') { const eq = {}; data.involved.forEach(id => eq[id] = 0); setData(d => ({...d, details: eq})); } }, [data.involved.length]);
            if (!isOpen) return null;
            const totalAllocated = Object.values(data.details).reduce((a, b) => Number(a) + Number(b), 0);
            const remaining = Number(data.amount) - totalAllocated;
            const isCustomValid = data.mode === 'equal' || Math.abs(remaining) < 1;
            return (
                 <div className="fixed inset-0 z-[80]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-6 pb-safe shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-bold text-charcoal mb-4">æ–°å¢æ”¯å‡º</h3>
                        <div className="space-y-4">
                            <input type="text" value={data.title} onChange={e => setData({...data, title: e.target.value})} placeholder="é …ç›® (å¦‚: æ™šé¤)" className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" />
                            <div className="flex gap-2"><input type="number" value={data.amount} onChange={e => setData({...data, amount: e.target.value})} placeholder="ç¸½é‡‘é¡" className="flex-[2] bg-white p-3 rounded-xl border border-subtle outline-none font-mono text-lg font-bold" /><select value={data.currency} onChange={e => setData({...data, currency: e.target.value})} className="flex-1 bg-white p-3 rounded-xl border border-subtle outline-none font-bold text-center"><option value="JPY">JPY</option><option value="TWD">TWD</option></select></div>
                            <div><label className="text-xs font-bold text-slate-400 block mb-2">èª°å…ˆä»˜éŒ¢?</label><div className="flex gap-3 overflow-x-auto pb-2">{members.map(m => (<div key={m.id} onClick={() => setData({...data, payer: m.id})} className={`flex flex-col items-center gap-1 min-w-[50px] cursor-pointer transition-all ${data.payer === m.id ? 'opacity-100 scale-110' : 'opacity-50 grayscale'}`}><span className="text-2xl">{m.icon}</span><span className="text-[10px] font-bold">{m.name}</span></div>))}</div></div>
                            <div className="bg-white p-3 rounded-xl border border-subtle">
                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-slate-400">åˆ†æ”¤æ–¹å¼</label><div className="flex bg-slate-100 rounded-lg p-1"><button onClick={() => setData({...data, mode: 'equal'})} className={`text-xs px-3 py-1 rounded-md font-bold transition-colors ${data.mode==='equal'?'bg-white shadow-sm text-matcha':'text-slate-400'}`}>å¹³å‡</button><button onClick={() => setData({...data, mode: 'custom'})} className={`text-xs px-3 py-1 rounded-md font-bold transition-colors ${data.mode==='custom'?'bg-white shadow-sm text-matcha':'text-slate-400'}`}>è‡ªè¨‚</button></div></div>
                                {data.mode === 'equal' ? (<div className="flex flex-wrap gap-2">{members.map(m => (<div key={m.id} onClick={() => { const newInvolved = data.involved.includes(m.id) ? data.involved.filter(id => id !== m.id) : [...data.involved, m.id]; setData({...data, involved: newInvolved}); }} className={`px-3 py-1.5 rounded-lg text-xs font-bold border cursor-pointer transition-colors ${data.involved.includes(m.id) ? 'bg-matcha text-white border-matcha' : 'bg-white text-slate-500 border-subtle'}`}>{m.icon} {m.name}</div>))}</div>) : (<div className="space-y-2">{members.map(m => (<div key={m.id} className="flex items-center gap-2"><div className="w-8 text-xl text-center">{m.icon}</div><input type="number" placeholder="0" value={data.details[m.id] || ''} onChange={(e) => { const val = parseFloat(e.target.value) || 0; const newDetails = {...data.details, [m.id]: val}; const newInvolved = Object.keys(newDetails).filter(k => newDetails[k] > 0); setData({...data, details: newDetails, involved: newInvolved}); }} className="flex-1 bg-slate-50 border-b border-subtle py-1 px-2 text-sm font-mono outline-none focus:border-matcha" /></div>))}<div className={`text-right text-xs font-bold mt-2 ${remaining === 0 ? 'text-matcha' : 'text-red-400'}`}>{remaining === 0 ? 'é‡‘é¡æ­£ç¢º' : `é‚„æœ‰ ${remaining} æœªåˆ†é…`}</div></div>)}
                            </div>
                            <button onClick={() => { if(!data.title || !data.amount || data.involved.length === 0 || !isCustomValid) return; onSave(data); }} disabled={!isCustomValid} className={`w-full text-white font-bold py-3.5 rounded-2xl shadow-lg mt-2 transition-opacity ${isCustomValid ? 'bg-matcha' : 'bg-slate-300'}`}>å„²å­˜</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ItineraryView = ({ days, currentDayIdx, onDaySelect, onEventClick, onTransportClick, onAddEvent, onAddMeal, onEditMeal }) => {
            const isManualScroll = useRef(false);
            const [mapOpen, setMapOpen] = useState(false);

            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    if (isManualScroll.current) return;
                    const visibleDay = entries.find(e => e.isIntersecting);
                    if (visibleDay) {
                        const id = visibleDay.target.id;
                        const idx = parseInt(id.replace('day-', ''));
                        if (!isNaN(idx) && idx !== currentDayIdx) {
                            onDaySelect(idx); 
                        }
                    }
                }, { root: null, rootMargin: '-40% 0px -50% 0px', threshold: 0 });
                if(days) days.forEach((_, idx) => { const el = document.getElementById(`day-${idx}`); if (el) observer.observe(el); });
                return () => observer.disconnect();
            }, [days, currentDayIdx, onDaySelect]);

            const handleDayClick = (idx) => {
                isManualScroll.current = true;
                onDaySelect(idx);
                const el = document.getElementById(`day-${idx}`);
                if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); setTimeout(() => { isManualScroll.current = false; }, 600); }
            };

            return (
                <div className="px-6 pb-32">
                     <div className="mb-4">
                        <button onClick={() => setMapOpen(!mapOpen)} className="w-full bg-white border border-subtle rounded-xl p-3 flex items-center justify-between shadow-sm active:scale-[0.99] transition-transform">
                            <span className="text-xs font-bold text-charcoal flex items-center gap-2"><i className="fa-solid fa-map"></i> æŸ¥çœ‹è¡Œç¨‹ç¸½è¦½åœ°åœ–</span>
                            <i className={`fa-solid fa-chevron-down text-slate-300 transition-transform ${mapOpen ? 'rotate-180' : ''}`}></i>
                        </button>
                        {mapOpen && <div className="mt-2 rounded-xl overflow-hidden border border-subtle animate-fade-in"><img src="map.png" className="w-full object-cover" alt="Map" /></div>}
                     </div>

                    <div className="flex overflow-x-auto gap-5 py-4 hide-scrollbar sticky top-[60px] z-30 bg-rice/95 backdrop-blur -mx-6 px-6 mb-6 transition-all">
                        {days && days.map((day, idx) => (
                            <button key={idx} onClick={() => handleDayClick(idx)} className={`flex-shrink-0 text-center min-w-[48px] transition-all duration-300 group ${currentDayIdx === idx ? 'text-matcha scale-110' : 'text-slate-400 opacity-70'}`}>
                                <div className="text-[10px] font-bold uppercase tracking-widest mb-1">{day.weekday}</div>
                                <div className="text-xl font-bold font-mono relative">{day.date.split('/')[1] || day.date}{currentDayIdx === idx && (<div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-matcha"></div>)}</div>
                            </button>
                        ))}
                    </div>

                    <div className="space-y-12">
                        {days && days.map((day, dIdx) => (
                            <div id={`day-${dIdx}`} key={dIdx} className="scroll-mt-40 transition-opacity duration-500">
                                <div className="mb-6 px-1">
                                    <div className="flex items-center justify-between"><span className="text-xs font-bold text-slate-400 tracking-widest uppercase">{day.date} Â· {day.weekday}</span><span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md"><i className="fa-solid fa-cloud-sun mr-1"></i>{day.weather}</span></div>
                                    <h2 className="text-2xl font-bold text-charcoal mt-2 tracking-wide">{day.title}</h2>
                                </div>
                                <MealOptions mealData={day.mealOptions} onAdd={(type) => onAddMeal(dIdx, type)} onEdit={(type, option) => onEditMeal(dIdx, type, option)} />
                                <div className="relative ml-2.5 pl-8 space-y-0 pb-4">
                                    <div className="absolute left-[10px] top-4 bottom-4 w-0.5 bg-slate-100 -z-10"></div>
                                    {day.events && day.events.map((ev, eIdx) => (
                                        <div key={ev.id}>
                                            <EventCard event={ev} onClick={() => onEventClick(dIdx, ev)} />
                                            {eIdx < day.events.length - 1 && <TransportConnector data={ev.transitToNext} onClick={() => onTransportClick(dIdx, ev.id)} />}
                                        </div>
                                    ))}
                                    <div className="h-8 border-l-2 border-slate-100 ml-[10px]"></div>
                                    <button onClick={() => onAddEvent(dIdx)} className="w-full py-4 border-2 border-dashed border-subtle rounded-xl text-slate-400 text-sm font-bold hover:border-matcha hover:text-matcha transition-colors">+ æ–°å¢è¡Œç¨‹</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DetailModal = ({ event, onClose, onEdit }) => {
            if (!event) return null;
            return (
                <div className="fixed inset-0 z-[60]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-white rounded-t-[24px] overflow-hidden shadow-2xl max-h-[92vh] overflow-y-auto animate-slide-up">
                        <div className="relative h-72">
                            <img src={event.image || 'https://placehold.co/600x400/eceae6/a0a09e?text=NO+IMAGE'} className="w-full h-full object-cover" alt={event.title} onError={(e) => (e.target.src = 'https://placehold.co/600x400/eceae6/a0a09e?text=NO+IMAGE')} />
                            <div className="absolute inset-0 bg-gradient-to-t from-charcoal/80 via-charcoal/20 to-transparent"></div>
                            <button onClick={onClose} className="absolute top-5 right-5 bg-black/20 text-white/90 rounded-full w-8 h-8 flex items-center justify-center backdrop-blur-md active:bg-black/40 transition-colors"><i className="fa-solid fa-xmark"></i></button>
                            <div className="absolute bottom-6 left-6 text-white pr-4"><span className="text-[10px] font-bold px-2 py-1 bg-white/20 backdrop-blur-md rounded mb-3 inline-block tracking-wider uppercase">{event.type}</span><h2 className="text-3xl font-bold leading-tight tracking-wide drop-shadow-md">{event.title}</h2><p className="text-sm opacity-90 mt-2 font-medium flex items-center"><i className="fa-solid fa-location-dot mr-1.5 text-xs"></i>{event.loc || 'æœªçŸ¥åœ°é»'}</p></div>
                            <button onClick={onEdit} className="absolute -bottom-6 right-6 bg-matcha text-white rounded-2xl w-12 h-12 flex items-center justify-center shadow-lg active:scale-95 transition-transform z-20"><i className="fa-solid fa-pen"></i></button>
                        </div>
                        <div className="p-8 pt-12 pb-28 space-y-6 bg-rice">
                            {event.subItems && event.subItems.length > 0 && (<div className="mb-6"><h4 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-widest">å¿…åšæ¸…å–®</h4><div className="space-y-2">{event.subItems.map(item => (<div key={item.id} className="flex items-center gap-3 bg-white p-3 rounded-xl border border-subtle"><div className={`w-5 h-5 rounded flex items-center justify-center text-[10px] ${item.checked ? 'bg-matcha text-white' : 'bg-slate-100 text-slate-400'}`}>{item.checked && <i className="fa-solid fa-check"></i>}</div><span className={`text-sm ${item.checked ? 'line-through text-slate-400' : 'text-charcoal'}`}>{item.type === 'buy' ? 'ğŸ›ï¸' : item.type === 'eat' ? 'ğŸ´' : 'âœ¨'} {item.text}</span></div>))}</div></div>)}
                            {event.tags && (<div className="flex flex-wrap gap-2">{event.tags.map(tag => (<span key={tag} className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold tracking-wider">#{tag}</span>))}</div>)}
                            <div className="text-charcoal leading-relaxed tracking-wide"><h4 className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">é—œæ–¼</h4><p className="whitespace-pre-line">{event.desc || 'æš«ç„¡è©³ç´°æè¿°ã€‚'}</p></div>
                            {event.note && (<div className="bg-[#f4f1e8] p-4 rounded-xl border-l-2 border-matcha"><p className="text-xs font-bold text-matcha uppercase mb-1 tracking-widest">TIPS</p><p className="text-sm text-charcoal/80">{event.note}</p></div>)}
                            <div className="flex gap-4 pt-4"><a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((event.loc || '') + ' ' + event.title)}`} target="_blank" className="flex-1 border border-subtle text-charcoal py-3.5 rounded-2xl font-bold text-center active:bg-slate-50 transition-colors text-sm tracking-wider">å°èˆª</a><a href={`https://www.google.com/search?q=${encodeURIComponent(event.title)}`} target="_blank" className="flex-1 bg-charcoal text-white py-3.5 rounded-2xl font-bold text-center active:bg-charcoal/90 transition-colors text-sm tracking-wider">æœå°‹</a></div>
                        </div>
                    </div>
                </div>
            );
        };

        const EventModal = ({ isOpen, initialData, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ time: '09:00', type: 'sight', title: '', loc: '', image: '', desc: '', subItems: [] });
            const [newSub, setNewSub] = useState({ text: '', type: 'buy' });
            useEffect(() => { if (isOpen) setFormData(initialData || { time: '09:00', type: 'sight', title: '', loc: '', image: '', desc: '', subItems: [] }); }, [isOpen, initialData]);
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { const img = new Image(); img.src = reader.result; img.onload = () => { const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7); setFormData({...formData, image: compressedBase64}); } };
                    reader.readAsDataURL(file);
                }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl transform transition-transform duration-300 h-[90vh] flex flex-col animate-slide-up">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-8 tracking-wide">{initialData ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹'}</h3>
                        <div className="space-y-6 flex-1 overflow-y-auto hide-scrollbar">
                            <div className="flex gap-4"><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">æ™‚é–“</label><input type="time" value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 font-mono text-lg focus:border-matcha outline-none transition-colors" /></div><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">é¡å‹</label><select value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-lg focus:border-matcha outline-none"><option value="sight">ğŸ“· æ™¯é»</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="transport">ğŸš… äº¤é€š</option><option value="hotel">ğŸ¨ ä½å®¿</option></select></div></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">æ¨™é¡Œ</label><input type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="è«‹è¼¸å…¥æ¨™é¡Œ" className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">åœ°é»</label><input type="text" value={formData.loc} onChange={e => setFormData({...formData, loc: e.target.value})} placeholder="ä¾‹å¦‚ï¼šæ·ºè‰" className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">åœ–ç‰‡</label><div className="flex items-center gap-4">{formData.image && <img src={formData.image} className="w-16 h-16 rounded-lg object-cover bg-slate-100" />}<label className="bg-slate-100 text-slate-500 px-4 py-2 rounded-xl text-sm font-bold cursor-pointer hover:bg-slate-200 transition-colors"><i className="fa-solid fa-camera mr-2"></i>ä¸Šå‚³ç…§ç‰‡<input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" /></label></div></div>
                            <div className="bg-white p-4 rounded-xl border border-subtle"><div className="flex gap-2 mb-2"><select value={newSub.type} onChange={e => setNewSub({...newSub, type: e.target.value})} className="bg-slate-100 rounded text-xs p-2"><option value="buy">ğŸ›ï¸</option><option value="eat">ğŸ´</option><option value="do">âœ¨</option></select><input type="text" value={newSub.text} onChange={e => setNewSub({...newSub, text: e.target.value})} placeholder="æ–°å¢é …ç›®" className="flex-1 bg-slate-50 border-b border-subtle px-2 text-sm" /><button onClick={() => { if(newSub.text){ setFormData(p => ({...p, subItems: [...(p.subItems||[]), {id: generateId(), ...newSub, checked: false}]})); setNewSub(p => ({...p, text: ''})); }}} className="text-matcha font-bold">+</button></div>{formData.subItems?.map(i => <div key={i.id} className="flex justify-between text-sm bg-slate-50 p-2 rounded mb-1"><span>{i.type==='buy'?'ğŸ›ï¸':i.type==='eat'?'ğŸ´':'âœ¨'} {i.text}</span><button onClick={() => setFormData(p => ({...p, subItems: p.subItems.filter(x => x.id !== i.id)}))} className="text-red-400">x</button></div>)}</div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">æè¿°</label><textarea value={formData.desc || ''} onChange={e => setFormData({...formData, desc: e.target.value})} rows={3} placeholder="å¯«é»ä»€éº¼..." className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none" /></div>
                        </div>
                        <div className="mt-8 flex gap-4">{initialData && onDelete && <button type="button" onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle">åˆªé™¤</button>}<button type="button" onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl shadow-lg">å„²å­˜</button></div>
                    </div>
                </div>
            );
        };

        const TransportModal = ({ isOpen, initialData, onClose, onSave }) => {
            const [formData, setFormData] = useState({ mode: 'train', duration: '10m', note: '', url: '' });
            useEffect(() => { if (isOpen) setFormData(initialData || { mode: 'train', duration: '15m', note: '', url: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[75]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-6 pb-safe shadow-2xl animate-slide-up">
                        <h3 className="text-lg font-bold text-charcoal mb-6">äº¤é€šæ–¹å¼</h3>
                        <div className="space-y-4">
                            <div className="flex gap-4"><div className="flex-1"><label className="text-xs font-bold text-slate-400 block mb-1">æ–¹å¼</label><select value={formData.mode} onChange={e => setFormData({...formData, mode: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none"><option value="train">é›»è»Š/åœ°éµ</option><option value="walk">æ­¥è¡Œ</option><option value="taxi">è¨ˆç¨‹è»Š</option><option value="bus">å·´å£«</option><option value="other">å…¶ä»–</option></select></div><div className="flex-1"><label className="text-xs font-bold text-slate-400 block mb-1">é ä¼°æ™‚é–“</label><input type="text" value={formData.duration} onChange={e => setFormData({...formData, duration: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" placeholder="ex: 15m" /></div></div>
                            <div><label className="text-xs font-bold text-slate-400 block mb-1">èªªæ˜</label><input type="text" value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" placeholder="ex: å±±æ‰‹ç·š (å¤–å›)" /></div>
                            <div><label className="text-xs font-bold text-slate-400 block mb-1">é€£çµ</label><input type="text" value={formData.url || ''} onChange={e => setFormData({...formData, url: e.target.value})} className="w-full bg-white p-3 rounded-xl border border-subtle outline-none" placeholder="https://maps..." /></div>
                            <div className="flex gap-3 pt-2">{formData.url && <a href={formData.url} target="_blank" className="flex-1 border border-subtle text-slate-500 py-3 rounded-xl font-bold text-center">é–‹å•Ÿåœ°åœ–</a>}<button onClick={() => onSave(undefined)} className="flex-1 text-red-400 border border-red-100 py-3 rounded-xl font-bold">æ¸…é™¤</button><button onClick={() => onSave(formData)} className="flex-[2] bg-matcha text-white py-3 rounded-xl font-bold shadow-lg">å„²å­˜</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const MealModal = ({ isOpen, initialData, type, onClose, onSave, onDelete }) => {
            const [formData, setFormData] = useState({ name: '', dish: '', priceLevel: '', note: '', url: '', locationUrl: '' });
            useEffect(() => { if(isOpen) setFormData(initialData || { name: '', dish: '', priceLevel: '', note: '', url: '', locationUrl: '' }); }, [isOpen, initialData]);
            if (!isOpen) return null;
            const typeLabel = type === 'breakfast' ? 'æ—©é¤' : type === 'lunch' ? 'åˆé¤' : 'æ™šé¤';
            return (
                <div className="fixed inset-0 z-[80]">
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-[2px]" onClick={onClose}></div>
                    <div className="fixed inset-x-0 bottom-0 z-10 bg-rice rounded-t-[24px] p-8 pb-safe shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                        <div className="w-10 h-1 bg-slate-200/70 rounded-full mx-auto mb-8"></div>
                        <h3 className="text-xl font-bold text-charcoal mb-6 tracking-wide">{initialData ? 'ç·¨è¼¯' : 'æ–°å¢'} {typeLabel}</h3>
                        <div className="space-y-6">
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">é¤å»³åç¨±</label><input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-lg font-medium focus:border-matcha outline-none" /></div>
                            <div className="flex gap-4"><div className="flex-[2]"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">æ¨è–¦é¤é»</label><input type="text" value={formData.dish} onChange={(e) => setFormData({...formData, dish: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div><div className="flex-1"><label className="text-xs uppercase font-bold text-slate-400 block mb-2">åƒ¹ä½</label><input type="text" value={formData.priceLevel} onChange={(e) => setFormData({...formData, priceLevel: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base font-mono focus:border-matcha outline-none" /></div></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">é€£çµ</label><input type="text" value={formData.url || ''} onChange={(e) => setFormData({...formData, url: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base focus:border-matcha outline-none" /></div>
                            <div><label className="text-xs uppercase font-bold text-slate-400 block mb-2">ç­†è¨˜</label><textarea value={formData.note || ''} onChange={(e) => setFormData({...formData, note: e.target.value})} className="w-full bg-transparent border-b border-subtle py-2 text-base resize-none focus:border-matcha outline-none" /></div>
                        </div>
                        <div className="mt-8 flex gap-4">{initialData && onDelete && <button onClick={onDelete} className="flex-1 text-red-400 font-bold py-3.5 rounded-2xl border border-subtle">åˆªé™¤</button>}<button onClick={() => onSave({id: initialData?.id || generateId(), ...formData})} className="flex-[2] bg-matcha text-white font-bold py-3.5 rounded-2xl shadow-lg">å„²å­˜</button></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('itinerary');
            const [data, setData] = useState(DEFAULT_DATA);
            const [currentDayIdx, setCurrentDayIdx] = useState(0);
            const [currency, setCurrency] = useState('JPY');
            const [liveWeather, setLiveWeather] = useState(null);
            
            const [detailEvent, setDetailEvent] = useState(null);
            const [editingEvent, setEditingEvent] = useState(null);
            const [editingTransport, setEditingTransport] = useState(null);
            const [editingMeal, setEditingMeal] = useState(null);
            const [editingReservation, setEditingReservation] = useState(null);
            const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);

            useEffect(() => {
                const initFirebaseListener = () => {
                    if (!window.db) return;
                    const dataRef = window.dbRef(window.db, 'tripData');
                    const unsubscribe = window.dbOnValue(dataRef, (snapshot) => {
                        const val = snapshot.val();
                        if (val && val.days && val.days.length > 0 && val.version === DATA_VERSION) {
                            const safeData = { ...DEFAULT_DATA, ...val };
                            if(safeData.days) {
                                safeData.days.forEach(d => {
                                    if (!d.mealOptions) d.mealOptions = { breakfast: [], lunch: [], dinner: [] };
                                    if (!d.mealOptions.breakfast) d.mealOptions.breakfast = [];
                                    if (!d.mealOptions.lunch) d.mealOptions.lunch = [];
                                    if (!d.mealOptions.dinner) d.mealOptions.dinner = [];
                                    if (!d.events) d.events = [];
                                    d.events.forEach(e => { if (!e.subItems) e.subItems = []; });
                                });
                            }
                            if(!safeData.expenses) safeData.expenses = [];
                            if(!safeData.reservations) safeData.reservations = [];
                            if(!safeData.packingList) safeData.packingList = [];
                            setData(safeData);
                        } else {
                            window.dbSet(dataRef, DEFAULT_DATA);
                            setData(DEFAULT_DATA);
                        }
                    });
                    return unsubscribe;
                };

                if (window.firebaseInitialized) {
                    initFirebaseListener();
                } else {
                    window.addEventListener('firebase-ready', initFirebaseListener);
                }
                return () => window.removeEventListener('firebase-ready', initFirebaseListener);
            }, []);

            const syncData = (newData) => {
                setData(newData);
                if (window.db) { window.dbSet(window.dbRef(window.db, 'tripData'), newData); }
            };

            const handleSaveEvent = (eData) => {
                const newData = {...data};
                if(editingEvent.eventId) {
                    const list = newData.days[editingEvent.dayIdx].events;
                    const idx = list.findIndex(e => e.id === editingEvent.eventId);
                    if(idx >= 0) list[idx] = {...list[idx], ...eData};
                } else {
                    newData.days[editingEvent.dayIdx].events.push({id: generateId(), ...eData});
                    newData.days[editingEvent.dayIdx].events.sort((a,b)=>a.time.localeCompare(b.time));
                }
                syncData(newData); setEditingEvent(null);
            };
            const handleDeleteEvent = () => {
                 const newData = {...data};
                 newData.days[editingEvent.dayIdx].events = newData.days[editingEvent.dayIdx].events.filter(e => e.id !== editingEvent.eventId);
                 syncData(newData); setEditingEvent(null);
            };
            const handleSaveExpense = (exData) => {
                const newData = {...data};
                newData.expenses.push({ id: generateId(), ...exData, date: new Date().toISOString() });
                syncData(newData); setIsExpenseModalOpen(false);
            };

            const getWeatherIcon = (code) => {
                if (code === 0) return 'fa-sun';
                if (code >= 1 && code <= 3) return 'fa-cloud-sun';
                if (code >= 45 && code <= 48) return 'fa-smog';
                if (code >= 51 && code <= 67) return 'fa-cloud-rain';
                if (code >= 71 && code <= 77) return 'fa-snowflake';
                if (code >= 95) return 'fa-bolt';
                return 'fa-cloud';
            };

            return (
                <div className="min-h-screen bg-rice font-sans text-charcoal">
                    <header className="fixed top-0 w-full z-40 bg-rice/95 backdrop-blur-md transition-all duration-300 pt-safe border-b border-subtle">
                        <div className="flex justify-between items-end px-6 py-4 pb-3">
                            <div><p className="text-xs text-slate-400 font-medium tracking-widest uppercase mb-1">Tokyo Trip</p><h1 className="text-2xl font-bold tracking-wide text-charcoal">æ±äº¬ä¸ƒæ—¥</h1></div>
                            <div className="flex items-center gap-3">{liveWeather ? (<div className="text-sm font-medium text-slate-500 flex items-center bg-slate-100 px-3 py-1 rounded-full"><i className={`fa-solid ${getWeatherIcon(liveWeather.code)} text-slate-400 mr-2`}></i><span>{data.days[currentDayIdx].locationKey === 'tokyo' ? 'æ±äº¬' : LOCATIONS[data.days[currentDayIdx].locationKey].name} {liveWeather.temp}Â°C</span></div>) : (<div className="text-sm font-medium text-slate-300"><i className="fa-solid fa-spinner fa-spin"></i></div>)}<button onClick={() => setCurrency(c => c === 'JPY' ? 'TWD' : 'JPY')} className="text-xs border border-subtle text-slate-500 px-3 py-1.5 rounded-full font-bold active:bg-slate-100 transition-colors tracking-wider">{currency}</button></div>
                        </div>
                    </header>
                    <main className="pt-24 max-w-lg mx-auto">
                        {view === 'itinerary' && <ItineraryView days={data.days} currentDayIdx={currentDayIdx} onDaySelect={setCurrentDayIdx} onEventClick={(d,e) => setDetailEvent({dayIdx:d, event:e})} onTransportClick={(d,id) => setEditingTransport({dayIdx:d, eventId:id})} onAddEvent={(d) => setEditingEvent({dayIdx:d})} onAddMeal={(d,t) => setEditingMeal({dayIdx:d, type:t})} onEditMeal={(d,t,o) => setEditingMeal({dayIdx:d, type:t, option:o})} />}
                        {view === 'info' && <InfoView reservations={data.reservations} onEdit={(r) => setEditingReservation({id:r.id, initial:r})} onAdd={() => setEditingReservation({})} />}
                        {view === 'money' && (<><MoneyView expenses={data.expenses} members={MEMBERS.map(m=>m.id)} currencyRate={data.currencyRate} currentCurrency="JPY" onDelete={(id) => syncData({...data, expenses: data.expenses.filter(e => e.id !== id)})} /><ExpenseModal isOpen={isExpenseModalOpen} onClose={() => setIsExpenseModalOpen(false)} members={MEMBERS} onSave={handleSaveExpense} /></>)}
                        {view === 'packing' && <PackingListView items={data.packingList} onToggle={(id) => {const n={...data}; n.packingList.find(i=>i.id===id).checked = !n.packingList.find(i=>i.id===id).checked; syncData(n)}} onAdd={(t,c) => {const n={...data}; n.packingList.push({id:generateId(), text:t, category:c, checked:false}); syncData(n)}} onDelete={(id) => {const n={...data}; n.packingList = n.packingList.filter(i=>i.id!==id); syncData(n)}} />}
                    </main>
                    <nav className="fixed bottom-0 w-full bg-rice/95 backdrop-blur-md border-t border-subtle pb-safe z-30 max-w-lg mx-auto left-0 right-0">
                        <div className="flex justify-around items-center h-[60px]">
                            <button onClick={() => setView('itinerary')} className={`flex-1 flex flex-col items-center justify-center h-full ${view==='itinerary'?'text-matcha':'text-slate-400'}`}><i className="fa-solid fa-map text-xl"></i><span className="text-[9px] font-bold">è¡Œç¨‹</span></button>
                            <button onClick={() => setView('packing')} className={`flex-1 flex flex-col items-center justify-center h-full ${view==='packing'?'text-matcha':'text-slate-400'}`}><i className="fa-solid fa-suitcase text-xl"></i><span className="text-[9px] font-bold">è¡Œæ</span></button>
                            <button onClick={() => setView('info')} className={`flex-1 flex flex-col items-center justify-center h-full ${view==='info'?'text-matcha':'text-slate-400'}`}><i className="fa-solid fa-book text-xl"></i><span className="text-[9px] font-bold">è³‡è¨Š</span></button>
                            <button onClick={() => setView('money')} className={`flex-1 flex flex-col items-center justify-center h-full ${view==='money'?'text-matcha':'text-slate-400'}`}><i className="fa-solid fa-coins text-xl"></i><span className="text-[9px] font-bold">åˆ†å¸³</span></button>
                        </div>
                    </nav>
                    {view === 'itinerary' && <button onClick={() => setEditingEvent({dayIdx: currentDayIdx})} className="fixed bottom-24 right-6 w-14 h-14 rounded-2xl bg-matcha shadow-xl shadow-matcha/40 flex items-center justify-center text-white z-40 active:scale-90 transition-transform"><i className="fa-solid fa-plus text-xl"></i></button>}
                    {view === 'money' && <button onClick={() => setIsExpenseModalOpen(true)} className="fixed bottom-24 right-6 w-14 h-14 rounded-2xl bg-matcha shadow-xl shadow-matcha/40 flex items-center justify-center text-white z-40 active:scale-90 transition-transform"><i className="fa-solid fa-plus text-xl"></i></button>}
                    
                    <EventModal isOpen={!!editingEvent} initialData={editingEvent?.eventId ? data.days[editingEvent.dayIdx].events.find(e => e.id === editingEvent.eventId) : undefined} onClose={() => setEditingEvent(null)} onSave={handleSaveEvent} onDelete={editingEvent?.eventId ? handleDeleteEvent : undefined} />
                    <DetailModal event={detailEvent ? detailEvent.event : null} onClose={() => setDetailEvent(null)} onEdit={() => { setEditingEvent({dayIdx: detailEvent.dayIdx, eventId: detailEvent.event.id}); setDetailEvent(null); }} />
                    <TransportModal isOpen={!!editingTransport} initialData={editingTransport ? data.days[editingTransport.dayIdx].events.find(e => e.id === editingTransport.eventId)?.transitToNext : undefined} onClose={() => setEditingTransport(null)} onSave={(td) => { const n={...data}; n.days[editingTransport.dayIdx].events.find(e => e.id === editingTransport.eventId).transitToNext = td; syncData(n); setEditingTransport(null); }} />
                    <MealModal isOpen={!!editingMeal} type={editingMeal?.type} initialData={editingMeal?.option} onClose={() => setEditingMeal(null)} onSave={(o) => { const n={...data}; const list = n.days[editingMeal.dayIdx].mealOptions[editingMeal.type]; if(editingMeal.option) { list[list.findIndex(x=>x.id===o.id)] = o; } else { list.push(o); } syncData(n); setEditingMeal(null); }} onDelete={() => { const n={...data}; n.days[editingMeal.dayIdx].mealOptions[editingMeal.type] = n.days[editingMeal.dayIdx].mealOptions[editingMeal.type].filter(x=>x.id!==editingMeal.option.id); syncData(n); setEditingMeal(null); }} />
                    <ReservationModal isOpen={!!editingReservation} initialData={editingReservation?.initial} onClose={() => setEditingReservation(null)} onSave={(r) => { const n={...data}; if(editingReservation.id) { const idx = n.reservations.findIndex(x=>x.id===editingReservation.id); n.reservations[idx] = {...n.reservations[idx], ...r}; } else { n.reservations.push({id: generateId(), ...r}); } syncData(n); setEditingReservation(null); }} onDelete={() => { const n={...data}; n.reservations = n.reservations.filter(x=>x.id!==editingReservation.id); syncData(n); setEditingReservation(null); }} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>